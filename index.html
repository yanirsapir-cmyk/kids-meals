<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>××¨×•×—×•×ª ×”×™×œ×“×™×</title>

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#2563eb">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --border:#e5e7eb;
      --primary:#2563eb; --danger:#dc2626; --muted:#6b7280;
      --shadow:0 6px 18px rgba(0,0,0,0.06);
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:14px;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:#111827; line-height:1.35;
    }
    h1{margin:6px 0 14px;font-size:24px;font-weight:900}
    h2{margin:0 0 10px;font-size:18px}
    h3{margin:14px 0 6px;font-size:14px;color:var(--muted)}
    .card{
      background:var(--card); border:1px solid var(--border);
      border-radius:var(--radius); box-shadow:var(--shadow);
      padding:14px; margin-bottom:14px;
    }

    .field{margin-top:10px}
    input,select,textarea{
      width:100%; padding:10px 12px; font-size:16px;
      border-radius:10px; border:1px solid var(--border);
      background:#fff;
    }
    textarea{min-height:150px; resize:vertical}

    .inline{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .inline input{flex:1; min-width:180px}

    .btn{
      padding:10px 14px; border-radius:10px; border:none;
      font-weight:800; cursor:pointer; white-space:nowrap;
    }
    .primary{background:var(--primary); color:#fff}
    .danger{background:var(--danger); color:#fff}
    .ghost{background:#eef2ff; color:#1e40af}

    .iconbtn{
      background:#f3f4f6; color:#111827;
      padding:8px 10px; border-radius:10px; border:1px solid var(--border);
      font-weight:800; line-height:1;
    }
    .iconbtn.dangerish{
      background:#f3f4f6; color:#111827; border:1px solid var(--border);
    }

    ul{list-style:none;padding:0;margin:10px 0 0}
    li{
      display:flex; justify-content:space-between; gap:10px;
      background:#fff; border:1px solid var(--border);
      border-radius:12px; padding:10px; margin-bottom:8px;
      align-items:center;
    }
    li span{flex:1}
    .btn-group{display:flex; gap:8px; align-items:center}

    /* Tabs */
    .tabs{display:flex; gap:8px; margin-bottom:14px; flex-wrap:wrap;}
    .tabbtn{
      border:1px solid var(--border); background:#fff;
      border-radius:999px; padding:9px 12px; font-weight:900; cursor:pointer;
    }
    .tabbtn.active{background:var(--primary); color:#fff; border-color:var(--primary);}
    .view{display:none}
    .view.active{display:block}

    /* ×™×œ×“×™×: ×›×¤×ª×•×¨ ×—×™×¦×•× ×™ */
    .listrow{display:flex;gap:10px;align-items:stretch;margin-bottom:8px;}
    .box{
      flex:1;background:#fff;border:1px solid var(--border);
      border-radius:12px;padding:10px;display:flex;align-items:center;min-height:44px;
    }
    .btncol{flex:0 0 auto;display:flex;align-items:stretch;}
    .btncol .btn{height:100%}

    /* ×¦'×§×‘×•×§×¡×™× */
    .checks{display:flex; flex-direction:column; gap:10px; margin-top:8px;}
    .checkrow{
      display:flex; align-items:center; gap:10px;
      padding:10px; border:1px solid var(--border);
      border-radius:12px; background:#fff;
    }
    .checkrow input{width:18px; height:18px; margin:0}
    .note{font-size:13px;color:var(--muted);margin-top:6px}

    /* ===== Filters ===== */
    .filters{
      display:flex;
      gap:8px;
      flex-wrap:nowrap;
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom:4px;
      margin:8px 0 10px;
    }
    .filter{
      display:flex;
      align-items:center;
      gap:6px;
      font-weight:900;
      font-size:12px;
      background:#fff;
      border:1px solid var(--border);
      padding:6px 8px;
      border-radius:999px;
      white-space:nowrap;
      flex:0 0 auto;
    }
    .filter input{width:16px;height:16px;margin:0}

    /* ===== Grouped-by-date cards ===== */
    .daycard{
      border:1px solid var(--border);
      background:#fff;
      border-radius:16px;
      padding:10px;
      margin-bottom:10px;
      overflow:hidden;
    }
    .dayheader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:6px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:13px;
      border:1px solid var(--border);
      white-space:nowrap;
    }
    .datepill{background:#f3f4f6}
    .typepill{border:none; min-width:78px; justify-content:center;}
    .type-boker{background:#fff7ed}
    .type-tzohor{background:#ecfeff}
    .type-erev{background:#eef2ff}
    .type-bein{background:#fdf2f8}

    /* ===== Entry row (×§×•××¤×§×˜×™ ×™×•×ª×¨) ===== */
    .entry{
      border:1px solid var(--border);
      border-radius:14px;
      padding:8px;               /* ×”×™×” 10 */
      margin-bottom:8px;
      background:#fff;
    }
    .entry-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:6px;         /* ×”×™×” 8 */
    }
    .entry-bottom{
      font-size:13px;
      font-weight:900;
    }

    .delbtn{
      min-width:62px;            /* ×§×¦×ª ×¦×¨ ×™×•×ª×¨ */
      border:1px solid var(--border);
      background:#fff;
      border-radius:12px;
      padding:6px 10px;          /* × ××•×š ×™×•×ª×¨ */
      cursor:pointer;
      font-weight:900;
      white-space:nowrap;
    }

    /* ××¦×‘ ×¨×’×™×œ: ×× ×” ××™××™×Ÿ, ×™×œ×“×™× ××©×××œ */
    .bottom-normal{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .mealtext{
      flex:1;
      min-width:0;
      text-align:right;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .kidstext{
      flex:1;
      min-width:0;
      text-align:left;
      font-weight:800;
      color:#374151;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    /* ××¦×‘ ××¤×•×¦×œ: ×›×œ ×™×œ×“ ×‘×©×•×¨×” */
    .splitlist{
      display:flex;
      flex-direction:column;
      gap:4px;                   /* ×§×•××¤×§×˜×™ */
    }
    .splitline{
      display:flex;
      justify-content:space-between;
      gap:10px;
      border:1px dashed var(--border);
      border-radius:10px;
      padding:6px 8px;           /* × ××•×š */
      background:#fafafa;
      font-size:13px;
    }
    .splitkid{
      font-weight:900;
      white-space:nowrap;
      flex:0 0 auto;
    }
    .splitmeal{
      font-weight:800;
      color:#374151;
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      text-align:left;
      flex:1;
    }

    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,0.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      z-index:9999;
    }
    .modal{
      width:100%;
      max-width:720px;
      background:#fff;
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:0 16px 50px rgba(0,0,0,0.2);
      padding:14px;
    }
    .modal-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .modal-title{font-weight:900;font-size:18px}
    .modal-actions{display:flex;gap:10px;flex-wrap:wrap}
    .tiny{
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#f3f4f6;
      font-weight:800;
      cursor:pointer;
      white-space:nowrap;
    }
    .warn{color:var(--danger); font-size:13px; margin-top:8px; display:none;}

    @media(min-width:700px){
      body{max-width:820px;margin:auto}
    }
  </style>
</head>

<body>
<h1>ğŸ½ï¸ ××¨×•×—×•×ª ×”×™×œ×“×™×</h1>

<div class="tabs">
  <button class="tabbtn active" type="button" onclick="showTab('log')">×¨×™×©×•×</button>
  <button class="tabbtn" type="button" onclick="showTab('kids')">× ×™×”×•×œ ×™×œ×“×™×</button>
  <button class="tabbtn" type="button" onclick="showTab('dishes')">× ×™×”×•×œ ×× ×•×ª</button>
  <button class="tabbtn" type="button" onclick="showTab('data')">× ×ª×•× ×™×</button>
</div>

<section id="view-log" class="view active">
  <section class="card">
    <h2>×¨×™×©×•× ××¨×•×—×”</h2>

    <div class="field">
      <label>×ª××¨×™×š</label>
      <input type="date" id="dateInput">
    </div>

    <div class="field">
      <label>×¡×•×’ ××¨×•×—×”</label>
      <select id="mealType">
        <option value="×‘×•×§×¨">×‘×•×§×¨</option>
        <option value="×¦×”×¨×™×™×">×¦×”×¨×™×™×</option>
        <option value="×¢×¨×‘" selected>×¢×¨×‘</option>
        <option value="×‘×™× ×™×™×">×‘×™× ×™×™×</option>
      </select>
    </div>

    <div class="field checkrow" style="justify-content:space-between;">
      <div style="display:flex;align-items:center;gap:10px;">
        <input type="checkbox" id="sameForAll" checked onchange="toggleMode()">
        <strong>××•×ª×” ××¨×•×—×” ×œ×›×•×œ×</strong>
      </div>
    </div>

    <div id="sameMode">
      <div class="field">
        <label>×× ×”</label>
        <div class="inline">
          <select id="mealSelect"></select>
          <button class="btn ghost" type="button" onclick="suggestMeal()">×ª×Ÿ ×œ×™ ×¨×¢×™×•×Ÿ</button>
        </div>
      </div>

      <h3>××™ ××›×œ?</h3>
      <div id="sameKids" class="checks"></div>
    </div>

    <div id="splitMode" style="display:none;">
      <h3>×‘×—×™×¨×” × ×¤×¨×“×ª ×œ×›×œ ×™×œ×“</h3>
      <div id="splitKids" class="checks"></div>
    </div>

    <div class="field">
      <button class="btn primary" type="button" onclick="saveMeal()">×©××™×¨×”</button>
    </div>
  </section>
</section>

<section id="view-kids" class="view">
  <section class="card">
    <h2>× ×™×”×•×œ ×™×œ×“×™×</h2>
    <div class="inline">
      <input id="newKidInput" placeholder="×©× ×™×œ×“/×”">
      <button class="btn primary" type="button" onclick="addKid()">×”×•×¡×£</button>
    </div>
    <ul id="kidsList"></ul>
  </section>
</section>

<section id="view-dishes" class="view">
  <section class="card">
    <h2>× ×™×”×•×œ ×× ×•×ª</h2>
    <div class="inline">
      <input id="newMealInput" placeholder="×©× ×× ×”">
      <button class="btn primary" type="button" onclick="addMeal()">×”×•×¡×£</button>
    </div>
    <div class="note">××—×™×§×” ×›××Ÿ ××¡×™×¨×” ××”×××’×¨ ×‘×œ×‘×“ (×œ× ××•×—×§×ª ×”×™×¡×˜×•×¨×™×”).</div>
    <ul id="mealsOptionsList"></ul>
  </section>
</section>

<section id="view-data" class="view">
  <section class="card">
    <h2>×”×™×¡×˜×•×¨×™×”</h2>

    <div class="note">×¡×™× ×•×Ÿ ×™×œ×“×™× (××•×¤×¦×™×•× ×œ×™). ×× ×œ× ××¡×× ×™× ×›×œ×•× â€” ××•×¦×’ ×”×›×•×œ.</div>
    <div id="kidFilters" class="filters"></div>

    <div class="filters" id="typeFilters">
      <label class="filter"><input type="checkbox" value="×‘×•×§×¨" checked onchange="renderHistoryAndWeek()"> ×‘×•×§×¨</label>
      <label class="filter"><input type="checkbox" value="×¦×”×¨×™×™×" checked onchange="renderHistoryAndWeek()"> ×¦×”×¨×™×™×</label>
      <label class="filter"><input type="checkbox" value="×¢×¨×‘" checked onchange="renderHistoryAndWeek()"> ×¢×¨×‘</label>
      <label class="filter"><input type="checkbox" value="×‘×™× ×™×™×" checked onchange="renderHistoryAndWeek()"> ×‘×™× ×™×™×</label>
    </div>

    <div id="historyWrap"></div>
  </section>

  <section class="card">
    <h2>×©×‘×•×¢ ××—×¨×•×Ÿ</h2>
    <input type="date" id="weekEndDate">
    <div id="weekWrap"></div>

    <h3>×’×™×•×•×Ÿ</h3>
    <ul id="varietyList"></ul>
  </section>

  <section class="card">
    <h2>×›×œ×™ ×‘×“×™×§×” ××”×™×¨</h2>
    <div class="note">××•×—×§ ×¨×§ ××ª ×”×”×™×¡×˜×•×¨×™×” (×¨×™×©×•××™ ××¨×•×—×•×ª). ×œ× ××•×—×§ ×™×œ×“×™×/×× ×•×ª/××ª×›×•× ×™×.</div>
    <button class="btn danger" type="button" onclick="clearHistoryOnly()">××—×§ ×”×™×¡×˜×•×¨×™×”</button>
  </section>

  <section class="card">
    <h2>××™×¤×•×¡</h2>
    <div class="note">×–×” ××•×—×§ ×”×›×œ ××”××›×©×™×¨ (×™×œ×“×™×/×× ×•×ª/×”×™×¡×˜×•×¨×™×”/××ª×›×•× ×™×).</div>
    <button class="btn danger" type="button" onclick="resetData()">××™×¤×•×¡ × ×ª×•× ×™×</button>
  </section>
</section>

<div id="recipeBackdrop" class="modal-backdrop" onclick="closeRecipeModal(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title" id="recipeTitle">××ª×›×•×Ÿ</div>
      <div class="modal-actions">
        <button class="tiny" type="button" onclick="saveRecipe()">×©××™×¨×”</button>
        <button class="tiny" type="button" onclick="hideRecipeModal()">×¡×’×•×¨</button>
      </div>
    </div>

    <div class="field">
      <label>×§×™×©×•×¨ (××•×¤×¦×™×•× ×œ×™)</label>
      <div class="inline">
        <input id="recipeUrlInput" placeholder="https://...">
        <button class="tiny" type="button" onclick="pasteUrl()">×”×“×‘×§ ×§×™×©×•×¨</button>
        <button class="tiny" type="button" onclick="openRecipeLink()">×¤×ª×— ×§×™×©×•×¨</button>
      </div>
    </div>

    <div class="field">
      <label>××ª×›×•×Ÿ</label>
      <div class="inline">
        <button class="tiny" type="button" onclick="pasteRecipe()">×”×“×‘×§ ××ª×›×•×Ÿ</button>
      </div>
      <textarea id="recipeTextInput" placeholder="×”×“×‘×§/×›×ª×•×‘ ×›××Ÿ ××ª ×”××ª×›×•×Ÿ..."></textarea>
      <div id="pasteWarn" class="warn">×œ× × ×™×ª×Ÿ ×œ×”×“×‘×™×§ ××•×˜×•××˜×™×ª ×›××Ÿ. ×”×“×‘×§ ×™×“× ×™×ª ×œ×ª×•×š ×”×ª×™×‘×” (×œ×—×™×¦×” ××¨×•×›×” â†’ Paste).</div>
    </div>
  </div>
</div>

<script>
  function showTab(key){
    document.querySelectorAll(".tabbtn").forEach(b => b.classList.remove("active"));
    document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
    const map = { log:[0,"view-log"], kids:[1,"view-kids"], dishes:[2,"view-dishes"], data:[3,"view-data"] };
    const m = map[key] || map.log;
    document.querySelectorAll(".tabbtn")[m[0]].classList.add("active");
    document.getElementById(m[1]).classList.add("active");
  }

  const KM="meals", KK="kids", KO="mealOptions";
  let meals = JSON.parse(localStorage.getItem(KM)) || [];
  let kids = JSON.parse(localStorage.getItem(KK)) || ["××™×§×”","×¢×•××¨"];
  let mealOptionsRaw = JSON.parse(localStorage.getItem(KO));
  let mealOptions = normalizeMealOptions(mealOptionsRaw);

  function normalizeMealOptions(raw){
    if(!raw) return [];
    if(Array.isArray(raw) && raw.length && typeof raw[0] === "string"){
      return raw.map(d => ({ dish: d, recipeText: "", recipeUrl: "" }));
    }
    if(Array.isArray(raw) && (raw.length === 0 || typeof raw[0] === "object")){
      return raw.map(o => ({
        dish: String(o?.dish ?? "").trim(),
        recipeText: String(o?.recipeText ?? ""),
        recipeUrl: String(o?.recipeUrl ?? "")
      })).filter(o => o.dish);
    }
    return [];
  }

  const save = () => {
    localStorage.setItem(KM, JSON.stringify(meals));
    localStorage.setItem(KK, JSON.stringify(kids));
    localStorage.setItem(KO, JSON.stringify(mealOptions));
  };

  const uid = () => "m_" + Math.random().toString(16).slice(2) + "_" + Date.now();
  function getDishNames(){ return mealOptions.map(o => o.dish); }
  function findOptionByDish(dish){ return mealOptions.find(o => o.dish === dish) || null; }

  const iso = (d) => new Date(d + "T00:00:00");
  const addDays = (d, n) => {
    const x = iso(d);
    x.setDate(x.getDate() + n);
    return x.toISOString().slice(0,10);
  };

  function resetData(){
    if(!confirm("××™×¤×•×¡ ××•×—×œ×˜?")) return;
    localStorage.clear();
    location.reload();
  }

  function clearHistoryOnly(){
    if(!confirm("×œ××—×•×§ ××ª ×›×œ ×”×”×™×¡×˜×•×¨×™×”? (×™×œ×“×™×/×× ×•×ª/××ª×›×•× ×™× ×œ× ×™×™××—×§×•)")) return;
    meals = [];
    save();
    renderHistoryAndWeek();
  }

  function getActiveTypes(){
    const checked = Array.from(document.querySelectorAll("#typeFilters input:checked")).map(x=>x.value);
    return checked.length ? checked : ["×‘×•×§×¨","×¦×”×¨×™×™×","×¢×¨×‘","×‘×™× ×™×™×"];
  }
  function getActiveKids(){
    return Array.from(document.querySelectorAll("#kidFilters input:checked")).map(x=>x.value);
  }
  function recordKidsList(m){
    if(m.split) return Object.keys(m.kidMeals||{});
    return (m.kids||[]);
  }
  function recordMatchesKids(m, activeKids){
    if(!activeKids.length) return true;
    const rk = recordKidsList(m);
    return rk.some(k => activeKids.includes(k));
  }

  let kidFilterBuiltFor = "";
  function ensureKidFilters(){
    const signature = kids.join("|");
    if(signature === kidFilterBuiltFor) return;
    const host = document.getElementById("kidFilters");
    host.innerHTML = "";
    kids.forEach(k => {
      const lab = document.createElement("label");
      lab.className = "filter";
      lab.innerHTML = `<input type="checkbox" value="${k}"> ${k}`;
      lab.querySelector("input").addEventListener("change", renderHistoryAndWeek);
      host.appendChild(lab);
    });
    kidFilterBuiltFor = signature; // ×‘×¨×™×¨×ª ××—×“×œ: ×¨×™×§ => ××¦×™×’ ×”×›×œ
  }

  function addKid(){
    const v = (newKidInput.value || "").trim();
    if(!v) return;
    if(kids.includes(v)) return alert("×”×™×œ×“/×” ×›×‘×¨ ×§×™×™×/×ª");
    kids.push(v);
    newKidInput.value = "";
    kidFilterBuiltFor = "";
    save(); renderAll();
  }

  function removeKid(k){
    if(!confirm(`×œ××—×•×§ ××ª "${k}"?`)) return;
    kids = kids.filter(x => x !== k);

    meals = meals.map(m => {
      if(m.split){
        const km = {...(m.kidMeals||{})};
        delete km[k];
        return {...m, kidMeals: km};
      } else {
        return {...m, kids: (m.kids||[]).filter(x => x !== k)};
      }
    }).filter(m => {
      if(m.split) return Object.keys(m.kidMeals||{}).length > 0;
      return (m.kids||[]).length > 0;
    });

    kidFilterBuiltFor = "";
    save(); renderAll();
  }

  function addMeal(){
    const v = (newMealInput.value || "").trim();
    if(!v) return;
    if(getDishNames().includes(v)) return alert("×”×× ×” ×›×‘×¨ ×§×™×™××ª");
    mealOptions.push({ dish: v, recipeText: "", recipeUrl: "" });
    newMealInput.value = "";
    save(); renderAll();
  }

  function editMeal(oldName){
    const next = (prompt("×©× ×—×“×©:", oldName) || "").trim();
    if(!next) return;
    if(next === oldName) return;
    if(getDishNames().includes(next)) return alert("×›×‘×¨ ×§×™×™××ª ×× ×” ×‘×©× ×”×–×”");

    mealOptions = mealOptions.map(o => o.dish === oldName ? ({...o, dish: next}) : o);

    meals = meals.map(m => {
      if(m.split){
        const km = {...(m.kidMeals||{})};
        Object.keys(km).forEach(k => { if(km[k] === oldName) km[k] = next; });
        return {...m, kidMeals: km};
      } else {
        return (m.meal === oldName) ? {...m, meal: next} : m;
      }
    });

    save(); renderAll();
  }

  function deleteMealOption(name){
    if(!confirm(`×œ××—×•×§ ××ª "${name}" ××”×××’×¨ ×‘×œ×‘×“?`)) return;
    mealOptions = mealOptions.filter(o => o.dish !== name);
    save(); renderAll();
  }

  function toggleMode(){
    const same = sameForAll.checked;
    sameMode.style.display = same ? "block" : "none";
    splitMode.style.display = same ? "none" : "block";
  }

  function saveMeal(){
    const date = dateInput.value;
    const type = mealType.value;
    if(!date) return alert("×‘×—×¨ ×ª××¨×™×š");
    if(!mealOptions.length) return alert("×”×××’×¨ ×¨×™×§ â€” ×”×•×¡×£ ×× ×” ×§×•×“×");
    if(!kids.length) return alert("××™×Ÿ ×™×œ×“×™× â€” ×”×•×¡×£ ×™×œ×“/×” ×§×•×“×");

    const createdAt = Date.now();

    if(sameForAll.checked){
      const meal = mealSelect.value;
      const selectedKids = kids.filter(k => document.getElementById("cb_"+k)?.checked);
      if(!meal) return alert("×‘×—×¨ ×× ×”");
      if(!selectedKids.length) return alert("×¡××Ÿ ×œ×¤×—×•×ª ×™×œ×“/×” ××—×“/×ª");
      meals.push({id: uid(), createdAt, date, type, meal, kids: selectedKids});
    } else {
      const kidMeals = {};
      for(const k of kids){
        const sel = document.getElementById("sel_"+k);
        const val = sel ? sel.value : "";
        if(!val) return alert(`×‘×—×¨ ×× ×” ×¢×‘×•×¨ ${k}`);
        kidMeals[k] = val;
      }
      meals.push({id: uid(), createdAt, date, type, split: true, kidMeals});
    }

    save(); renderHistoryAndWeek();
  }

  function deleteReport(id){
    if(!confirm("×œ××—×•×§ ×“×™×•×•×—?")) return;
    meals = meals.filter(m => m.id !== id);
    save(); renderHistoryAndWeek();
  }

  function suggestMeal(){
    if(!mealOptions.length) return;
    const end = weekEndDate.value || dateInput.value;
    const start = addDays(end, -6);
    const week = meals.filter(m => m.date >= start && m.date <= end);

    const counts = new Map();
    week.forEach(m => {
      if(m.split){
        Object.values(m.kidMeals||{}).forEach(v => counts.set(v, (counts.get(v)||0)+1));
      } else {
        counts.set(m.meal, (counts.get(m.meal)||0)+1);
      }
    });

    let min = Infinity;
    getDishNames().forEach(opt => { min = Math.min(min, counts.get(opt)||0); });
    const candidates = getDishNames().filter(opt => (counts.get(opt)||0) === min);
    mealSelect.value = candidates[Math.floor(Math.random()*candidates.length)];
  }

  // Recipe modal
  let recipeDish = null;
  function openRecipeModal(dish){
    recipeDish = dish;
    const opt = findOptionByDish(dish) || {recipeText:"", recipeUrl:""};
    recipeTitle.textContent = `ğŸ“– ××ª×›×•×Ÿ: ${dish}`;
    recipeTextInput.value = opt.recipeText || "";
    recipeUrlInput.value = opt.recipeUrl || "";
    pasteWarn.style.display = "none";
    recipeBackdrop.style.display = "flex";
  }
  function hideRecipeModal(){ recipeBackdrop.style.display = "none"; recipeDish = null; }
  function closeRecipeModal(e){ if(e.target === recipeBackdrop) hideRecipeModal(); }

  async function pasteRecipe(){
    pasteWarn.style.display = "none";
    try{
      if(!navigator.clipboard || !navigator.clipboard.readText){ pasteWarn.style.display="block"; return; }
      const txt = await navigator.clipboard.readText();
      if(txt) recipeTextInput.value = txt;
    }catch(e){ pasteWarn.style.display="block"; }
  }
  async function pasteUrl(){
    pasteWarn.style.display = "none";
    try{
      if(!navigator.clipboard || !navigator.clipboard.readText){ pasteWarn.style.display="block"; return; }
      const txt = await navigator.clipboard.readText();
      if(txt) recipeUrlInput.value = txt.trim();
    }catch(e){ pasteWarn.style.display="block"; }
  }
  function openRecipeLink(){
    const url = (recipeUrlInput.value || "").trim();
    if(!url) return alert("××™×Ÿ ×§×™×©×•×¨ ×œ×¤×ª×™×—×”");
    try{ window.open(new URL(url).toString(), "_blank"); }
    catch(e){ alert("×”×§×™×©×•×¨ ×œ× ×ª×§×™×Ÿ"); }
  }
  function saveRecipe(){
    if(!recipeDish) return;
    const text = recipeTextInput.value || "";
    const url = (recipeUrlInput.value || "").trim();
    mealOptions = mealOptions.map(o => o.dish !== recipeDish ? o : ({...o, recipeText:text, recipeUrl:url}));
    save(); hideRecipeModal(); renderMealOptionsManager();
  }

  // Render helpers
  function typeClass(type){
    if(type === "×‘×•×§×¨") return "type-boker";
    if(type === "×¦×”×¨×™×™×") return "type-tzohor";
    if(type === "×¢×¨×‘") return "type-erev";
    return "type-bein";
  }

  function groupByDate(items){
    const map = new Map();
    items.forEach(m => {
      const d = m.date || "";
      if(!map.has(d)) map.set(d, []);
      map.get(d).push(m);
    });
    const dates = [...map.keys()].sort((a,b)=>b.localeCompare(a));
    return dates.map(d => ({
      date: d,
      items: map.get(d).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0))
    }));
  }

  function createEntry(m){
    const entry = document.createElement("div");
    entry.className = "entry";

    const top = document.createElement("div");
    top.className = "entry-top";

    const typeP = document.createElement("span");
    typeP.className = "pill typepill " + typeClass(m.type);
    typeP.textContent = m.type || "";

    const del = document.createElement("button");
    del.className = "delbtn";
    del.type = "button";
    del.textContent = "××—×§";
    del.onclick = () => deleteReport(m.id);

    top.appendChild(typeP);
    top.appendChild(del);

    const bottom = document.createElement("div");
    bottom.className = "entry-bottom";

    if(m.split){
      // ×›×œ ×™×œ×“ ×‘×©×•×¨×”
      const list = document.createElement("div");
      list.className = "splitlist";
      const km = m.kidMeals || {};
      Object.keys(km).forEach(k => {
        const line = document.createElement("div");
        line.className = "splitline";
        line.innerHTML = `<div class="splitkid">${k}:</div><div class="splitmeal">${km[k]}</div>`;
        list.appendChild(line);
      });
      bottom.appendChild(list);
    } else {
      // ×¨×’×™×œ
      const wrap = document.createElement("div");
      wrap.className = "bottom-normal";

      const meal = document.createElement("div");
      meal.className = "mealtext";
      meal.textContent = m.meal || "";

      const kidsT = document.createElement("div");
      kidsT.className = "kidstext";
      kidsT.textContent = (m.kids||[]).join(", ");

      wrap.appendChild(meal);
      wrap.appendChild(kidsT);
      bottom.appendChild(wrap);
    }

    entry.appendChild(top);
    entry.appendChild(bottom);
    return entry;
  }

  function renderGrouped(container, items){
    container.innerHTML = "";
    const groups = groupByDate(items);
    if(!groups.length){
      const empty = document.createElement("div");
      empty.className = "note";
      empty.textContent = "××™×Ÿ ×¨×™×©×•××™× ×œ×”×¦×’×”.";
      container.appendChild(empty);
      return;
    }
    groups.forEach(g => {
      const day = document.createElement("div");
      day.className = "daycard";

      const head = document.createElement("div");
      head.className = "dayheader";

      const dateP = document.createElement("span");
      dateP.className = "pill datepill";
      dateP.textContent = g.date;

      head.appendChild(dateP);
      day.appendChild(head);

      g.items.forEach(m => day.appendChild(createEntry(m)));
      container.appendChild(day);
    });
  }

  // Render UI
  function renderKids(){
    kidsList.innerHTML = "";
    kids.forEach(k => {
      const row = document.createElement("div");
      row.className = "listrow";
      row.innerHTML = `
        <div class="box">${k}</div>
        <div class="btncol"><button class="btn danger" type="button">××—×§</button></div>
      `;
      row.querySelector("button").onclick = () => removeKid(k);
      kidsList.appendChild(row);
    });
  }

  function renderMealOptionsManager(){
    mealsOptionsList.innerHTML = "";
    const sorted = [...mealOptions].sort((a,b)=>a.dish.localeCompare(b.dish,"he"));
    sorted.forEach(o => {
      const li = document.createElement("li");
      const hasRecipe = (o.recipeText && o.recipeText.trim().length>0) || (o.recipeUrl && o.recipeUrl.trim().length>0);
      li.innerHTML = `
        <span>${o.dish}${hasRecipe ? "  âœ…" : ""}</span>
        <div class="btn-group">
          <button class="iconbtn" type="button" title="××ª×›×•×Ÿ">ğŸ“–</button>
          <button class="iconbtn" type="button" title="×¢×¨×•×š">âœï¸</button>
          <button class="iconbtn dangerish" type="button" title="××—×§">âŒ</button>
        </div>
      `;
      const [recipeBtn, editBtn, delBtn] = li.querySelectorAll("button");
      recipeBtn.onclick = () => openRecipeModal(o.dish);
      editBtn.onclick = () => editMeal(o.dish);
      delBtn.onclick = () => deleteMealOption(o.dish);
      mealsOptionsList.appendChild(li);
    });
  }

  function renderSelectorsAndChecks(){
    mealSelect.innerHTML = "";
    getDishNames().forEach(m => {
      const opt = document.createElement("option");
      opt.value = m; opt.textContent = m;
      mealSelect.appendChild(opt);
    });

    sameKids.innerHTML = "";
    kids.forEach(k => {
      const row = document.createElement("div");
      row.className = "checkrow";
      row.innerHTML = `<input type="checkbox" id="cb_${k}" checked><div style="font-weight:800;">${k}</div>`;
      sameKids.appendChild(row);
    });

    splitKids.innerHTML = "";
    kids.forEach(k => {
      const row = document.createElement("div");
      row.className = "checkrow";
      row.innerHTML = `<div style="font-weight:900; min-width:80px;">${k}</div><select id="sel_${k}"></select>`;
      const sel = row.querySelector("select");
      getDishNames().forEach(m => {
        const opt = document.createElement("option");
        opt.value = m; opt.textContent = m;
        sel.appendChild(opt);
      });
      splitKids.appendChild(row);
    });
  }

  function renderHistoryAndWeek(){
    ensureKidFilters();

    const types = getActiveTypes();
    const activeKids = getActiveKids();

    const filteredAll = meals
      .filter(m => types.includes(m.type))
      .filter(m => recordMatchesKids(m, activeKids))
      .sort((a,b)=> (b.date||"").localeCompare(a.date||"") || (b.createdAt||0)-(a.createdAt||0));

    renderGrouped(historyWrap, filteredAll);

    const end = weekEndDate.value || dateInput.value;
    const start = addDays(end, -6);

    const week = meals
      .filter(m => m.date >= start && m.date <= end)
      .filter(m => types.includes(m.type))
      .filter(m => recordMatchesKids(m, activeKids));

    renderGrouped(weekWrap, week.sort((a,b)=> (b.date||"").localeCompare(a.date||"") || (b.createdAt||0)-(a.createdAt||0)));

    // Variety
    const counts = new Map();
    week.forEach(m => {
      if(m.split){
        Object.values(m.kidMeals||{}).forEach(v => counts.set(v, (counts.get(v)||0)+1));
      } else {
        counts.set(m.meal, (counts.get(m.meal)||0)+1);
      }
    });
    varietyList.innerHTML = "";
    const entries = [...counts.entries()].sort((a,b)=>b[1]-a[1] || a[0].localeCompare(b[0],"he"));
    if(!entries.length){
      const li = document.createElement("li");
      li.innerHTML = `<span>××™×Ÿ × ×ª×•× ×™× ×œ×’×™×•×•×Ÿ ×‘×©×‘×•×¢ ×”×–×”</span>`;
      varietyList.appendChild(li);
    } else {
      entries.forEach(([meal,c]) => {
        const li = document.createElement("li");
        li.innerHTML = `<span>${meal} â€” ${c} ×¤×¢××™×</span>`;
        varietyList.appendChild(li);
      });
    }
  }

  function getActiveTypes(){
    const checked = Array.from(document.querySelectorAll("#typeFilters input:checked")).map(x=>x.value);
    return checked.length ? checked : ["×‘×•×§×¨","×¦×”×¨×™×™×","×¢×¨×‘","×‘×™× ×™×™×"];
  }

  function recordMatchesKids(m, activeKids){
    if(!activeKids.length) return true;
    const rk = recordKidsList(m);
    return rk.some(k => activeKids.includes(k));
  }

  function recordKidsList(m){
    if(m.split) return Object.keys(m.kidMeals||{});
    return (m.kids||[]);
  }

  function getActiveKids(){
    return Array.from(document.querySelectorAll("#kidFilters input:checked")).map(x=>x.value);
  }

  function ensureKidFilters(){
    const signature = kids.join("|");
    if(signature === kidFilterBuiltFor) return;
    const host = document.getElementById("kidFilters");
    host.innerHTML = "";
    kids.forEach(k => {
      const lab = document.createElement("label");
      lab.className = "filter";
      lab.innerHTML = `<input type="checkbox" value="${k}"> ${k}`;
      lab.querySelector("input").addEventListener("change", renderHistoryAndWeek);
      host.appendChild(lab);
    });
    kidFilterBuiltFor = signature;
  }

  function renderAll(){
    renderKids();
    renderMealOptionsManager();
    renderSelectorsAndChecks();
    toggleMode();
    renderHistoryAndWeek();
  }

  const today = new Date().toISOString().slice(0,10);
  dateInput.value = today;
  weekEndDate.value = today;
  weekEndDate.addEventListener("change", renderHistoryAndWeek);

  save();
  renderAll();
</script>
</body>
</html>
