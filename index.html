<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>××¨×•×—×•×ª ×”×™×œ×“×™×</title>

<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#2563eb">

<style>
body{font-family:system-ui;background:#f6f7fb;margin:0;padding:12px}
h1{margin:8px 0 16px}
button{padding:8px 12px;font-weight:700;border-radius:8px;border:1px solid #ccc;background:#fff}
.primary{background:#2563eb;color:#fff;border:none}
.card{background:#fff;border:1px solid #ddd;border-radius:12px;padding:12px;margin-bottom:12px}
.tabs{display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap}
.tabs button.active{background:#2563eb;color:#fff}
.view{display:none}
.view.active{display:block}
input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #ccc;margin-top:4px}
.row{display:flex;gap:8px;align-items:center;margin-top:8px}
.list-item{display:flex;justify-content:space-between;align-items:center;border:1px solid #ddd;border-radius:8px;padding:6px;margin-top:6px}
.small{font-size:13px;color:#555}
</style>
</head>

<body>

<h1>ğŸ½ï¸ ××¨×•×—×•×ª ×”×™×œ×“×™×</h1>

<div class="tabs">
  <button onclick="showTab('log')" class="active">×¨×™×©×•×</button>
  <button onclick="showTab('kids')">×™×œ×“×™×</button>
  <button onclick="showTab('meals')">×× ×•×ª</button>
  <button onclick="showTab('data')">× ×ª×•× ×™×</button>
</div>

<div id="log" class="view active card">
  <h2>×¨×™×©×•× ××¨×•×—×”</h2>
  <label>×ª××¨×™×š</label>
  <input type="date" id="dateInput">

  <label>×¡×•×’ ××¨×•×—×”</label>
  <select id="typeInput">
    <option>×‘×•×§×¨</option>
    <option>×¦×”×¨×™×™×</option>
    <option selected>×¢×¨×‘</option>
    <option>×‘×™× ×™×™×</option>
  </select>

  <label>×× ×”</label>
  <select id="mealInput"></select>

  <label>××™ ××›×œ?</label>
  <div id="kidsChecks"></div>

  <button class="primary" onclick="addLog()">×©××™×¨×”</button>
</div>

<div id="kids" class="view card">
  <h2>× ×™×”×•×œ ×™×œ×“×™×</h2>
  <div class="row">
    <input id="newKid" placeholder="×©×">
    <button class="primary" onclick="addKid()">×”×•×¡×£</button>
  </div>
  <div id="kidsList"></div>
</div>

<div id="meals" class="view card">
  <h2>× ×™×”×•×œ ×× ×•×ª</h2>
  <div class="row">
    <input id="newMeal" placeholder="×©× ×× ×”">
    <button class="primary" onclick="addMeal()">×”×•×¡×£</button>
  </div>
  <div id="mealsList"></div>
</div>

<div id="data" class="view card">
  <h2>×”×™×¡×˜×•×¨×™×”</h2>
  <div id="history"></div>
</div>

<script>
/* ===== SYNC CONFIG ===== */
const SYNC_URL = "https://script.google.com/macros/s/AKfycby8gDkzATtKwGFqFguvvTcqZ0jC1FCADAFWw1PLoOzVAmV1UwuZiIPkC1YNhmD_4pi4/exec";
const SYNC_TOKEN = "CHANGE_ME_12345";
const DEVICE_NAME = "Yanir";

/* ===== STORAGE ===== */
let kids = JSON.parse(localStorage.getItem("kids")) || ["××™×§×”","×¢×•××¨"];
let meals = JSON.parse(localStorage.getItem("meals")) || [];
let logs  = JSON.parse(localStorage.getItem("logs"))  || [];

/* ===== SYNC SAVE (GET) ===== */
let syncTimer=null;
function syncSave(){
  if(syncTimer) clearTimeout(syncTimer);
  syncTimer=setTimeout(()=>{
    const data={
      kids,meals,logs
    };
    const url=
      `${SYNC_URL}?token=${SYNC_TOKEN}`+
      `&write=1`+
      `&by=${DEVICE_NAME}`+
      `&data=${encodeURIComponent(JSON.stringify(data))}`;
    fetch(url);
  },500);
}

/* ===== SYNC LOAD ===== */
async function syncLoad(){
  const res=await fetch(`${SYNC_URL}?token=${SYNC_TOKEN}`);
  const j=await res.json();
  if(j.data){
    const d=JSON.parse(j.data);
    kids=d.kids||kids;
    meals=d.meals||meals;
    logs=d.logs||logs;
    saveLocal(false);
    renderAll();
  }
}

/* ===== UI ===== */
function showTab(id){
  document.querySelectorAll(".view").forEach(v=>v.classList.remove("active"));
  document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  event.target.classList.add("active");
}

function saveLocal(sync=true){
  localStorage.setItem("kids",JSON.stringify(kids));
  localStorage.setItem("meals",JSON.stringify(meals));
  localStorage.setItem("logs",JSON.stringify(logs));
  if(sync) syncSave();
}

function renderAll(){
  renderKids();
  renderMeals();
  renderLogUI();
  renderHistory();
}

function renderKids(){
  kidsList.innerHTML="";
  kids.forEach(k=>{
    const d=document.createElement("div");
    d.className="list-item";
    d.innerHTML=`<span>${k}</span><button onclick="removeKid('${k}')">××—×§</button>`;
    kidsList.appendChild(d);
  });
}

function renderMeals(){
  mealsList.innerHTML="";
  meals.forEach(m=>{
    const d=document.createElement("div");
    d.className="list-item";
    d.innerHTML=`<span>${m}</span><button onclick="removeMeal('${m}')">××—×§</button>`;
    mealsList.appendChild(d);
  });
}

function renderLogUI(){
  mealInput.innerHTML="";
  meals.forEach(m=>{
    const o=document.createElement("option");
    o.textContent=m;
    mealInput.appendChild(o);
  });

  kidsChecks.innerHTML="";
  kids.forEach(k=>{
    kidsChecks.innerHTML+=
      `<div><label><input type="checkbox" checked value="${k}"> ${k}</label></div>`;
  });
}

function renderHistory(){
  history.innerHTML="";
  logs.slice().reverse().forEach(l=>{
    const d=document.createElement("div");
    d.className="list-item";
    d.innerHTML=`<span>${l.date} | ${l.type} | ${l.meal} | ${l.kids.join(",")}</span>`;
    history.appendChild(d);
  });
}

/* ===== ACTIONS ===== */
function addKid(){
  if(newKid.value){
    kids.push(newKid.value);
    newKid.value="";
    saveLocal();
    renderAll();
  }
}
function removeKid(k){
  kids=kids.filter(x=>x!==k);
  saveLocal();
  renderAll();
}

function addMeal(){
  if(newMeal.value){
    meals.push(newMeal.value);
    newMeal.value="";
    saveLocal();
    renderAll();
  }
}
function removeMeal(m){
  meals=meals.filter(x=>x!==m);
  saveLocal();
  renderAll();
}

function addLog(){
  const checked=[...kidsChecks.querySelectorAll("input:checked")].map(i=>i.value);
  logs.push({
    date:dateInput.value,
    type:typeInput.value,
    meal:mealInput.value,
    kids:checked
  });
  saveLocal();
  renderHistory();
}

/* ===== INIT ===== */
dateInput.value=new Date().toISOString().slice(0,10);
renderAll();
syncLoad();
</script>

</body>
</html>
