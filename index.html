<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>××¨×•×—×•×ª ×”×™×œ×“×™×</title>

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#2563eb">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --border:#e5e7eb;
      --primary:#2563eb; --primary2:#1d4ed8;
      --danger:#dc2626; --muted:#6b7280;
      --shadow:0 6px 18px rgba(0,0,0,0.06);
      --radius:16px;
      --pill:#f3f4f6;
      --boker:#fff7ed; --tzohor:#ecfeff; --erev:#eef2ff; --bein:#fdf2f8;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:14px;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:#111827; line-height:1.35;
    }
    h1{margin:6px 0 14px;font-size:24px;font-weight:900}
    h2{margin:0 0 10px;font-size:18px}
    h3{margin:14px 0 6px;font-size:14px;color:var(--muted)}
    .card{
      background:var(--card); border:1px solid var(--border);
      border-radius:var(--radius); box-shadow:var(--shadow);
      padding:14px; margin-bottom:14px;
    }
    .tabs{display:flex; gap:8px; margin-bottom:14px; flex-wrap:wrap;}
    .tabbtn{
      border:1px solid var(--border); background:#fff;
      border-radius:999px; padding:9px 12px; font-weight:900; cursor:pointer;
    }
    .tabbtn.active{background:var(--primary); color:#fff; border-color:var(--primary);}
    .view{display:none}
    .view.active{display:block}

    .field{margin-top:10px}
    label{font-weight:900}
    input,select,textarea{
      width:100%; padding:10px 12px; font-size:16px;
      border-radius:12px; border:1px solid var(--border);
      background:#fff;
    }
    textarea{min-height:140px; resize:vertical}

    .inline{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .inline input{flex:1; min-width:180px}

    .btn{
      padding:10px 14px; border-radius:12px; border:none;
      font-weight:900; cursor:pointer; white-space:nowrap;
    }
    .primary{background:var(--primary); color:#fff}
    .primary:hover{background:var(--primary2)}
    .danger{background:var(--danger); color:#fff}
    .ghost{background:#eef2ff; color:#1e40af; border:1px solid #c7d2fe}

    .iconbtn{
      background:#f3f4f6; color:#111827;
      padding:8px 10px; border-radius:12px; border:1px solid var(--border);
      font-weight:900; line-height:1;
      cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center;
      min-width:40px;
    }

    .note{font-size:13px;color:var(--muted);margin-top:6px}

    .checks{display:flex; flex-direction:column; gap:10px; margin-top:8px;}
    .checkrow{
      display:flex; align-items:center; gap:10px;
      padding:10px; border:1px solid var(--border);
      border-radius:14px; background:#fff;
    }
    .checkrow input{width:18px; height:18px; margin:0}

    ul{list-style:none;padding:0;margin:10px 0 0}
    li{
      display:flex; justify-content:space-between; gap:10px;
      background:#fff; border:1px solid var(--border);
      border-radius:14px; padding:10px; margin-bottom:8px;
      align-items:center;
    }
    li span{flex:1; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
    .btn-group{display:flex; gap:8px; align-items:center; flex:0 0 auto}

    .filters{
      display:flex; gap:8px; flex-wrap:nowrap; overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      padding-bottom:4px; margin:8px 0 10px;
    }
    .filter{
      display:flex; align-items:center; gap:6px;
      font-weight:900; font-size:12px;
      background:#fff; border:1px solid var(--border);
      padding:6px 8px; border-radius:999px;
      white-space:nowrap; flex:0 0 auto;
    }
    .filter input{width:16px;height:16px;margin:0}

    .daycard{
      border:1px solid var(--border);
      background:#fff;
      border-radius:18px;
      padding:10px;
      margin-bottom:10px;
      overflow:hidden;
    }
    .dayheader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:6px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:13px;
      border:1px solid var(--border);
      white-space:nowrap;
      background:var(--pill);
    }
    .typepill{border:none; min-width:78px;}
    .type-boker{background:var(--boker)}
    .type-tzohor{background:var(--tzohor)}
    .type-erev{background:var(--erev)}
    .type-bein{background:var(--bein)}

    .entry{
      border:1px solid var(--border);
      border-radius:16px;
      padding:8px;
      margin-bottom:8px;
      background:#fff;
    }
    .entry-top{
      display:flex; align-items:center; justify-content:space-between;
      gap:8px; margin-bottom:6px;
    }
    .actionrow{display:flex; gap:8px; align-items:center; flex:0 0 auto;}
    .delbtn{
      min-width:62px;
      border:1px solid var(--border);
      background:#fff;
      border-radius:12px;
      padding:6px 10px;
      cursor:pointer;
      font-weight:900;
      white-space:nowrap;
    }

    .splitlist{display:flex; flex-direction:column; gap:4px;}
    .splitline{
      display:flex; justify-content:space-between; gap:10px;
      border:1px dashed var(--border);
      border-radius:12px;
      padding:6px 8px;
      background:#fafafa;
      font-size:13px;
    }
    .splitkid{font-weight:900; white-space:nowrap; flex:0 0 auto;}
    .splitmeal{
      font-weight:900; color:#374151;
      min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
      text-align:left; flex:1;
    }

    .kv{display:flex; justify-content:space-between; gap:10px; padding:6px 0; border-bottom:1px dashed var(--border);}
    .kv:last-child{border-bottom:none}
    .kv b{white-space:nowrap}
    .kv span{min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; text-align:left; color:#374151; font-weight:900;}

    .modal-backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,0.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      z-index:9999;
    }
    .modal{
      width:100%;
      max-width:720px;
      background:#fff;
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:0 16px 50px rgba(0,0,0,0.2);
      padding:14px;
    }
    .modal-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .modal-title{font-weight:900;font-size:18px}
    .modal-actions{display:flex;gap:10px;flex-wrap:wrap}
    .tiny{
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#f3f4f6;
      font-weight:900;
      cursor:pointer;
      white-space:nowrap;
    }
    .warn{color:var(--danger); font-size:13px; margin-top:8px; display:none;}

    .errbox{
      background:#fee2e2;
      border:1px solid #fecaca;
      color:#991b1b;
      padding:10px 12px;
      border-radius:14px;
      margin:0 0 12px;
      font-weight:900;
      display:none;
      direction:ltr;
      white-space:pre-wrap;
    }

    @media(min-width:700px){ body{max-width:860px;margin:auto} }
  </style>
</head>

<body>
<div id="errbox" class="errbox"></div>

<h1>ğŸ½ï¸ ××¨×•×—×•×ª ×”×™×œ×“×™×</h1>

<div class="tabs">
  <button id="tab-log" class="tabbtn active" type="button">×¨×™×©×•×</button>
  <button id="tab-kids" class="tabbtn" type="button">× ×™×”×•×œ ×™×œ×“×™×</button>
  <button id="tab-dishes" class="tabbtn" type="button">× ×™×”×•×œ ×× ×•×ª</button>
  <button id="tab-data" class="tabbtn" type="button">× ×ª×•× ×™×</button>
</div>

<section id="view-log" class="view active">
  <section class="card">
    <h2>×¨×™×©×•× ××¨×•×—×”</h2>

    <div class="field">
      <label>×ª××¨×™×š</label>
      <input type="date" id="dateInput">
    </div>

    <div class="field">
      <label>×¡×•×’ ××¨×•×—×”</label>
      <select id="mealType">
        <option value="×‘×•×§×¨">×‘×•×§×¨</option>
        <option value="×¦×”×¨×™×™×">×¦×”×¨×™×™×</option>
        <option value="×¢×¨×‘" selected>×¢×¨×‘</option>
        <option value="×‘×™× ×™×™×">×‘×™× ×™×™×</option>
      </select>
    </div>

    <div class="field checkrow" style="justify-content:space-between;">
      <div style="display:flex;align-items:center;gap:10px;">
        <input type="checkbox" id="sameForAll" checked>
        <strong>××•×ª×” ××¨×•×—×” ×œ×›×•×œ×</strong>
      </div>
    </div>

    <div id="sameMode">
      <div class="field">
        <label>×× ×”</label>
        <div class="inline">
          <select id="mealSelect"></select>
          <button class="btn ghost" type="button" id="btnSuggest">×ª×Ÿ ×œ×™ ×¨×¢×™×•×Ÿ</button>
        </div>
        <div class="note">×”×‘×—×™×¨×” ××¡×•× × ×ª ×œ×¤×™ ×¡×•×’ ×”××¨×•×—×” (×× ×”×’×“×¨×ª ×œ×× ×” ×¡×•×’×™×).</div>
      </div>

      <h3>××™ ××›×œ?</h3>
      <div id="sameKids" class="checks"></div>
    </div>

    <div id="splitMode" style="display:none;">
      <h3>×‘×—×™×¨×” × ×¤×¨×“×ª ×œ×›×œ ×™×œ×“</h3>
      <div id="splitKids" class="checks"></div>
      <div class="note">×‘××¦×‘ ××¤×•×¦×œ: ×œ×›×œ ×™×œ×“ ×‘×•×—×¨×™× ×× ×”.</div>
    </div>

    <div class="field">
      <button class="btn primary" type="button" id="btnSaveMeal">×©××™×¨×”</button>
    </div>

    <div class="note" id="syncStatus"></div>
  </section>

  <section class="card">
    <h2>ğŸ’¡ ×”×™×“×¢×ª?</h2>

    <h3>3 ×× ×•×ª ×©×”×•×›× ×• ×”×›×™ ××¢×˜ (×¨×§ ×× ×•×ª ×©× ×•×¦×¨×• ×œ×¤× ×™ ×—×•×“×©+)</h3>
    <div id="statsLeast"></div>

    <h3>3 ×× ×•×ª ×©×”×›× ×ª×™ ×”×›×™ ××–××Ÿ</h3>
    <div id="statsOldest"></div>
  </section>
</section>

<section id="view-kids" class="view">
  <section class="card">
    <h2>× ×™×”×•×œ ×™×œ×“×™×</h2>
    <div class="inline">
      <input id="newKidInput" placeholder="×©× ×™×œ×“/×”">
      <button class="btn primary" type="button" id="btnAddKid">×”×•×¡×£</button>
    </div>
    <ul id="kidsList"></ul>
  </section>
</section>

<section id="view-dishes" class="view">
  <section class="card">
    <h2>× ×™×”×•×œ ×× ×•×ª</h2>
    <div class="inline">
      <input id="newDishInput" placeholder="×©× ×× ×”">
      <button class="btn primary" type="button" id="btnAddDish">×”×•×¡×£</button>
    </div>
    <div class="note">××—×™×§×” ×›××Ÿ ××¡×™×¨×” ××”×××’×¨ ×‘×œ×‘×“ (×œ× ××•×—×§×ª ×”×™×¡×˜×•×¨×™×”).</div>
    <ul id="dishesList"></ul>
  </section>
</section>

<section id="view-data" class="view">
  <section class="card">
    <h2>×”×™×¡×˜×•×¨×™×”</h2>
    <div class="note">×‘×¨×™×¨×ª ××—×“×œ: ×”×›×•×œ ××•×¦×’. ××¡× × ×™× ×¨×§ ×× ××¡×× ×™×.</div>

    <div class="note" style="margin-top:10px;">×¡×™× ×•×Ÿ ×œ×¤×™ ×™×œ×“×™× (××•×¤×¦×™×•× ×œ×™)</div>
    <div id="kidFilters" class="filters"></div>

    <div class="note" style="margin-top:6px;">×¡×™× ×•×Ÿ ×œ×¤×™ ×¡×•×’ ××¨×•×—×”</div>
    <div class="filters" id="typeFilters">
      <label class="filter"><input type="checkbox" value="×‘×•×§×¨" checked> ×‘×•×§×¨</label>
      <label class="filter"><input type="checkbox" value="×¦×”×¨×™×™×" checked> ×¦×”×¨×™×™×</label>
      <label class="filter"><input type="checkbox" value="×¢×¨×‘" checked> ×¢×¨×‘</label>
      <label class="filter"><input type="checkbox" value="×‘×™× ×™×™×" checked> ×‘×™× ×™×™×</label>
    </div>

    <div id="historyWrap"></div>
  </section>

  <section class="card">
    <h2>×©×‘×•×¢ ××—×¨×•×Ÿ</h2>
    <label>×ª××¨×™×š ×¡×™×•× ×©×‘×•×¢ (×›×•×œ×œ)</label>
    <input type="date" id="weekEndDate">

    <div id="weekWrap" style="margin-top:10px;"></div>

    <h3>×’×™×•×•×Ÿ (×›××” ×¤×¢××™× ×›×œ ×× ×” ×‘×©×‘×•×¢)</h3>
    <ul id="varietyList"></ul>
  </section>

  <section class="card">
    <h2>×›×œ×™ ×‘×“×™×§×”</h2>
    <div class="note">××•×—×§ ×¨×§ ××ª ×”×”×™×¡×˜×•×¨×™×” (×¨×™×©×•××™ ××¨×•×—×•×ª). ×œ× ××•×—×§ ×™×œ×“×™×/×× ×•×ª/××ª×›×•× ×™×.</div>
    <button class="btn danger" type="button" id="btnClearHistory">××—×§ ×”×™×¡×˜×•×¨×™×”</button>
  </section>

  <section class="card">
    <h2>××™×¤×•×¡ × ×ª×•× ×™×</h2>
    <div class="note">×–×” ××•×—×§ ×”×›×œ ××”××›×©×™×¨ (×™×œ×“×™×/×× ×•×ª/×”×™×¡×˜×•×¨×™×”/××ª×›×•× ×™×).</div>
    <button class="btn danger" type="button" id="btnResetAll">××™×¤×•×¡ ××œ×</button>
  </section>
</section>

<div id="recipeBackdrop" class="modal-backdrop">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title" id="recipeTitle">××ª×›×•×Ÿ</div>
      <div class="modal-actions">
        <button class="tiny" type="button" id="btnRecipeSave">×©××™×¨×”</button>
        <button class="tiny" type="button" id="btnRecipeClose">×¡×’×•×¨</button>
      </div>
    </div>

    <div class="field">
      <label>×§×™×©×•×¨ (××•×¤×¦×™×•× ×œ×™)</label>
      <div class="inline">
        <input id="recipeUrlInput" placeholder="https://...">
        <button class="tiny" type="button" id="btnPasteUrl">×”×“×‘×§ ×§×™×©×•×¨</button>
        <button class="tiny" type="button" id="btnOpenUrl">×¤×ª×— ×§×™×©×•×¨</button>
      </div>
    </div>

    <div class="field">
      <label>××ª×›×•×Ÿ</label>
      <div class="inline">
        <button class="tiny" type="button" id="btnPasteRecipe">×”×“×‘×§ ××ª×›×•×Ÿ</button>
      </div>
      <textarea id="recipeTextInput" placeholder="×”×“×‘×§/×›×ª×•×‘ ×›××Ÿ ××ª ×”××ª×›×•×Ÿ..."></textarea>
      <div id="pasteWarn" class="warn">×× ×”×”×“×‘×§×” ×”××•×˜×•××˜×™×ª ×œ× ×¢×•×‘×“×ª â€” ×”×“×‘×§ ×™×“× ×™×ª (×œ×—×™×¦×” ××¨×•×›×” â†’ Paste).</div>
    </div>

    <div class="field">
      <label>×¡×•×’×™ ××¨×•×—×•×ª ×œ×× ×” ×”×–×•</label>
      <div class="checks" id="recipeTypeChecks"></div>
      <div class="note">×× ×œ× ××¡×× ×™× ×›×œ×•× â€” ×”×× ×” ×ª×•×¤×™×¢ ×‘×›×œ ×¡×•×’×™ ×”××¨×•×—×•×ª.</div>
    </div>
  </div>
</div>

<script>
  // ===== ×ª×™×‘×ª ×©×’×™××•×ª ×œ××¡×š (×›×“×™ ×©×¡×¤××¨×™ ×œ× "×™×©×ª×•×§") =====
  window.onerror = function(msg, src, line, col){
    try{
      var box = document.getElementById("errbox");
      box.style.display = "block";
      box.textContent = "JS ERROR:\n" + msg + "\n" + (src||"") + ":" + (line||"") + ":" + (col||"");
    }catch(e){}
    return true;
  };

  // ===== Google Sync =====
  var SYNC_URL = "https://script.google.com/macros/s/AKfycby8gDkzATtKwGFqFguvvTcqZ0jC1FCADAFWw1PLoOzVAmV1UwuZiIPkC1YNhmD_4pi4/exec";
  var SYNC_TOKEN = "CHANGE_ME_12345"; // ×—×™×™×‘ ×œ×”×™×•×ª ×–×”×” ×œ××” ×©×©××ª ×‘-Apps Script
  var MASTER_NAME = "Yanir";

  // ×‘××›×©×™×¨ ××—×¨ (××™×™×¤×•×Ÿ) ×ª×—×œ×™×£ ×¤×¢× ××—×ª ×œ-"Reut" ×•××– ×–×” ×™×™×©××¨
  var DEVICE_NAME = localStorage.getItem("deviceName") || "Yanir";

  function setSyncMsg(msg){
    var el = document.getElementById("syncStatus");
    if(el) el.textContent = msg || "";
  }
  function safeJSONParse(s, fallback){
    try { return JSON.parse(s); } catch(e){ return fallback; }
  }

  function getLocalMeta(){
    return safeJSONParse(localStorage.getItem("syncMeta") || "{}", {});
  }
  function setLocalMeta(meta){
    localStorage.setItem("syncMeta", JSON.stringify(meta || {}));
  }

  function localHasAnyData(){
    var kids = safeJSONParse(localStorage.getItem("kids") || "[]", []);
    var dishes = safeJSONParse(localStorage.getItem("dishes") || "[]", []);
    var logs = safeJSONParse(localStorage.getItem("logs") || "[]", []);
    return !!(kids.length || dishes.length || logs.length);
  }

  var syncTimer = null;

  function doSyncSend(){
    var payload = {
      kids: safeJSONParse(localStorage.getItem("kids") || "[]", []),
      dishes: safeJSONParse(localStorage.getItem("dishes") || "[]", []),
      logs: safeJSONParse(localStorage.getItem("logs") || "[]", [])
    };
    var dataStr = JSON.stringify(payload);

    var url = SYNC_URL +
      "?token=" + encodeURIComponent(SYNC_TOKEN) +
      "&write=1" +
      "&by=" + encodeURIComponent(DEVICE_NAME) +
      "&data=" + encodeURIComponent(dataStr);

    return fetch(url).then(function(r){ return r.json(); });
  }

  function syncSave(){
    // ×¨×§ MASTER ×“×•×—×£ ×œ×¢× ×Ÿ
    if(DEVICE_NAME !== MASTER_NAME) return;

    try{
      if(syncTimer) clearTimeout(syncTimer);
      syncTimer = setTimeout(function(){
        setSyncMsg("××¡× ×›×¨×Ÿ...");
        doSyncSend().then(function(j){
          if(j && j.ok && j.meta){
            setLocalMeta(j.meta);
          }
          setSyncMsg("×¡×•× ×›×¨×Ÿ âœ…");
        }).catch(function(){
          setSyncMsg("×¡× ×›×¨×•×Ÿ × ×›×©×œ âŒ");
        });
      }, 500);
    }catch(e){
      setSyncMsg("×¡× ×›×¨×•×Ÿ × ×›×©×œ âŒ");
    }
  }

  function syncLoad(){
    try{
      // MASTER ×œ× × ×“×¨×¡ ××”×¢× ×Ÿ
      if(DEVICE_NAME === MASTER_NAME) return;

      fetch(SYNC_URL + "?token=" + encodeURIComponent(SYNC_TOKEN))
        .then(function(res){ return res.json(); })
        .then(function(j){
          if(!j || !j.ok) return;

          // ×× ××™×Ÿ × ×ª×•× ×™× ×‘×¢× ×Ÿ â€” ×œ× × ×•×’×¢×™× ×‘×›×œ×•×
          if(!j.data) return;

          var remote = safeJSONParse(j.data, null);
          if(!remote) return;

          var remoteMeta = j.meta || {};
          var localMeta = getLocalMeta();
          var remoteUpdated = Number(remoteMeta.updatedAt || 0);
          var localUpdated = Number(localMeta.updatedAt || 0);

          // ×× ×™×© ××§×•××™×ª ××™×“×¢, ×•×¨×™××•×˜ ×œ× ×—×“×© ×™×•×ª×¨ â€” ×œ× × ×“×¨×•×¡
          if(localHasAnyData() && remoteUpdated <= localUpdated) return;

          localStorage.setItem("kids", JSON.stringify(remote.kids || []));
          localStorage.setItem("dishes", JSON.stringify(remote.dishes || []));
          localStorage.setItem("logs", JSON.stringify(remote.logs || []));
          setLocalMeta(remoteMeta);

          // ×‘×œ×™ reload ×‘×¡×¤××¨×™ â€“ ×¤×©×•×˜ × ×¨× ×“×¨ ××—×“×©
          renderAll();
          setSyncMsg("× ×˜×¢×Ÿ ××”×¡× ×›×¨×•×Ÿ âœ…");
        })
        .catch(function(){});
    } catch(e){}
  }

  // ===== App data =====
  var KIDS_KEY = "kids";
  var DISHES_KEY = "dishes";
  var LOGS_KEY = "logs";

  var DAY = 24*60*60*1000;
  var MONTH_30 = 30*DAY;

  var TYPES = ["×‘×•×§×¨","×¦×”×¨×™×™×","×¢×¨×‘","×‘×™× ×™×™×"];

  function uid(){ return "r_" + Math.random().toString(16).slice(2) + "_" + Date.now(); }
  function todayISO(){ return new Date().toISOString().slice(0,10); }
  function isoDateMs(d){ return new Date(d + "T00:00:00").getTime(); }
  function addDays(dateISO, n){
    var x = new Date(dateISO + "T00:00:00");
    x.setDate(x.getDate() + n);
    return x.toISOString().slice(0,10);
  }

  function normalizeDishes(raw){
    if(!raw) return [];
    if(Array.isArray(raw) && raw.length && typeof raw[0] === "string"){
      var oldCreated = Date.now() - 60*DAY;
      return raw.map(function(name){
        return { dish:String(name).trim(), createdAt:oldCreated, recipeText:"", recipeUrl:"", types:TYPES.slice() };
      }).filter(function(x){ return x.dish; });
    }
    if(Array.isArray(raw)){
      return raw.map(function(o){
        o = o || {};
        var dish = String(o.dish || "").trim();
        var createdAt = Number(o.createdAt) || (Date.now() - 60*DAY);
        var recipeText = String(o.recipeText || "");
        var recipeUrl = String(o.recipeUrl || "");
        var types = Array.isArray(o.types) ? o.types.filter(function(t){ return TYPES.indexOf(t)>=0; }) : TYPES.slice();
        if(!types.length) types = TYPES.slice();
        return { dish:dish, createdAt:createdAt, recipeText:recipeText, recipeUrl:recipeUrl, types:types };
      }).filter(function(x){ return x.dish; });
    }
    return [];
  }

  var kids = safeJSONParse(localStorage.getItem(KIDS_KEY), null);
  if(!kids) kids = ["××™×§×”","×¢×•××¨"];

  var dishes = normalizeDishes(safeJSONParse(localStorage.getItem(DISHES_KEY), null));
  var logs = safeJSONParse(localStorage.getItem(LOGS_KEY), null);
  if(!logs) logs = [];

  function saveAll(){
    localStorage.setItem(KIDS_KEY, JSON.stringify(kids));
    localStorage.setItem(DISHES_KEY, JSON.stringify(dishes));
    localStorage.setItem(LOGS_KEY, JSON.stringify(logs));
    syncSave();
  }

  // ===== Tabs =====
  function showTab(key){
    var btns = document.querySelectorAll(".tabbtn");
    for(var i=0;i<btns.length;i++) btns[i].classList.remove("active");
    var views = document.querySelectorAll(".view");
    for(var j=0;j<views.length;j++) views[j].classList.remove("active");

    var viewId = "view-log";
    document.getElementById("tab-log").classList.add("active");

    if(key==="kids"){ viewId="view-kids"; document.getElementById("tab-kids").classList.add("active"); document.getElementById("tab-log").classList.remove("active"); }
    else if(key==="dishes"){ viewId="view-dishes"; document.getElementById("tab-dishes").classList.add("active"); document.getElementById("tab-log").classList.remove("active"); }
    else if(key==="data"){ viewId="view-data"; document.getElementById("tab-data").classList.add("active"); document.getElementById("tab-log").classList.remove("active"); }

    document.getElementById(viewId).classList.add("active");
  }

  // ===== UI helpers =====
  function typeClass(t){
    if(t==="×‘×•×§×¨") return "type-boker";
    if(t==="×¦×”×¨×™×™×") return "type-tzohor";
    if(t==="×¢×¨×‘") return "type-erev";
    return "type-bein";
  }
  function escapeHtml(s){
    s = String(s);
    return s.replace(/[&<>"']/g, function(m){
      return ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" })[m];
    });
  }
  function cssSafe(s){
    return String(s).replace(/[^a-zA-Z0-9_\u0590-\u05FF]/g, "_");
  }
  function getDishByName(name){
    for(var i=0;i<dishes.length;i++){
      if(dishes[i].dish === name) return dishes[i];
    }
    return null;
  }
  function dishHasRecipe(d){
    var t = (d && d.recipeText) ? String(d.recipeText).trim() : "";
    var u = (d && d.recipeUrl) ? String(d.recipeUrl).trim() : "";
    return (t.length>0 || u.length>0);
  }
  function dishAllowedForType(dishName, mealType){
    var d = getDishByName(dishName);
    if(!d) return false;
    var types = (d.types && d.types.length) ? d.types : TYPES;
    return types.indexOf(mealType)>=0;
  }
  function getDishesForType(mealType){
    var arr = [];
    for(var i=0;i<dishes.length;i++){
      var name = dishes[i].dish;
      if(dishAllowedForType(name, mealType)) arr.push(name);
    }
    if(arr.length) return arr;
    return dishes.map(function(d){ return d.dish; });
  }

  // ===== Render kids & dishes =====
  function renderKids(){
    var ul = document.getElementById("kidsList");
    ul.innerHTML = "";
    kids.forEach(function(k){
      var row = document.createElement("li");
      row.innerHTML = '<span>'+escapeHtml(k)+'</span><div class="btn-group"><button class="iconbtn" type="button" title="××—×§">âŒ</button></div>';
      row.querySelector("button").onclick = function(){ removeKid(k); };
      ul.appendChild(row);
    });
  }

  function renderDishes(){
    var ul = document.getElementById("dishesList");
    ul.innerHTML = "";
    var sorted = dishes.slice().sort(function(a,b){ return a.dish.localeCompare(b.dish,"he"); });

    sorted.forEach(function(d){
      var mark = dishHasRecipe(d) ? " âœ…" : "";
      var row = document.createElement("li");
      row.innerHTML =
        '<span>'+escapeHtml(d.dish)+mark+'</span>'+
        '<div class="btn-group">'+
          '<button class="iconbtn" type="button" title="××ª×›×•×Ÿ">ğŸ“–</button>'+
          '<button class="iconbtn" type="button" title="×¢×¨×•×š ×©×">âœï¸</button>'+
          '<button class="iconbtn" type="button" title="××—×§ ××”×××’×¨">âŒ</button>'+
        '</div>';

      var btns = row.querySelectorAll("button");
      btns[0].onclick = function(){ openRecipeModal(d.dish); };
      btns[1].onclick = function(){ editDishName(d.dish); };
      btns[2].onclick = function(){ deleteDish(d.dish); };

      ul.appendChild(row);
    });
  }

  // ===== Log selectors =====
  function toggleMode(){
    var same = document.getElementById("sameForAll").checked;
    document.getElementById("sameMode").style.display = same ? "block" : "none";
    document.getElementById("splitMode").style.display = same ? "none" : "block";
  }

  function renderLogSelectors(){
    var type = document.getElementById("mealType").value;
    var available = getDishesForType(type);

    var sel = document.getElementById("mealSelect");
    var current = sel.value;
    sel.innerHTML = "";
    available.forEach(function(name){
      var o = document.createElement("option");
      o.value = name; o.textContent = name;
      sel.appendChild(o);
    });
    if(current && available.indexOf(current)>=0) sel.value = current;

    var sameKids = document.getElementById("sameKids");
    sameKids.innerHTML = "";
    kids.forEach(function(k){
      var row = document.createElement("div");
      row.className = "checkrow";
      row.innerHTML = '<input type="checkbox" id="cb_'+cssSafe(k)+'" checked><div style="font-weight:900;">'+escapeHtml(k)+'</div>';
      sameKids.appendChild(row);
    });

    var splitKids = document.getElementById("splitKids");
    splitKids.innerHTML = "";
    kids.forEach(function(k){
      var row = document.createElement("div");
      row.className = "checkrow";
      row.innerHTML = '<div style="font-weight:900; min-width:90px;">'+escapeHtml(k)+'</div><select id="sel_'+cssSafe(k)+'"></select>';
      var s = row.querySelector("select");
      available.forEach(function(name){
        var o = document.createElement("option");
        o.value = name; o.textContent = name;
        s.appendChild(o);
      });
      splitKids.appendChild(row);
    });

    renderKidFilters();
  }

  // ===== Kids CRUD =====
  function addKid(){
    var v = (document.getElementById("newKidInput").value || "").trim();
    if(!v) return;
    if(kids.indexOf(v)>=0) return alert("×”×™×œ×“/×” ×›×‘×¨ ×§×™×™×/×ª");
    kids.push(v);
    document.getElementById("newKidInput").value = "";
    saveAll(); renderAll();
  }

  function removeKid(name){
    if(!confirm('×œ××—×•×§ ××ª "'+name+'"?')) return;
    kids = kids.filter(function(k){ return k!==name; });

    logs = logs.map(function(r){
      if(r.same){
        r.kids = (r.kids || []).filter(function(k){ return k!==name; });
        return r;
      } else {
        var km = {};
        var old = r.kidMeals || {};
        for(var k in old){ if(k!==name) km[k]=old[k]; }
        r.kidMeals = km;
        return r;
      }
    }).filter(function(r){
      if(r.same) return (r.kids||[]).length>0;
      return Object.keys(r.kidMeals||{}).length>0;
    });

    saveAll(); renderAll();
  }

  // ===== Dishes CRUD =====
  function addDish(){
    var v = (document.getElementById("newDishInput").value || "").trim();
    if(!v) return;
    for(var i=0;i<dishes.length;i++){ if(dishes[i].dish===v) return alert("×”×× ×” ×›×‘×¨ ×§×™×™××ª"); }

    dishes.push({ dish:v, createdAt:Date.now(), recipeText:"", recipeUrl:"", types:TYPES.slice() });
    document.getElementById("newDishInput").value = "";
    saveAll(); renderAll();
  }

  function editDishName(oldName){
    var next = (prompt("×©× ×—×“×© ×œ×× ×”:", oldName) || "").trim();
    if(!next) return;
    if(next===oldName) return;
    for(var i=0;i<dishes.length;i++){ if(dishes[i].dish===next) return alert("×›×‘×¨ ×§×™×™××ª ×× ×” ×‘×©× ×”×–×”"); }

    dishes = dishes.map(function(d){ return d.dish===oldName ? ({ dish:next, createdAt:d.createdAt, recipeText:d.recipeText, recipeUrl:d.recipeUrl, types:d.types }) : d; });

    logs = logs.map(function(r){
      if(r.same){
        if(r.meal===oldName) r.meal=next;
      } else {
        var km = r.kidMeals || {};
        for(var k in km){ if(km[k]===oldName) km[k]=next; }
        r.kidMeals = km;
      }
      return r;
    });

    saveAll(); renderAll();
  }

  function deleteDish(name){
    if(!confirm('×œ××—×•×§ ××ª "'+name+'" ××”×××’×¨ ×‘×œ×‘×“? (×”×™×¡×˜×•×¨×™×” ×œ× ×ª×™××—×§)')) return;
    dishes = dishes.filter(function(d){ return d.dish!==name; });
    saveAll(); renderAll();
  }

  // ===== Save meal =====
  function saveMeal(){
    if(!dishes.length) return alert("××™×Ÿ ×× ×•×ª ×‘×××’×¨. ×”×•×¡×£ ×× ×” ×§×•×“×.");
    if(!kids.length) return alert("××™×Ÿ ×™×œ×“×™×. ×”×•×¡×£ ×™×œ×“/×” ×§×•×“×.");

    var date = document.getElementById("dateInput").value;
    var type = document.getElementById("mealType").value;
    if(!date) return alert("×‘×—×¨ ×ª××¨×™×š");

    var createdAt = Date.now();

    if(document.getElementById("sameForAll").checked){
      var meal = document.getElementById("mealSelect").value;
      if(!meal) return alert("×‘×—×¨ ×× ×”");

      var selectedKids = [];
      kids.forEach(function(k){
        var el = document.getElementById("cb_"+cssSafe(k));
        if(el && el.checked) selectedKids.push(k);
      });
      if(!selectedKids.length) return alert("×¡××Ÿ ×œ×¤×—×•×ª ×™×œ×“/×” ××—×“/×ª");

      logs.push({ id:uid(), createdAt:createdAt, date:date, type:type, same:true, meal:meal, kids:selectedKids });
    } else {
      var km = {};
      for(var i=0;i<kids.length;i++){
        var k = kids[i];
        var sel = document.getElementById("sel_"+cssSafe(k));
        var val = sel ? sel.value : "";
        if(!val) return alert("×‘×—×¨ ×× ×” ×¢×‘×•×¨ "+k);
        km[k] = val;
      }
      logs.push({ id:uid(), createdAt:createdAt, date:date, type:type, same:false, kidMeals:km });
    }

    saveAll(); renderAll();
  }

  function suggestMeal(){
    if(!dishes.length) return;
    var end = document.getElementById("weekEndDate").value || document.getElementById("dateInput").value;
    if(!end) return;

    var start = addDays(end, -6);
    var type = document.getElementById("mealType").value;
    var candidates = getDishesForType(type);
    if(!candidates.length) return;

    var week = logs.filter(function(r){
      return r.date >= start && r.date <= end && r.type === type;
    });

    var counts = {};
    week.forEach(function(r){
      if(r.same){
        counts[r.meal] = (counts[r.meal]||0) + 1;
      } else {
        var km = r.kidMeals || {};
        for(var k in km){
          var m = km[k];
          counts[m] = (counts[m]||0) + 1;
        }
      }
    });

    var min = 999999;
    candidates.forEach(function(m){ min = Math.min(min, counts[m]||0); });
    var mins = candidates.filter(function(m){ return (counts[m]||0) === min; });

    document.getElementById("mealSelect").value = mins[Math.floor(Math.random()*mins.length)];
  }

  // ===== Filters & Data render =====
  var kidFilterBuiltFor = "";

  function renderKidFilters(){
    var signature = kids.join("|");
    if(signature === kidFilterBuiltFor) return;

    var host = document.getElementById("kidFilters");
    host.innerHTML = "";
    kids.forEach(function(k){
      var lab = document.createElement("label");
      lab.className = "filter";
      lab.innerHTML = '<input type="checkbox" value="'+escapeHtml(k)+'"> '+escapeHtml(k);
      host.appendChild(lab);
    });
    kidFilterBuiltFor = signature;
  }

  function getActiveTypes(){
    var boxes = document.querySelectorAll("#typeFilters input:checked");
    var checked = [];
    for(var i=0;i<boxes.length;i++) checked.push(boxes[i].value);
    return checked.length ? checked : TYPES.slice();
  }
  function getActiveKids(){
    var boxes = document.querySelectorAll("#kidFilters input:checked");
    var checked = [];
    for(var i=0;i<boxes.length;i++) checked.push(boxes[i].value);
    return checked;
  }
  function recordKidsList(r){
    if(r.same) return r.kids || [];
    return Object.keys(r.kidMeals || {});
  }
  function recordMatchesKids(r, activeKids){
    if(!activeKids.length) return true;
    var rk = recordKidsList(r);
    for(var i=0;i<rk.length;i++){
      if(activeKids.indexOf(rk[i])>=0) return true;
    }
    return false;
  }

  function groupByDate(items){
    var map = {};
    items.forEach(function(r){
      var d = r.date || "";
      if(!map[d]) map[d] = [];
      map[d].push(r);
    });
    var dates = Object.keys(map).sort(function(a,b){ return b.localeCompare(a); });
    return dates.map(function(d){
      map[d].sort(function(a,b){ return (b.createdAt||0)-(a.createdAt||0); });
      return { date:d, items:map[d] };
    });
  }

  function createEntry(r){
    var entry = document.createElement("div");
    entry.className = "entry";

    var top = document.createElement("div");
    top.className = "entry-top";

    var typeP = document.createElement("span");
    typeP.className = "pill typepill " + typeClass(r.type);
    typeP.textContent = r.type || "";

    var actions = document.createElement("div");
    actions.className = "actionrow";

    var del = document.createElement("button");
    del.className = "delbtn";
    del.type = "button";
    del.textContent = "××—×§";
    del.onclick = function(){ deleteReport(r.id); };

    actions.appendChild(del);

    top.appendChild(typeP);
    top.appendChild(actions);

    var bottom = document.createElement("div");

    if(r.same){
      bottom.innerHTML = '<div class="splitline"><div class="splitkid">×× ×”:</div><div class="splitmeal">'+escapeHtml(r.meal||"")+'</div></div>' +
                         '<div class="splitline"><div class="splitkid">×™×œ×“×™×:</div><div class="splitmeal">'+escapeHtml((r.kids||[]).join(", "))+'</div></div>';
    } else {
      var list = document.createElement("div");
      list.className = "splitlist";
      var km = r.kidMeals || {};
      Object.keys(km).forEach(function(k){
        var line = document.createElement("div");
        line.className = "splitline";
        line.innerHTML = '<div class="splitkid">'+escapeHtml(k)+':</div><div class="splitmeal">'+escapeHtml(km[k])+'</div>';
        list.appendChild(line);
      });
      bottom.appendChild(list);
    }

    entry.appendChild(top);
    entry.appendChild(bottom);
    return entry;
  }

  function renderGrouped(container, items){
    container.innerHTML = "";
    var groups = groupByDate(items);
    if(!groups.length){
      var empty = document.createElement("div");
      empty.className = "note";
      empty.textContent = "××™×Ÿ ×¨×™×©×•××™× ×œ×”×¦×’×”.";
      container.appendChild(empty);
      return;
    }
    groups.forEach(function(g){
      var day = document.createElement("div");
      day.className = "daycard";

      var head = document.createElement("div");
      head.className = "dayheader";
      var dateP = document.createElement("span");
      dateP.className = "pill";
      dateP.textContent = g.date;

      head.appendChild(dateP);
      day.appendChild(head);

      g.items.forEach(function(r){ day.appendChild(createEntry(r)); });
      container.appendChild(day);
    });
  }

  function renderData(){
    renderKidFilters();

    var types = getActiveTypes();
    var activeKids = getActiveKids();

    var all = logs
      .filter(function(r){ return types.indexOf(r.type)>=0; })
      .filter(function(r){ return recordMatchesKids(r, activeKids); })
      .sort(function(a,b){
        var ad=a.date||"", bd=b.date||"";
        if(bd!==ad) return bd.localeCompare(ad);
        return (b.createdAt||0)-(a.createdAt||0);
      });

    renderGrouped(document.getElementById("historyWrap"), all);

    var end = document.getElementById("weekEndDate").value || document.getElementById("dateInput").value;
    if(!end){
      document.getElementById("weekWrap").innerHTML = "";
      document.getElementById("varietyList").innerHTML = "";
      renderDidYouKnow();
      return;
    }
    var start = addDays(end, -6);

    var week = logs
      .filter(function(r){ return r.date >= start && r.date <= end; })
      .filter(function(r){ return types.indexOf(r.type)>=0; })
      .filter(function(r){ return recordMatchesKids(r, activeKids); })
      .sort(function(a,b){
        var ad=a.date||"", bd=b.date||"";
        if(bd!==ad) return bd.localeCompare(ad);
        return (b.createdAt||0)-(a.createdAt||0);
      });

    renderGrouped(document.getElementById("weekWrap"), week);

    var counts = {};
    week.forEach(function(r){
      if(r.same){
        counts[r.meal] = (counts[r.meal]||0)+1;
      } else {
        var km = r.kidMeals || {};
        for(var k in km){
          var m = km[k];
          counts[m] = (counts[m]||0)+1;
        }
      }
    });

    var variety = document.getElementById("varietyList");
    variety.innerHTML = "";
    var entries = Object.keys(counts).map(function(meal){ return [meal, counts[meal]]; })
      .sort(function(a,b){ return b[1]-a[1] || a[0].localeCompare(b[0],"he"); });

    if(!entries.length){
      var li = document.createElement("li");
      li.innerHTML = "<span>××™×Ÿ × ×ª×•× ×™× ×œ×’×™×•×•×Ÿ ×‘×©×‘×•×¢ ×”×–×”</span>";
      variety.appendChild(li);
    } else {
      entries.forEach(function(e){
        var li2 = document.createElement("li");
        li2.innerHTML = "<span>"+escapeHtml(e[0])+" â€” "+e[1]+" ×¤×¢××™×</span>";
        variety.appendChild(li2);
      });
    }

    renderDidYouKnow();
  }

  function deleteReport(id){
    if(!confirm("×œ××—×•×§ ×“×™×•×•×—?")) return;
    logs = logs.filter(function(r){ return r.id !== id; });
    saveAll(); renderAll();
  }

  function clearHistoryOnly(){
    if(!confirm("×œ××—×•×§ ××ª ×›×œ ×”×”×™×¡×˜×•×¨×™×”?")) return;
    logs = [];
    saveAll(); renderAll();
  }

  function resetAll(){
    if(!confirm("××™×¤×•×¡ ××œ×?")) return;
    localStorage.clear();
    location.reload();
  }

  // ===== â€œDid you know?â€ =====
  function countDishUsageAllTime(){
    var counts = {};
    logs.forEach(function(r){
      if(r.same){
        counts[r.meal] = (counts[r.meal]||0)+1;
      } else {
        var km = r.kidMeals || {};
        for(var k in km){
          var m = km[k];
          counts[m] = (counts[m]||0)+1;
        }
      }
    });
    return counts;
  }
  function lastUsedByDish(){
    var last = {};
    logs.forEach(function(r){
      var t = isoDateMs(r.date) + ((Number(r.createdAt)||0) % DAY);
      if(r.same){
        var d = r.meal;
        if(last[d]==null || t>last[d]) last[d]=t;
      } else {
        var km = r.kidMeals || {};
        for(var k in km){
          var d2 = km[k];
          if(last[d2]==null || t>last[d2]) last[d2]=t;
        }
      }
    });
    return last;
  }
  function fmtDate(ms){
    var d = new Date(ms);
    var yyyy=d.getFullYear();
    var mm=String(d.getMonth()+1).padStart(2,"0");
    var dd=String(d.getDate()).padStart(2,"0");
    return yyyy+"-"+mm+"-"+dd;
  }
  function renderDidYouKnow(){
    var counts = countDishUsageAllTime();
    var last = lastUsedByDish();

    var cutoff = Date.now() - MONTH_30;
    var eligible = dishes.filter(function(d){ return (d.createdAt||0) <= cutoff; });

    var least = eligible.map(function(d){
      return { dish:d.dish, c: counts[d.dish] || 0 };
    }).sort(function(a,b){
      return a.c - b.c || a.dish.localeCompare(b.dish,"he");
    }).slice(0,3);

    var statsLeast = document.getElementById("statsLeast");
    statsLeast.innerHTML = "";
    if(!least.length){
      statsLeast.innerHTML = '<div class="note">×¢×“×™×™×Ÿ ××™×Ÿ ×× ×•×ª ×©×¢×‘×¨ ×¢×œ×™×”×Ÿ ×—×•×“×© ×××– ×©× ×•×¦×¨×•.</div>';
    } else {
      least.forEach(function(x){
        var row = document.createElement("div");
        row.className = "kv";
        row.innerHTML = "<b>"+escapeHtml(x.dish)+"</b><span>"+x.c+" ×¤×¢××™×</span>";
        statsLeast.appendChild(row);
      });
    }

    var statsOldest = document.getElementById("statsOldest");
    statsOldest.innerHTML = "";
    var lastEntries = Object.keys(last).map(function(dish){ return { dish:dish, t:last[dish] }; })
      .sort(function(a,b){ return a.t - b.t; })
      .slice(0,3);

    if(!lastEntries.length){
      statsOldest.innerHTML = '<div class="note">×¢×“×™×™×Ÿ ××™×Ÿ ×“×™×•×•×—×™× ×›×“×™ ×œ×—×©×‘ â€œ×”×›×™ ××–××Ÿâ€.</div>';
    } else {
      lastEntries.forEach(function(x){
        var row2 = document.createElement("div");
        row2.className = "kv";
        row2.innerHTML = "<b>"+escapeHtml(x.dish)+"</b><span>"+fmtDate(x.t)+"</span>";
        statsOldest.appendChild(row2);
      });
    }
  }

  // ===== Recipe modal =====
  var recipeDishName = null;

  function openRecipeModal(dishName){
    recipeDishName = dishName;
    var d = getDishByName(dishName);
    if(!d) return;

    document.getElementById("recipeTitle").textContent = "ğŸ“– ××ª×›×•×Ÿ: " + dishName;
    document.getElementById("recipeTextInput").value = d.recipeText || "";
    document.getElementById("recipeUrlInput").value = d.recipeUrl || "";
    document.getElementById("pasteWarn").style.display = "none";

    var host = document.getElementById("recipeTypeChecks");
    host.innerHTML = "";
    TYPES.forEach(function(t){
      var row = document.createElement("div");
      row.className = "checkrow";
      var types = (d.types && d.types.length) ? d.types : TYPES;
      var checked = (types.indexOf(t)>=0);
      row.innerHTML = '<input type="checkbox" id="rt_'+t+'" '+(checked?'checked':'')+'><div style="font-weight:900;">'+t+'</div>';
      host.appendChild(row);
    });

    document.getElementById("recipeBackdrop").style.display = "flex";
  }

  function hideRecipeModal(){
    document.getElementById("recipeBackdrop").style.display = "none";
    recipeDishName = null;
  }

  function pasteRecipe(){
    document.getElementById("pasteWarn").style.display = "none";
    try{
      if(!navigator.clipboard || !navigator.clipboard.readText){
        document.getElementById("pasteWarn").style.display="block"; return;
      }
      navigator.clipboard.readText().then(function(txt){
        if(txt) document.getElementById("recipeTextInput").value = txt;
      }).catch(function(){
        document.getElementById("pasteWarn").style.display="block";
      });
    } catch(e){
      document.getElementById("pasteWarn").style.display="block";
    }
  }

  function pasteUrl(){
    document.getElementById("pasteWarn").style.display = "none";
    try{
      if(!navigator.clipboard || !navigator.clipboard.readText){
        document.getElementById("pasteWarn").style.display="block"; return;
      }
      navigator.clipboard.readText().then(function(txt){
        if(txt) document.getElementById("recipeUrlInput").value = (txt||"").trim();
      }).catch(function(){
        document.getElementById("pasteWarn").style.display="block";
      });
    } catch(e){
      document.getElementById("pasteWarn").style.display="block";
    }
  }

  function openRecipeLink(){
    var url = (document.getElementById("recipeUrlInput").value || "").trim();
    if(!url) return alert("××™×Ÿ ×§×™×©×•×¨ ×œ×¤×ª×™×—×”");
    try{ window.open(new URL(url).toString(), "_blank"); }
    catch(e){ alert("×”×§×™×©×•×¨ ×œ× ×ª×§×™×Ÿ"); }
  }

  function saveRecipe(){
    if(!recipeDishName) return;
    var text = document.getElementById("recipeTextInput").value || "";
    var url = (document.getElementById("recipeUrlInput").value || "").trim();

    var selected = [];
    TYPES.forEach(function(t){
      var cb = document.getElementById("rt_"+t);
      if(cb && cb.checked) selected.push(t);
    });
    var types = selected.length ? selected : TYPES.slice();

    dishes = dishes.map(function(d){
      if(d.dish === recipeDishName){
        d.recipeText = text;
        d.recipeUrl = url;
        d.types = types;
      }
      return d;
    });

    saveAll();
    hideRecipeModal();
    renderAll();
  }

  // ===== init render =====
  function renderAll(){
    renderKids();
    renderDishes();
    renderLogSelectors();
    toggleMode();
    renderData();
  }

  // ===== Wire events (×—×©×•×‘ ×œ×¡×¤××¨×™) =====
  function wire(){
    document.getElementById("tab-log").onclick = function(){ showTab("log"); };
    document.getElementById("tab-kids").onclick = function(){ showTab("kids"); };
    document.getElementById("tab-dishes").onclick = function(){ showTab("dishes"); };
    document.getElementById("tab-data").onclick = function(){ showTab("data"); };

    document.getElementById("mealType").onchange = function(){ renderLogSelectors(); };
    document.getElementById("sameForAll").onchange = function(){ toggleMode(); };

    document.getElementById("btnSuggest").onclick = function(){ suggestMeal(); };
    document.getElementById("btnSaveMeal").onclick = function(){ saveMeal(); };
    document.getElementById("btnAddKid").onclick = function(){ addKid(); };
    document.getElementById("btnAddDish").onclick = function(){ addDish(); };
    document.getElementById("btnClearHistory").onclick = function(){ clearHistoryOnly(); };
    document.getElementById("btnResetAll").onclick = function(){ resetAll(); };

    document.getElementById("weekEndDate").onchange = function(){ renderData(); };

    // ×¤×™×œ×˜×¨×™×: ×›×œ ×©×™× ×•×™ ××¨× ×“×¨
    document.getElementById("typeFilters").addEventListener("change", function(){ renderData(); });
    document.getElementById("kidFilters").addEventListener("change", function(){ renderData(); });

    // ××•×“××œ ××ª×›×•×Ÿ
    document.getElementById("recipeBackdrop").onclick = function(e){
      if(e.target === document.getElementById("recipeBackdrop")) hideRecipeModal();
    };
    document.getElementById("btnRecipeClose").onclick = function(){ hideRecipeModal(); };
    document.getElementById("btnRecipeSave").onclick = function(){ saveRecipe(); };
    document.getElementById("btnPasteRecipe").onclick = function(){ pasteRecipe(); };
    document.getElementById("btnPasteUrl").onclick = function(){ pasteUrl(); };
    document.getElementById("btnOpenUrl").onclick = function(){ openRecipeLink(); };
  }

  // init defaults
  document.getElementById("dateInput").value = todayISO();
  document.getElementById("weekEndDate").value = todayISO();

  wire();
  renderAll();
  syncLoad();
</script>
</body>
</html>
