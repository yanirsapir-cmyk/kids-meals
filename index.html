<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ארוחות הילדים</title>
</head>
<body>

<h1>ארוחות הילדים</h1>

<button type="button" onclick="resetData()">איפוס נתונים</button>
<br><br>

<section>
  <h2>רישום ארוחה</h2>

  <label>
    תאריך:
    <input type="date" id="dateInput">
  </label>
  <br><br>

  <label>
    סוג ארוחה:
    <select id="mealType">
      <option value="בוקר">בוקר</option>
      <option value="צהריים">צהריים</option>
      <option value="ערב" selected>ערב</option>
      <option value="ביניים">ביניים</option>
    </select>
  </label>
  <br><br>

  <label>
    מנה (במצב "אותה ארוחה לשתיהן"):
    <select id="mealSelect"></select>
  </label>
  <br><br>

  <label>
    הוסף מנה חדשה למאגר:
    <input type="text" id="newMealInput" placeholder="לדוגמה: פסטה">
    <button type="button" onclick="addMeal()">הוסף</button>
  </label>
  <br><br>

  <strong>מי אכל?</strong><br>

  <label>
    <input type="checkbox" id="sameForBoth" checked onchange="toggleMode()">
    ברירת מחדל: אותה ארוחה לשתיהן
  </label>
  <br><br>

  <div id="sameMode">
    <label><input type="checkbox" id="mika" checked> מיקה</label><br>
    <label><input type="checkbox" id="omer" checked> עומר</label><br><br>
  </div>

  <div id="splitMode" style="display:none;">
    <label>מיקה אכלה:
      <select id="mealSelectMika"></select>
    </label>
    <br><br>

    <label>עומר אכלה:
      <select id="mealSelectOmer"></select>
    </label>
    <br><br>
  </div>

  <button type="button" onclick="saveMeal()">שמירה</button>
</section>

<hr>

<section>
  <h2>היסטוריה</h2>
  <ul id="mealList"></ul>
</section>

<hr>

<section>
  <h2>שבוע אחרון + גיוון</h2>

  <label>
    שבוע שמסתיים בתאריך:
    <input type="date" id="weekEndDate">
  </label>
  <button type="button" onclick="shiftWeek(-7)">שבוע קודם</button>
  <button type="button" onclick="shiftWeek(7)">שבוע הבא</button>

  <h3>רישומים בשבוע</h3>
  <ul id="weekList"></ul>

  <h3>סיכום גיוון (כמה פעמים כל מנה הופיעה)</h3>
  <ul id="varietyList"></ul>
</section>

<script>
  // ===== Data =====
  let meals = JSON.parse(localStorage.getItem("meals")) || [];
  let mealOptions = JSON.parse(localStorage.getItem("mealOptions")) || [];

  function saveData() {
    localStorage.setItem("meals", JSON.stringify(meals));
    localStorage.setItem("mealOptions", JSON.stringify(mealOptions));
  }

  function makeId() {
    return "m_" + Math.random().toString(16).slice(2) + "_" + Date.now();
  }

  function deleteMeal(id) {
    if (!confirm("למחוק את הדיווח?")) return;
    meals = meals.filter(m => m.id !== id);
    saveData();
    renderMeals();
    renderWeek();
  }

  function resetData() {
    const ok = confirm("זה ימחק את כל הדיווחים וכל מאגר המנות. להמשיך?");
    if (!ok) return;

    localStorage.removeItem("meals");
    localStorage.removeItem("mealOptions");

    meals = [];
    mealOptions = [];

    renderMealOptions();
    renderMeals();
    renderWeek();

    alert("בוצע איפוס נתונים");
  }

  // ===== Date helpers =====
  function todayISO() {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function parseISO(dateISO) {
    return new Date(dateISO + "T00:00:00");
  }

  function addDays(dateISO, delta) {
    const d = parseISO(dateISO);
    d.setDate(d.getDate() + delta);
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function isInRange(dateISO, startISO, endISO) {
    const t = parseISO(dateISO).getTime();
    return t >= parseISO(startISO).getTime() && t <= parseISO(endISO).getTime();
  }

  // ===== UI helpers =====
  function toggleMode() {
    const same = document.getElementById("sameForBoth").checked;
    document.getElementById("sameMode").style.display = same ? "block" : "none";
    document.getElementById("splitMode").style.display = same ? "none" : "block";
  }

  function renderMealOptions() {
    const select = document.getElementById("mealSelect");
    const selectMika = document.getElementById("mealSelectMika");
    const selectOmer = document.getElementById("mealSelectOmer");

    function fill(sel) {
      if (!sel) return;
      sel.innerHTML = "";
      mealOptions.forEach(m => {
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = m;
        sel.appendChild(opt);
      });
    }

    fill(select);
    fill(selectMika);
    fill(selectOmer);
  }

  function renderMeals() {
    const list = document.getElementById("mealList");
    list.innerHTML = "";

    meals.forEach(m => {
      const li = document.createElement("li");

      const text = m.split
        ? `${m.date} | ${m.type} | מיקה: ${m.mikaMeal} | עומר: ${m.omerMeal}`
        : `${m.date} | ${m.type} | ${m.meal} | ${m.kids.join(", ")}`;

      li.innerHTML = `
        <span>${text}</span>
        <button type="button" onclick="deleteMeal('${m.id}')">מחק</button>
      `;

      list.appendChild(li);
    });
  }

  // ===== Actions =====
  function addMeal() {
    const input = document.getElementById("newMealInput");
    const value = input.value.trim();
    if (!value) return;

    if (!mealOptions.includes(value)) {
      mealOptions.push(value);
      saveData();
      renderMealOptions();
    }
    input.value = "";
  }

  function saveMeal() {
    const date = document.getElementById("dateInput").value;
    const type = document.getElementById("mealType").value;

    if (!date) {
      alert("נא למלא תאריך");
      return;
    }

    const sameForBoth = document.getElementById("sameForBoth").checked;

    if (sameForBoth) {
      const meal = document.getElementById("mealSelect").value;

      const kids = [];
      if (document.getElementById("mika").checked) kids.push("מיקה");
      if (document.getElementById("omer").checked) kids.push("עומר");

      if (!meal || kids.length === 0) {
        alert("נא לבחור מנה ולסמן לפחות ילדה אחת");
        return;
      }

      meals.push({ id: makeId(), date, type, meal, kids });
      saveData();
      renderMeals();
      renderWeek();
      return;
    }

    // split mode
    const mealMika = document.getElementById("mealSelectMika").value;
    const mealOmer = document.getElementById("mealSelectOmer").value;

    if (!mealMika || !mealOmer) {
      alert("נא לבחור מנה למיקה וגם לעומר");
      return;
    }

    meals.push({ id: makeId(), date, type, split: true, mikaMeal: mealMika, omerMeal: mealOmer });
    saveData();
    renderMeals();
    renderWeek();
  }

  // ===== Week view =====
  function shiftWeek(deltaDays) {
    const end = document.getElementById("weekEndDate");
    end.value = addDays(end.value, deltaDays);
    renderWeek();
  }

  function renderWeek() {
    const endISO = document.getElementById("weekEndDate").value;
    const startISO = addDays(endISO, -6);

    const weekMeals = meals.filter(m => isInRange(m.date, startISO, endISO));

    // render week list
    const weekList = document.getElementById("weekList");
    weekList.innerHTML = "";

    if (weekMeals.length === 0) {
      const li = document.createElement("li");
      li.textContent = "אין רישומים בשבוע הזה";
      weekList.appendChild(li);
    } else {
      weekMeals.sort((a,b) => a.date.localeCompare(b.date));
      weekMeals.forEach(m => {
        const li = document.createElement("li");

        const text = m.split
          ? `${m.date} | ${m.type} | מיקה: ${m.mikaMeal} | עומר: ${m.omerMeal}`
          : `${m.date} | ${m.type} | ${m.meal} | ${m.kids.join(", ")}`;

        li.innerHTML = `
          <span>${text}</span>
          <button type="button" onclick="deleteMeal('${m.id}')">מחק</button>
        `;

        weekList.appendChild(li);
      });
    }

    // variety count
    const counts = new Map();
    weekMeals.forEach(m => {
      if (m.split) {
        counts.set(m.mikaMeal, (counts.get(m.mikaMeal) || 0) + 1);
        counts.set(m.omerMeal, (counts.get(m.omerMeal) || 0) + 1);
      } else {
        counts.set(m.meal, (counts.get(m.meal) || 0) + 1);
      }
    });

    const varietyList = document.getElementById("varietyList");
    varietyList.innerHTML = "";

    const entries = [...counts.entries()].sort((a,b) => b[1] - a[1] || a[0].localeCompare(b[0], "he"));

    if (entries.length === 0) {
      const li = document.createElement("li");
      li.textContent = "אין נתונים לגיוון בשבוע הזה";
      varietyList.appendChild(li);
    } else {
      entries.forEach(([meal, c]) => {
        const li = document.createElement("li");
        li.textContent = `${meal} — ${c} פעמים`;
        varietyList.appendChild(li);
      });
    }
  }

  // ===== Init =====
  document.getElementById("dateInput").value = todayISO();
  document.getElementById("weekEndDate").value = todayISO();

  toggleMode();
  renderMealOptions();
  renderMeals();
  renderWeek();
</script>

</body>
</html>
