<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ארוחות הילדים</title>
</head>
<body>

<h1>ארוחות הילדים</h1>

<button type="button" onclick="resetData()">איפוס נתונים</button>
<br><br>

<section>
  <h2>ניהול ילדים</h2>

  <label>
    הוסף ילד/ה:
    <input type="text" id="newKidInput" placeholder="לדוגמה: מיקה">
    <button type="button" onclick="addKid()">הוסף</button>
  </label>

  <ul id="kidsList"></ul>
</section>

<hr>

<section>
  <h2>רישום ארוחה</h2>

  <label>
    תאריך:
    <input type="date" id="dateInput">
  </label>
  <br><br>

  <label>
    סוג ארוחה:
    <select id="mealType">
      <option value="בוקר">בוקר</option>
      <option value="צהריים">צהריים</option>
      <option value="ערב" selected>ערב</option>
      <option value="ביניים">ביניים</option>
    </select>
  </label>
  <br><br>

  <label>
    מנה (במצב "אותה ארוחה לכולם"):
    <select id="mealSelect"></select>
  </label>
  <button type="button" onclick="suggestMeal()">תן לי רעיון</button>
  <br><br>

  <label>
    הוסף מנה חדשה למאגר:
    <input type="text" id="newMealInput" placeholder="לדוגמה: פסטה">
    <button type="button" onclick="addMeal()">הוסף</button>
  </label>
  <br><br>

  <strong>מי אכל?</strong><br>

  <label>
    <input type="checkbox" id="sameForAll" checked onchange="toggleMode()">
    ברירת מחדל: אותה ארוחה לכולם
  </label>
  <br><br>

  <div id="sameMode"></div>

  <div id="splitMode" style="display:none;">
    <div id="splitKidsContainer"></div>
  </div>

  <br>
  <button type="button" onclick="saveMeal()">שמירה</button>
</section>

<hr>

<section>
  <h2>היסטוריה</h2>
  <ul id="mealList"></ul>
</section>

<hr>

<section>
  <h2>שבוע אחרון + גיוון</h2>

  <label>
    שבוע שמסתיים בתאריך:
    <input type="date" id="weekEndDate">
  </label>
  <button type="button" onclick="shiftWeek(-7)">שבוע קודם</button>
  <button type="button" onclick="shiftWeek(7)">שבוע הבא</button>

  <h3>רישומים בשבוע</h3>
  <ul id="weekList"></ul>

  <h3>סיכום גיוון (כמה פעמים כל מנה הופיעה)</h3>
  <ul id="varietyList"></ul>
</section>

<script>
  // ===== Storage keys =====
  const KEY_MEALS = "meals";
  const KEY_OPTIONS = "mealOptions";
  const KEY_KIDS = "kids";

  const DEFAULT_KIDS = ["מיקה", "עומר"];

  // ===== Data =====
  let meals = JSON.parse(localStorage.getItem(KEY_MEALS)) || [];
  let mealOptions = JSON.parse(localStorage.getItem(KEY_OPTIONS)) || [];
  let kids = JSON.parse(localStorage.getItem(KEY_KIDS)) || [...DEFAULT_KIDS];

  function saveData() {
    localStorage.setItem(KEY_MEALS, JSON.stringify(meals));
    localStorage.setItem(KEY_OPTIONS, JSON.stringify(mealOptions));
    localStorage.setItem(KEY_KIDS, JSON.stringify(kids));
  }

  function makeId() {
    return "m_" + Math.random().toString(16).slice(2) + "_" + Date.now();
  }

  function deleteMeal(id) {
    if (!confirm("למחוק את הדיווח?")) return;
    meals = meals.filter(m => m.id !== id);
    saveData();
    renderMeals();
    renderWeek();
  }

  function resetData() {
    const ok = confirm("זה ימחק את כל הדיווחים, מאגר המנות ורשימת הילדים. להמשיך?");
    if (!ok) return;

    localStorage.removeItem(KEY_MEALS);
    localStorage.removeItem(KEY_OPTIONS);
    localStorage.removeItem(KEY_KIDS);

    meals = [];
    mealOptions = [];
    kids = [...DEFAULT_KIDS];

    saveData();
    renderAll();
    alert("בוצע איפוס נתונים");
  }

  // ===== Date helpers =====
  function todayISO() {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function parseISO(dateISO) {
    return new Date(dateISO + "T00:00:00");
  }

  function addDays(dateISO, delta) {
    const d = parseISO(dateISO);
    d.setDate(d.getDate() + delta);
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function isInRange(dateISO, startISO, endISO) {
    const t = parseISO(dateISO).getTime();
    return t >= parseISO(startISO).getTime() && t <= parseISO(endISO).getTime();
  }

  // ===== Kids management =====
  function normalizeName(s) {
    return (s || "").trim();
  }

  function addKid() {
    const input = document.getElementById("newKidInput");
    const name = normalizeName(input.value);
    if (!name) return;

    if (kids.includes(name)) {
      alert("הילד/ה כבר קיימ/ת");
      return;
    }

    kids.push(name);
    input.value = "";
    saveData();
    renderKidsUI();
    renderModes();
    renderMealOptions();
  }

  function removeKid(name) {
    if (!confirm(`למחוק את "${name}" מהרשימה?`)) return;

    kids = kids.filter(k => k !== name);

    // גם לנקות דיווחי split שכוללים את הילד הזה
    meals = meals.map(m => {
      if (!m.split) {
        return { ...m, kids: (m.kids || []).filter(k => k !== name) };
      }
      const km = { ...(m.kidMeals || {}) };
      delete km[name];
      return { ...m, kidMeals: km };
    }).filter(m => {
      if (!m.split) return (m.kids || []).length > 0; // אם לא נשאר אף ילד בדיווח רגיל -> להסיר
      return Object.keys(m.kidMeals || {}).length > 0; // אם לא נשאר אף ילד בדיווח split -> להסיר
    });

    saveData();
    renderAll();
  }

  function renderKidsUI() {
    const ul = document.getElementById("kidsList");
    ul.innerHTML = "";

    if (kids.length === 0) {
      const li = document.createElement("li");
      li.textContent = "אין ילדים ברשימה. הוסף ילד/ה.";
      ul.appendChild(li);
      return;
    }

    kids.forEach(k => {
      const li = document.createElement("li");
      li.innerHTML = `
        <span>${k}</span>
        <button type="button" onclick="removeKid('${escapeQuotes(k)}')">מחק</button>
      `;
      ul.appendChild(li);
    });
  }

  function escapeQuotes(s) {
    return String(s).replace(/'/g, "\\'");
  }

  // ===== UI helpers =====
  function toggleMode() {
    const same = document.getElementById("sameForAll").checked;
    document.getElementById("sameMode").style.display = same ? "block" : "none";
    document.getElementById("splitMode").style.display = same ? "none" : "block";
  }

  function renderModes() {
    // same mode: checkboxes for kids
    const same = document.getElementById("sameMode");
    same.innerHTML = "";

    if (kids.length === 0) {
      same.innerHTML = `<p>אין ילדים ברשימה. הוסף ילד/ה כדי לשמור דיווח.</p>`;
    } else {
      kids.forEach(k => {
        const id = `kid_cb_${k}`;
        const row = document.createElement("div");
        row.innerHTML = `<label><input type="checkbox" id="${id}" checked> ${k}</label>`;
        same.appendChild(row);
      });
    }

    // split mode: per kid meal select + suggestion
    const split = document.getElementById("splitKidsContainer");
    split.innerHTML = "";

    if (kids.length === 0) {
      split.innerHTML = `<p>אין ילדים ברשימה. הוסף ילד/ה כדי לשמור דיווח.</p>`;
      return;
    }

    kids.forEach(k => {
      const selId = `mealSel_${k}`;
      const block = document.createElement("div");
      block.style.marginBottom = "16px";
      block.innerHTML = `
        <label>${k} אכל/ה:
          <select id="${selId}"></select>
        </label>
        <button type="button" onclick="suggestMeal('${escapeQuotes(k)}')">תן רעיון ל-${k}</button>
      `;
      split.appendChild(block);
    });
  }

  function renderMealOptions() {
    // main select
    const main = document.getElementById("mealSelect");
    main.innerHTML = "";
    mealOptions.forEach(m => {
      const opt = document.createElement("option");
      opt.value = m;
      opt.textContent = m;
      main.appendChild(opt);
    });

    // split selects
    kids.forEach(k => {
      const sel = document.getElementById(`mealSel_${k}`);
      if (!sel) return;
      sel.innerHTML = "";
      mealOptions.forEach(m => {
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = m;
        sel.appendChild(opt);
      });
    });
  }

  function renderMeals() {
    const list = document.getElementById("mealList");
    list.innerHTML = "";

    meals.forEach(m => {
      const li = document.createElement("li");

      const text = m.split
        ? `${m.date} | ${m.type} | ${formatKidMeals(m.kidMeals)}`
        : `${m.date} | ${m.type} | ${m.meal} | ${(m.kids || []).join(", ")}`;

      li.innerHTML = `
        <span>${text}</span>
        <button type="button" onclick="deleteMeal('${m.id}')">מחק</button>
      `;

      list.appendChild(li);
    });
  }

  function formatKidMeals(kidMeals) {
    const entries = Object.entries(kidMeals || {});
    if (entries.length === 0) return "—";
    return entries.map(([k, meal]) => `${k}: ${meal}`).join(" | ");
  }

  // ===== Meal options =====
  function addMeal() {
    const input = document.getElementById("newMealInput");
    const value = (input.value || "").trim();
    if (!value) return;

    if (!mealOptions.includes(value)) {
      mealOptions.push(value);
      saveData();
      renderMealOptions();
    }
    input.value = "";
  }

  // ===== Save meal =====
  function saveMeal() {
    const date = document.getElementById("dateInput").value;
    const type = document.getElementById("mealType").value;

    if (!date) {
      alert("נא למלא תאריך");
      return;
    }
    if (kids.length === 0) {
      alert("אין ילדים ברשימה. הוסף ילד/ה קודם.");
      return;
    }
    if (mealOptions.length === 0) {
      alert("מאגר המנות ריק. הוסף מנה קודם.");
      return;
    }

    const sameForAll = document.getElementById("sameForAll").checked;

    if (sameForAll) {
      const meal = document.getElementById("mealSelect").value;

      const selectedKids = kids.filter(k => {
        const cb = document.getElementById(`kid_cb_${k}`);
        return cb && cb.checked;
      });

      if (!meal || selectedKids.length === 0) {
        alert("נא לבחור מנה ולסמן לפחות ילד/ה אחד/ת");
        return;
      }

      meals.push({ id: makeId(), date, type, meal, kids: selectedKids });
      saveData();
      renderMeals();
      renderWeek();
      return;
    }

    // split mode
    const kidMeals = {};
    for (const k of kids) {
      const sel = document.getElementById(`mealSel_${k}`);
      const chosen = sel ? sel.value : "";
      if (!chosen) {
        alert(`נא לבחור מנה עבור ${k}`);
        return;
      }
      kidMeals[k] = chosen;
    }

    meals.push({ id: makeId(), date, type, split: true, kidMeals });
    saveData();
    renderMeals();
    renderWeek();
  }

  // ===== Week view =====
  function shiftWeek(deltaDays) {
    const end = document.getElementById("weekEndDate");
    end.value = addDays(end.value, deltaDays);
    renderWeek();
  }

  function getWeekMeals() {
    const endISO = document.getElementById("weekEndDate").value;
    const startISO = addDays(endISO, -6);
    return meals.filter(m => isInRange(m.date, startISO, endISO));
  }

  function renderWeek() {
    const weekMeals = getWeekMeals();

    const weekList = document.getElementById("weekList");
    weekList.innerHTML = "";

    if (weekMeals.length === 0) {
      const li = document.createElement("li");
      li.textContent = "אין רישומים בשבוע הזה";
      weekList.appendChild(li);
    } else {
      weekMeals.sort((a,b) => a.date.localeCompare(b.date));
      weekMeals.forEach(m => {
        const li = document.createElement("li");

        const text = m.split
          ? `${m.date} | ${m.type} | ${formatKidMeals(m.kidMeals)}`
          : `${m.date} | ${m.type} | ${m.meal} | ${(m.kids || []).join(", ")}`;

        li.innerHTML = `
          <span>${text}</span>
          <button type="button" onclick="deleteMeal('${m.id}')">מחק</button>
        `;
        weekList.appendChild(li);
      });
    }

    // variety count (count per kid in split, once in non-split)
    const counts = new Map();
    weekMeals.forEach(m => {
      if (m.split) {
        Object.values(m.kidMeals || {}).forEach(meal => {
          counts.set(meal, (counts.get(meal) || 0) + 1);
        });
      } else {
        counts.set(m.meal, (counts.get(m.meal) || 0) + 1);
      }
    });

    const varietyList = document.getElementById("varietyList");
    varietyList.innerHTML = "";

    const entries = [...counts.entries()].sort((a,b) => b[1] - a[1] || a[0].localeCompare(b[0], "he"));

    if (entries.length === 0) {
      const li = document.createElement("li");
      li.textContent = "אין נתונים לגיוון בשבוע הזה";
      varietyList.appendChild(li);
    } else {
      entries.forEach(([meal, c]) => {
        const li = document.createElement("li");
        li.textContent = `${meal} — ${c} פעמים`;
        varietyList.appendChild(li);
      });
    }
  }

  // ===== Suggestion =====
  function suggestMeal(targetKid) {
    if (mealOptions.length === 0) {
      alert("מאגר המנות ריק. הוסף מנה קודם.");
      return;
    }

    const weekMeals = getWeekMeals();

    // count appearances in selected week
    const counts = new Map();
    weekMeals.forEach(m => {
      if (m.split) {
        Object.values(m.kidMeals || {}).forEach(meal => {
          counts.set(meal, (counts.get(meal) || 0) + 1);
        });
      } else {
        counts.set(m.meal, (counts.get(m.meal) || 0) + 1);
      }
    });

    // min count -> candidates
    let min = Infinity;
    mealOptions.forEach(opt => {
      const c = counts.get(opt) || 0;
      if (c < min) min = c;
    });

    const candidates = mealOptions.filter(opt => (counts.get(opt) || 0) === min);
    const pick = candidates[Math.floor(Math.random() * candidates.length)];

    const sameForAll = document.getElementById("sameForAll").checked;

    // If specific kid requested, set that kid select
    if (targetKid) {
      const sel = document.getElementById(`mealSel_${targetKid}`);
      if (sel) sel.value = pick;
      return;
    }

    // Top button: if same mode -> set main select. if split -> set all kids
    if (sameForAll) {
      document.getElementById("mealSelect").value = pick;
      return;
    }

    kids.forEach(k => {
      const sel = document.getElementById(`mealSel_${k}`);
      if (sel) sel.value = pick;
    });
  }

  function renderAll() {
    renderKidsUI();
    renderModes();
    toggleMode();
    renderMealOptions();
    renderMeals();
    renderWeek();
  }

  // ===== Init =====
  document.getElementById("dateInput").value = todayISO();
  document.getElementById("weekEndDate").value = todayISO();

  saveData();
  renderAll();
</script>

</body>
</html>
