<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>××¨×•×—×•×ª ×”×™×œ×“×™×</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#2563eb">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --border:#e5e7eb;
      --primary:#2563eb; --danger:#dc2626; --muted:#6b7280;
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:14px;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:#111827;
    }
    h1{margin:6px 0 14px;font-size:24px;font-weight:900}
    h2{margin:0 0 10px;font-size:18px}
    h3{margin:14px 0 6px;font-size:14px;color:var(--muted)}
    .card{
      background:var(--card); border:1px solid var(--border);
      border-radius:var(--radius); padding:14px; margin-bottom:14px;
    }
    label{display:block;font-weight:700;margin-top:8px}
    input,select{
      width:100%; padding:10px; font-size:16px;
      border-radius:10px; border:1px solid var(--border);
    }
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      padding:10px 14px; border-radius:10px; border:none;
      font-weight:800; cursor:pointer;
    }
    .primary{background:var(--primary);color:#fff}
    .danger{background:var(--danger);color:#fff}
    .ghost{background:#eef2ff;color:#1e40af}
    ul{list-style:none;padding:0;margin:10px 0 0}
    li{
      display:flex; justify-content:space-between; gap:10px;
      background:#fff; border:1px solid var(--border);
      border-radius:10px; padding:10px; margin-bottom:8px;
      align-items:center;
    }
    .btn-group{display:flex;gap:6px}
    .spacer{margin-bottom:14px}
    .note{font-size:13px;color:var(--muted);margin-top:6px}
    @media(min-width:700px){body{max-width:820px;margin:auto}}
  </style>
</head>

<body>

<h1>ğŸ½ï¸ ××¨×•×—×•×ª ×”×™×œ×“×™×</h1>

<!-- 1. ×¨×•×•×— ××ª×—×ª ×œ××™×¤×•×¡ -->
<div class="spacer">
  <button class="btn danger" onclick="resetData()">××™×¤×•×¡ × ×ª×•× ×™×</button>
</div>

<!-- ×™×œ×“×™× -->
<div class="card">
  <h2>× ×™×”×•×œ ×™×œ×“×™×</h2>
  <input id="newKidInput" placeholder="×©× ×™×œ×“/×”">
  <button class="btn primary" onclick="addKid()">×”×•×¡×£</button>
  <ul id="kidsList"></ul>
</div>

<!-- ×× ×•×ª -->
<div class="card">
  <h2>× ×™×”×•×œ ×× ×•×ª</h2>
  <input id="newMealInput" placeholder="×©× ×× ×”">
  <button class="btn primary" onclick="addMeal()">×”×•×¡×£</button>
  <ul id="mealsOptionsList"></ul>
</div>

<!-- ×¨×™×©×•× -->
<div class="card">
  <h2>×¨×™×©×•× ××¨×•×—×”</h2>

  <label>×ª××¨×™×š</label>
  <input type="date" id="dateInput">

  <label>×¡×•×’ ××¨×•×—×”</label>
  <select id="mealType">
    <option>×‘×•×§×¨</option>
    <option>×¦×”×¨×™×™×</option>
    <option selected>×¢×¨×‘</option>
    <option>×‘×™× ×™×™×</option>
  </select>

  <!-- 3. ××™ ××›×œ -->
  <label>
    <input type="checkbox" id="sameForAll" checked onchange="toggleMode()">
    ××•×ª×” ××¨×•×—×” ×œ×›×•×œ×
  </label>

  <!-- ××¦×‘ ××©×•×ª×£ -->
  <div id="sameMode">
    <label>×× ×”</label>
    <select id="mealSelect"></select>
    <button class="btn ghost" onclick="suggestMeal()">×ª×Ÿ ×œ×™ ×¨×¢×™×•×Ÿ</button>

    <h3>××™ ××›×œ?</h3>
    <div id="sameKids"></div>
  </div>

  <!-- ××¦×‘ ×¤×™×¦×•×œ -->
  <div id="splitMode" style="display:none">
    <h3>×‘×—×™×¨×” × ×¤×¨×“×ª</h3>
    <div id="splitKids"></div>
  </div>

  <button class="btn primary" onclick="saveMeal()">×©××™×¨×”</button>
</div>

<!-- ×”×™×¡×˜×•×¨×™×” -->
<div class="card">
  <h2>×”×™×¡×˜×•×¨×™×”</h2>
  <ul id="mealList"></ul>
</div>

<!-- ×©×‘×•×¢ -->
<div class="card">
  <h2>×©×‘×•×¢ ××—×¨×•×Ÿ</h2>
  <input type="date" id="weekEndDate">
  <ul id="weekList"></ul>

  <h3>×’×™×•×•×Ÿ</h3>
  <ul id="varietyList"></ul>
</div>

<script>
/* ===== PWA ===== */
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("./sw.js");
}

/* ===== DATA ===== */
const KM="meals", KK="kids", KO="mealOptions";
let meals=JSON.parse(localStorage.getItem(KM))||[];
let kids=JSON.parse(localStorage.getItem(KK))||["××™×§×”","×¢×•××¨"];
let mealOptions=JSON.parse(localStorage.getItem(KO))||[];

const save=()=>{
  localStorage.setItem(KM,JSON.stringify(meals));
  localStorage.setItem(KK,JSON.stringify(kids));
  localStorage.setItem(KO,JSON.stringify(mealOptions));
};
const uid=()=>Math.random().toString(36).slice(2);

/* ===== ×™×œ×“×™× ===== */
function addKid(){
  const v=newKidInput.value.trim();
  if(!v||kids.includes(v))return;
  kids.push(v); newKidInput.value="";
  save(); render();
}
function removeKid(k){
  if(!confirm("×œ××—×•×§?"))return;
  kids=kids.filter(x=>x!==k);
  meals=meals.filter(m=>!m.kids||m.kids.includes(k));
  save(); render();
}

/* ===== ×× ×•×ª ===== */
function addMeal(){
  const v=newMealInput.value.trim();
  if(!v||mealOptions.includes(v))return;
  mealOptions.push(v); newMealInput.value="";
  save(); render();
}
function editMeal(old){
  const n=prompt("×©× ×—×“×©:",old);
  if(!n||n===old||mealOptions.includes(n))return;
  mealOptions=mealOptions.map(m=>m===old?n:m);
  meals.forEach(m=>{
    if(m.meal===old)m.meal=n;
    if(m.split){
      Object.keys(m.kidMeals).forEach(k=>{
        if(m.kidMeals[k]===old)m.kidMeals[k]=n;
      });
    }
  });
  save(); render();
}
function deleteMealOption(m){
  if(!confirm("×œ××—×•×§ ××”×××’×¨ ×‘×œ×‘×“?"))return;
  mealOptions=mealOptions.filter(x=>x!==m);
  save(); render();
}

/* ===== ×¨×™×©×•× ===== */
function toggleMode(){
  sameMode.style.display=sameForAll.checked?"block":"none";
  splitMode.style.display=sameForAll.checked?"none":"block";
}

function saveMeal(){
  const date=dateInput.value;
  if(!date)return alert("×‘×—×¨ ×ª××¨×™×š");
  const type=mealType.value;

  if(sameForAll.checked){
    const meal=mealSelect.value;
    const selected=kids.filter(k=>document.getElementById("cb_"+k)?.checked);
    if(!meal||!selected.length)return alert("×‘×—×¨ ×× ×” ×•×™×œ×“×™×");
    meals.push({id:uid(),date,type,meal,kids:selected});
  }else{
    const kidMeals={};
    for(const k of kids){
      const v=document.getElementById("sel_"+k).value;
      if(!v)return alert("×‘×—×¨ ×× ×” ×œ×›×œ ×™×œ×“");
      kidMeals[k]=v;
    }
    meals.push({id:uid(),date,type,split:true,kidMeals});
  }
  save(); render();
}

/* ===== ×”×¦×¢×” ===== */
function suggestMeal(){
  if(!mealOptions.length)return;
  mealSelect.value=mealOptions[Math.floor(Math.random()*mealOptions.length)];
}

/* ===== ×¢×–×¨×™ ×ª××¨×™×›×™× ===== */
const iso=d=>new Date(d+"T00:00:00");
const addDays=(d,n)=>{const x=iso(d);x.setDate(x.getDate()+n);return x.toISOString().slice(0,10)};

/* ===== ×¨×™× ×“×•×¨ ===== */
function render(){
  // ×™×œ×“×™×
  kidsList.innerHTML=kids.map(k=>`
    <li><span>${k}</span>
    <button class="btn danger" onclick="removeKid('${k}')">××—×§</button></li>`).join("");

  // ×× ×•×ª
  mealsOptionsList.innerHTML=mealOptions.map(m=>`
    <li><span>${m}</span>
      <div class="btn-group">
        <button class="btn ghost" onclick="editMeal('${m}')">âœï¸</button>
        <button class="btn danger" onclick="deleteMealOption('${m}')">âŒ</button>
      </div>
    </li>`).join("");

  mealSelect.innerHTML=mealOptions.map(m=>`<option>${m}</option>`).join("");

  // ××™ ××›×œ
  sameKids.innerHTML=kids.map(k=>`
    <label><input type="checkbox" id="cb_${k}" checked> ${k}</label>`).join("<br>");

  splitKids.innerHTML=kids.map(k=>`
    <label>${k}</label>
    <select id="sel_${k}">
      ${mealOptions.map(m=>`<option>${m}</option>`).join("")}
    </select>`).join("");

  // ×”×™×¡×˜×•×¨×™×” (4)
  mealList.innerHTML=meals.map(m=>{
    if(m.split){
      return `<li>${m.date} | ${m.type} | ${
        Object.entries(m.kidMeals).map(([k,v])=>`${k}: ${v}`).join(" | ")
      }</li>`;
    }
    return `<li>${m.date} | ${m.type} | ${m.meal} | ${m.kids.join(", ")}</li>`;
  }).join("");

  // ×©×‘×•×¢ (5)
  const end=weekEndDate.value;
  const start=addDays(end,-6);
  const week=meals.filter(m=>m.date>=start&&m.date<=end);

  weekList.innerHTML=week.map(m=>{
    if(m.split){
      return `<li>${m.date} | ${Object.entries(m.kidMeals).map(([k,v])=>`${k}: ${v}`).join(" | ")}</li>`;
    }
    return `<li>${m.date} | ${m.meal} | ${m.kids.join(", ")}</li>`;
  }).join("");

  const counts={};
  week.forEach(m=>{
    if(m.split){
      Object.values(m.kidMeals).forEach(v=>counts[v]=(counts[v]||0)+1);
    }else{
      counts[m.meal]=(counts[m.meal]||0)+1;
    }
  });
  varietyList.innerHTML=Object.entries(counts)
    .map(([m,c])=>`<li>${m} â€” ${c} ×¤×¢××™×</li>`).join("");
}

/* ===== ××™×¤×•×¡ ===== */
function resetData(){
  if(!confirm("××™×¤×•×¡ ××•×—×œ×˜?"))return;
  localStorage.clear(); location.reload();
}

/* INIT */
dateInput.value=new Date().toISOString().slice(0,10);
weekEndDate.value=dateInput.value;
render();
</script>

</body>
</html>
