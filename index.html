<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>××¨×•×—×•×ª ×”×™×œ×“×™×</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#2563eb">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--border:#e5e7eb;--primary:#2563eb;--danger:#dc2626;--muted:#6b7280;--shadow:0 6px 18px rgba(0,0,0,.06);--radius:14px}
    *{box-sizing:border-box}
    body{margin:0;padding:14px;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:#111827;line-height:1.35}
    h1{margin:6px 0 14px;font-size:24px;font-weight:900}
    h2{margin:0 0 10px;font-size:18px}
    h3{margin:14px 0 6px;font-size:14px;color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;margin-bottom:14px}
    .field{margin-top:10px}
    input,select,textarea{width:100%;padding:10px 12px;font-size:16px;border-radius:10px;border:1px solid var(--border);background:#fff}
    textarea{min-height:150px;resize:vertical}
    .inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .inline input{flex:1;min-width:180px}
    .btn{padding:10px 14px;border-radius:10px;border:none;font-weight:800;cursor:pointer;white-space:nowrap}
    .primary{background:var(--primary);color:#fff}
    .danger{background:var(--danger);color:#fff}
    .ghost{background:#eef2ff;color:#1e40af}
    .iconbtn{background:#f3f4f6;color:#111827;padding:8px 10px;border-radius:10px;border:1px solid var(--border);font-weight:800;line-height:1;cursor:pointer}
    ul{list-style:none;padding:0;margin:10px 0 0}
    li{display:flex;justify-content:space-between;gap:10px;background:#fff;border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:8px;align-items:center}
    li span{flex:1}
    .btn-group{display:flex;gap:8px;align-items:center}
    .tabs{display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap}
    .tabbtn{border:1px solid var(--border);background:#fff;border-radius:999px;padding:9px 12px;font-weight:900;cursor:pointer}
    .tabbtn.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    .view{display:none}
    .view.active{display:block}
    .checks{display:flex;flex-direction:column;gap:10px;margin-top:8px}
    .checkrow{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid var(--border);border-radius:12px;background:#fff}
    .checkrow input{width:18px;height:18px;margin:0}
    .note{font-size:13px;color:var(--muted);margin-top:6px}
    .filters{display:flex;gap:8px;flex-wrap:nowrap;overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:4px;margin:8px 0 10px}
    .filter{display:flex;align-items:center;gap:6px;font-weight:900;font-size:12px;background:#fff;border:1px solid var(--border);padding:6px 8px;border-radius:999px;white-space:nowrap;flex:0 0 auto}
    .filter input{width:16px;height:16px;margin:0}
  </style>
</head>

<body>
<h1>ğŸ½ï¸ ××¨×•×—×•×ª ×”×™×œ×“×™×</h1>

<div class="tabs">
  <button class="tabbtn active" type="button" onclick="showTab('log')">×¨×™×©×•×</button>
  <button class="tabbtn" type="button" onclick="showTab('kids')">× ×™×”×•×œ ×™×œ×“×™×</button>
  <button class="tabbtn" type="button" onclick="showTab('dishes')">× ×™×”×•×œ ×× ×•×ª</button>
  <button class="tabbtn" type="button" onclick="showTab('data')">× ×ª×•× ×™×</button>
</div>

<section id="view-log" class="view active">
  <section class="card">
    <h2>×¨×™×©×•× ××¨×•×—×”</h2>
    <div class="field"><label>×ª××¨×™×š</label><input type="date" id="dateInput"></div>
    <div class="field">
      <label>×¡×•×’ ××¨×•×—×”</label>
      <select id="mealType">
        <option value="×‘×•×§×¨">×‘×•×§×¨</option>
        <option value="×¦×”×¨×™×™×">×¦×”×¨×™×™×</option>
        <option value="×¢×¨×‘" selected>×¢×¨×‘</option>
        <option value="×‘×™× ×™×™×">×‘×™× ×™×™×</option>
      </select>
    </div>
    <div class="field checkrow" style="justify-content:space-between;">
      <div style="display:flex;align-items:center;gap:10px;">
        <input type="checkbox" id="sameForAll" checked onchange="toggleMode()">
        <strong>××•×ª×” ××¨×•×—×” ×œ×›×•×œ×</strong>
      </div>
    </div>

    <div id="sameMode">
      <div class="field">
        <label>×× ×”</label>
        <div class="inline">
          <select id="mealSelect"></select>
          <button class="btn ghost" type="button" onclick="suggestMeal()">×ª×Ÿ ×œ×™ ×¨×¢×™×•×Ÿ</button>
        </div>
      </div>
      <h3>××™ ××›×œ?</h3>
      <div id="sameKids" class="checks"></div>
    </div>

    <div id="splitMode" style="display:none;">
      <h3>×‘×—×™×¨×” × ×¤×¨×“×ª ×œ×›×œ ×™×œ×“</h3>
      <div id="splitKids" class="checks"></div>
    </div>

    <div class="field">
      <button class="btn primary" type="button" onclick="saveMeal()">×©××™×¨×”</button>
    </div>

    <div class="note" id="syncStatus"></div>
  </section>
</section>

<section id="view-kids" class="view">
  <section class="card">
    <h2>× ×™×”×•×œ ×™×œ×“×™×</h2>
    <div class="inline">
      <input id="newKidInput" placeholder="×©× ×™×œ×“/×”">
      <button class="btn primary" type="button" onclick="addKid()">×”×•×¡×£</button>
    </div>
    <ul id="kidsList"></ul>
  </section>
</section>

<section id="view-dishes" class="view">
  <section class="card">
    <h2>× ×™×”×•×œ ×× ×•×ª</h2>
    <div class="inline">
      <input id="newMealInput" placeholder="×©× ×× ×”">
      <button class="btn primary" type="button" onclick="addMeal()">×”×•×¡×£</button>
    </div>
    <ul id="mealsOptionsList"></ul>
  </section>
</section>

<section id="view-data" class="view">
  <section class="card">
    <h2>×¡× ×›×¨×•×Ÿ</h2>
    <div class="note">×›×¤×ª×•×¨ ×‘×“×™×§×”: ×©×•×œ×— ××ª ×›×œ ×”× ×ª×•× ×™× ×œ×’×•×’×œ ×¢×›×©×™×•.</div>
    <button class="btn primary" type="button" onclick="forceSyncNow()">×©×œ×— ×œ×’×•×’×œ ×¢×›×©×™×•</button>
    <div class="note" id="forceResult"></div>
  </section>

  <section class="card">
    <h2>××™×¤×•×¡</h2>
    <button class="btn danger" type="button" onclick="resetData()">××™×¤×•×¡ × ×ª×•× ×™×</button>
  </section>
</section>

<script>
/* ===== Google Sync GET write ===== */
const SYNC_URL = "https://script.google.com/macros/s/AKfycby8gDkzATtKwGFqFguvvTcqZ0jC1FCADAFWw1PLoOzVAmV1UwuZiIPkC1YNhmD_4pi4/exec";
const SYNC_TOKEN = "CHANGE_ME_12345";
const DEVICE_NAME = "Yanir";

let syncTimer=null;

function setSyncMsg(msg){
  const el=document.getElementById("syncStatus");
  if(el) el.textContent = msg || "";
}

async function doSyncSend(){
  const payload = {
    meals: JSON.parse(localStorage.getItem("meals") || "[]"),
    kids: JSON.parse(localStorage.getItem("kids") || "[]"),
    mealOptions: JSON.parse(localStorage.getItem("mealOptions") || "[]")
  };
  const dataStr = JSON.stringify(payload);

  const url =
    `${SYNC_URL}?token=${encodeURIComponent(SYNC_TOKEN)}` +
    `&write=1` +
    `&by=${encodeURIComponent(DEVICE_NAME)}` +
    `&data=${encodeURIComponent(dataStr)}`;

  await fetch(url);
}

function syncSave(){
  try{
    if(syncTimer) clearTimeout(syncTimer);
    syncTimer=setTimeout(async ()=>{
      setSyncMsg("××¡× ×›×¨×Ÿ ×œ×’×•×’×œ...");
      await doSyncSend();
      setSyncMsg("×¡×•× ×›×¨×Ÿ âœ…");
    }, 450);
  }catch(e){
    console.warn(e);
    setSyncMsg("×¡× ×›×¨×•×Ÿ × ×›×©×œ âŒ");
  }
}

async function forceSyncNow(){
  const el=document.getElementById("forceResult");
  el.textContent="×©×•×œ×—...";
  try{
    await doSyncSend();
    el.textContent="× ×©×œ×— âœ…";
  }catch(e){
    console.warn(e);
    el.textContent="× ×›×©×œ âŒ";
  }
}

/* ===== App Data ===== */
const KM="meals", KK="kids", KO="mealOptions";
let meals = JSON.parse(localStorage.getItem(KM)) || [];
let kids = JSON.parse(localStorage.getItem(KK)) || ["××™×§×”","×¢×•××¨"];
let mealOptions = JSON.parse(localStorage.getItem(KO)) || [];

function save(){
  localStorage.setItem(KM, JSON.stringify(meals));
  localStorage.setItem(KK, JSON.stringify(kids));
  localStorage.setItem(KO, JSON.stringify(mealOptions));
  syncSave();
}

/* ===== UI ===== */
function showTab(key){
  document.querySelectorAll(".tabbtn").forEach(b => b.classList.remove("active"));
  document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
  const map = { log:[0,"view-log"], kids:[1,"view-kids"], dishes:[2,"view-dishes"], data:[3,"view-data"] };
  const m = map[key] || map.log;
  document.querySelectorAll(".tabbtn")[m[0]].classList.add("active");
  document.getElementById(m[1]).classList.add("active");
}

function toggleMode(){
  const same = document.getElementById("sameForAll").checked;
  document.getElementById("sameMode").style.display = same ? "block" : "none";
  document.getElementById("splitMode").style.display = same ? "none" : "block";
}

function renderSelectors(){
  const sel=document.getElementById("mealSelect");
  sel.innerHTML="";
  mealOptions.forEach(m=>{
    const o=document.createElement("option");
    o.value=m; o.textContent=m;
    sel.appendChild(o);
  });

  const sameKids=document.getElementById("sameKids");
  sameKids.innerHTML="";
  kids.forEach(k=>{
    const r=document.createElement("div");
    r.className="checkrow";
    r.innerHTML=`<input type="checkbox" id="cb_${k}" checked><div style="font-weight:800">${k}</div>`;
    sameKids.appendChild(r);
  });

  const split=document.getElementById("splitKids");
  split.innerHTML="";
  kids.forEach(k=>{
    const r=document.createElement("div");
    r.className="checkrow";
    r.innerHTML=`<div style="font-weight:900;min-width:80px">${k}</div><select id="sel_${k}"></select>`;
    const s=r.querySelector("select");
    mealOptions.forEach(m=>{
      const o=document.createElement("option");
      o.value=m;o.textContent=m;
      s.appendChild(o);
    });
    split.appendChild(r);
  });
}

function renderKids(){
  const ul=document.getElementById("kidsList");
  ul.innerHTML="";
  kids.forEach(k=>{
    const li=document.createElement("li");
    li.innerHTML=`<span>${k}</span><button class="btn danger" type="button">××—×§</button>`;
    li.querySelector("button").onclick=()=>removeKid(k);
    ul.appendChild(li);
  });
}

function renderMeals(){
  const ul=document.getElementById("mealsOptionsList");
  ul.innerHTML="";
  mealOptions.forEach(m=>{
    const li=document.createElement("li");
    li.innerHTML=`<span>${m}</span><button class="btn danger" type="button">××—×§</button>`;
    li.querySelector("button").onclick=()=>deleteMeal(m);
    ul.appendChild(li);
  });
}

function addKid(){
  const v=(newKidInput.value||"").trim();
  if(!v) return;
  kids.push(v);
  newKidInput.value="";
  save(); renderAll();
}
function removeKid(k){
  kids=kids.filter(x=>x!==k);
  save(); renderAll();
}
function addMeal(){
  const v=(newMealInput.value||"").trim();
  if(!v) return;
  mealOptions.push(v);
  newMealInput.value="";
  save(); renderAll();
}
function deleteMeal(m){
  mealOptions=mealOptions.filter(x=>x!==m);
  save(); renderAll();
}

function saveMeal(){
  const date=dateInput.value;
  const type=mealType.value;
  if(!date) return alert("×‘×—×¨ ×ª××¨×™×š");
  if(!mealOptions.length) return alert("××™×Ÿ ×× ×•×ª");
  if(!kids.length) return alert("××™×Ÿ ×™×œ×“×™×");

  if(document.getElementById("sameForAll").checked){
    const meal=mealSelect.value;
    const selectedKids=kids.filter(k=>document.getElementById("cb_"+k)?.checked);
    meals.push({id:Date.now()+"",date,type,meal,kids:selectedKids});
  }else{
    const kidMeals={};
    kids.forEach(k=>{
      kidMeals[k]=document.getElementById("sel_"+k).value;
    });
    meals.push({id:Date.now()+"",date,type,split:true,kidMeals});
  }

  save();
  setSyncMsg("× ×©××¨ âœ… (××¡× ×›×¨×Ÿ...)");
}

function suggestMeal(){
  if(!mealOptions.length) return;
  mealSelect.value = mealOptions[Math.floor(Math.random()*mealOptions.length)];
}

function resetData(){
  if(!confirm("××™×¤×•×¡ ××•×—×œ×˜?")) return;
  localStorage.clear();
  location.reload();
}

function renderAll(){
  renderSelectors();
  renderKids();
  renderMeals();
}

const today=new Date().toISOString().slice(0,10);
dateInput.value=today;
renderAll();
</script>
</body>
</html>
