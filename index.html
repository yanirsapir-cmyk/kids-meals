// ×›×™×‘×•×™ Service Worker ×‘×¡×¤××¨×™ (iOS)
const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
if (isIOS && 'serviceWorker' in navigator) {
  navigator.serviceWorker.getRegistrations().then(regs => {
    regs.forEach(r => r.unregister());
  });
}
<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>××¨×•×—×•×ª ×”×™×œ×“×™×</title>

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#2563eb">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --border:#e5e7eb;
      --primary:#2563eb; --primary2:#1d4ed8;
      --danger:#dc2626; --muted:#6b7280;
      --shadow:0 6px 18px rgba(0,0,0,0.06);
      --radius:16px;
      --pill:#f3f4f6;
      --boker:#fff7ed; --tzohor:#ecfeff; --erev:#eef2ff; --bein:#fdf2f8;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:14px;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:#111827; line-height:1.35;
    }
    h1{margin:6px 0 14px;font-size:24px;font-weight:900}
    h2{margin:0 0 10px;font-size:18px}
    h3{margin:14px 0 6px;font-size:14px;color:var(--muted)}
    .card{
      background:var(--card); border:1px solid var(--border);
      border-radius:var(--radius); box-shadow:var(--shadow);
      padding:14px; margin-bottom:14px;
    }
    .tabs{display:flex; gap:8px; margin-bottom:14px; flex-wrap:wrap;}
    .tabbtn{
      border:1px solid var(--border); background:#fff;
      border-radius:999px; padding:9px 12px; font-weight:900; cursor:pointer;
    }
    .tabbtn.active{background:var(--primary); color:#fff; border-color:var(--primary);}
    .view{display:none}
    .view.active{display:block}

    .field{margin-top:10px}
    label{font-weight:900}
    input,select,textarea{
      width:100%; padding:10px 12px; font-size:16px;
      border-radius:12px; border:1px solid var(--border);
      background:#fff;
    }
    textarea{min-height:140px; resize:vertical}

    .inline{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .inline input{flex:1; min-width:180px}

    .btn{
      padding:10px 14px; border-radius:12px; border:none;
      font-weight:900; cursor:pointer; white-space:nowrap;
    }
    .primary{background:var(--primary); color:#fff}
    .primary:hover{background:var(--primary2)}
    .danger{background:var(--danger); color:#fff}
    .ghost{background:#eef2ff; color:#1e40af; border:1px solid #c7d2fe}

    .iconbtn{
      background:#f3f4f6; color:#111827;
      padding:8px 10px; border-radius:12px; border:1px solid var(--border);
      font-weight:900; line-height:1;
      cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center;
      min-width:40px;
    }

    .note{font-size:13px;color:var(--muted);margin-top:6px}

    .checks{display:flex; flex-direction:column; gap:10px; margin-top:8px;}
    .checkrow{
      display:flex; align-items:center; gap:10px;
      padding:10px; border:1px solid var(--border);
      border-radius:14px; background:#fff;
    }
    .checkrow input{width:18px; height:18px; margin:0}

    ul{list-style:none;padding:0;margin:10px 0 0}
    li{
      display:flex; justify-content:space-between; gap:10px;
      background:#fff; border:1px solid var(--border);
      border-radius:14px; padding:10px; margin-bottom:8px;
      align-items:center;
    }
    li span{flex:1; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
    .btn-group{display:flex; gap:8px; align-items:center; flex:0 0 auto}

    .filters{
      display:flex; gap:8px; flex-wrap:nowrap; overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      padding-bottom:4px; margin:8px 0 10px;
    }
    .filter{
      display:flex; align-items:center; gap:6px;
      font-weight:900; font-size:12px;
      background:#fff; border:1px solid var(--border);
      padding:6px 8px; border-radius:999px;
      white-space:nowrap; flex:0 0 auto;
    }
    .filter input{width:16px;height:16px;margin:0}

    .daycard{
      border:1px solid var(--border);
      background:#fff;
      border-radius:18px;
      padding:10px;
      margin-bottom:10px;
      overflow:hidden;
    }
    .dayheader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:6px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:13px;
      border:1px solid var(--border);
      white-space:nowrap;
      background:var(--pill);
    }
    .typepill{border:none; min-width:78px;}
    .type-boker{background:var(--boker)}
    .type-tzohor{background:var(--tzohor)}
    .type-erev{background:var(--erev)}
    .type-bein{background:var(--bein)}

    .entry{
      border:1px solid var(--border);
      border-radius:16px;
      padding:8px;
      margin-bottom:8px;
      background:#fff;
    }
    .entry-top{
      display:flex; align-items:center; justify-content:space-between;
      gap:8px; margin-bottom:6px;
    }
    .actionrow{display:flex; gap:8px; align-items:center; flex:0 0 auto;}
    .delbtn{
      min-width:62px;
      border:1px solid var(--border);
      background:#fff;
      border-radius:12px;
      padding:6px 10px;
      cursor:pointer;
      font-weight:900;
      white-space:nowrap;
    }
    .entry-bottom{font-size:13px; font-weight:900}
    .bottom-normal{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .mealtext{
      flex:1; min-width:0;
      text-align:right;
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
      font-weight:900;
    }
    .kidstext{
      flex:1; min-width:0;
      text-align:left;
      font-weight:900;
      color:#374151;
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }

    .splitlist{display:flex; flex-direction:column; gap:4px;}
    .splitline{
      display:flex; justify-content:space-between; gap:10px;
      border:1px dashed var(--border);
      border-radius:12px;
      padding:6px 8px;
      background:#fafafa;
      font-size:13px;
    }
    .splitkid{font-weight:900; white-space:nowrap; flex:0 0 auto;}
    .splitmeal{
      font-weight:900; color:#374151;
      min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
      text-align:left; flex:1;
    }

    .kv{display:flex; justify-content:space-between; gap:10px; padding:6px 0; border-bottom:1px dashed var(--border);}
    .kv:last-child{border-bottom:none}
    .kv b{white-space:nowrap}
    .kv span{min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; text-align:left; color:#374151; font-weight:900;}

    .modal-backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,0.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      z-index:9999;
    }
    .modal{
      width:100%;
      max-width:720px;
      background:#fff;
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:0 16px 50px rgba(0,0,0,0.2);
      padding:14px;
    }
    .modal-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .modal-title{font-weight:900;font-size:18px}
    .modal-actions{display:flex;gap:10px;flex-wrap:wrap}
    .tiny{
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#f3f4f6;
      font-weight:900;
      cursor:pointer;
      white-space:nowrap;
    }
    .warn{color:var(--danger); font-size:13px; margin-top:8px; display:none;}

    @media(min-width:700px){ body{max-width:860px;margin:auto} }
  </style>
</head>

<body>
<h1>ğŸ½ï¸ ××¨×•×—×•×ª ×”×™×œ×“×™×</h1>

<div class="tabs">
  <button class="tabbtn active" type="button" onclick="showTab('log')">×¨×™×©×•×</button>
  <button class="tabbtn" type="button" onclick="showTab('kids')">× ×™×”×•×œ ×™×œ×“×™×</button>
  <button class="tabbtn" type="button" onclick="showTab('dishes')">× ×™×”×•×œ ×× ×•×ª</button>
  <button class="tabbtn" type="button" onclick="showTab('data')">× ×ª×•× ×™×</button>
</div>

<section id="view-log" class="view active">
  <section class="card">
    <h2>×¨×™×©×•× ××¨×•×—×”</h2>

    <div class="field">
      <label>×ª××¨×™×š</label>
      <input type="date" id="dateInput">
    </div>

    <div class="field">
      <label>×¡×•×’ ××¨×•×—×”</label>
      <select id="mealType" onchange="renderLogSelectors()">
        <option value="×‘×•×§×¨">×‘×•×§×¨</option>
        <option value="×¦×”×¨×™×™×">×¦×”×¨×™×™×</option>
        <option value="×¢×¨×‘" selected>×¢×¨×‘</option>
        <option value="×‘×™× ×™×™×">×‘×™× ×™×™×</option>
      </select>
    </div>

    <div class="field checkrow" style="justify-content:space-between;">
      <div style="display:flex;align-items:center;gap:10px;">
        <input type="checkbox" id="sameForAll" checked onchange="toggleMode()">
        <strong>××•×ª×” ××¨×•×—×” ×œ×›×•×œ×</strong>
      </div>
    </div>

    <div id="sameMode">
      <div class="field">
        <label>×× ×”</label>
        <div class="inline">
          <select id="mealSelect"></select>
          <button class="btn ghost" type="button" onclick="suggestMeal()">×ª×Ÿ ×œ×™ ×¨×¢×™×•×Ÿ</button>
        </div>
        <div class="note">×”×‘×—×™×¨×” ××¡×•× × ×ª ×œ×¤×™ ×¡×•×’ ×”××¨×•×—×” (×× ×”×’×“×¨×ª ×œ×× ×” ×¡×•×’×™×).</div>
      </div>

      <h3>××™ ××›×œ?</h3>
      <div id="sameKids" class="checks"></div>
    </div>

    <div id="splitMode" style="display:none;">
      <h3>×‘×—×™×¨×” × ×¤×¨×“×ª ×œ×›×œ ×™×œ×“</h3>
      <div id="splitKids" class="checks"></div>
      <div class="note">×‘××¦×‘ ××¤×•×¦×œ: ×œ×›×œ ×™×œ×“ ×‘×•×—×¨×™× ×× ×”.</div>
    </div>

    <div class="field">
      <button class="btn primary" type="button" onclick="saveMeal()">×©××™×¨×”</button>
    </div>

    <div class="note" id="syncStatus"></div>
  </section>

  <section class="card">
    <h2>ğŸ’¡ ×”×™×“×¢×ª?</h2>

    <h3>3 ×× ×•×ª ×©×”×•×›× ×• ×”×›×™ ××¢×˜ (×¨×§ ×× ×•×ª ×©× ×•×¦×¨×• ×œ×¤× ×™ ×—×•×“×©+)</h3>
    <div id="statsLeast"></div>

    <h3>3 ×× ×•×ª ×©×”×›× ×ª×™ ×”×›×™ ××–××Ÿ</h3>
    <div id="statsOldest"></div>
  </section>
</section>

<section id="view-kids" class="view">
  <section class="card">
    <h2>× ×™×”×•×œ ×™×œ×“×™×</h2>
    <div class="inline">
      <input id="newKidInput" placeholder="×©× ×™×œ×“/×”">
      <button class="btn primary" type="button" onclick="addKid()">×”×•×¡×£</button>
    </div>
    <ul id="kidsList"></ul>
  </section>
</section>

<section id="view-dishes" class="view">
  <section class="card">
    <h2>× ×™×”×•×œ ×× ×•×ª</h2>
    <div class="inline">
      <input id="newDishInput" placeholder="×©× ×× ×”">
      <button class="btn primary" type="button" onclick="addDish()">×”×•×¡×£</button>
    </div>
    <div class="note">××—×™×§×” ×›××Ÿ ××¡×™×¨×” ××”×××’×¨ ×‘×œ×‘×“ (×œ× ××•×—×§×ª ×”×™×¡×˜×•×¨×™×”).</div>
    <ul id="dishesList"></ul>
  </section>
</section>

<section id="view-data" class="view">
  <section class="card">
    <h2>×”×™×¡×˜×•×¨×™×”</h2>
    <div class="note">×‘×¨×™×¨×ª ××—×“×œ: ×”×›×•×œ ××•×¦×’. ××¡× × ×™× ×¨×§ ×× ××¡×× ×™×.</div>

    <div class="note" style="margin-top:10px;">×¡×™× ×•×Ÿ ×œ×¤×™ ×™×œ×“×™× (××•×¤×¦×™×•× ×œ×™)</div>
    <div id="kidFilters" class="filters"></div>

    <div class="note" style="margin-top:6px;">×¡×™× ×•×Ÿ ×œ×¤×™ ×¡×•×’ ××¨×•×—×”</div>
    <div class="filters" id="typeFilters">
      <label class="filter"><input type="checkbox" value="×‘×•×§×¨" checked onchange="renderData()"> ×‘×•×§×¨</label>
      <label class="filter"><input type="checkbox" value="×¦×”×¨×™×™×" checked onchange="renderData()"> ×¦×”×¨×™×™×</label>
      <label class="filter"><input type="checkbox" value="×¢×¨×‘" checked onchange="renderData()"> ×¢×¨×‘</label>
      <label class="filter"><input type="checkbox" value="×‘×™× ×™×™×" checked onchange="renderData()"> ×‘×™× ×™×™×</label>
    </div>

    <div id="historyWrap"></div>
  </section>

  <section class="card">
    <h2>×©×‘×•×¢ ××—×¨×•×Ÿ</h2>
    <label>×ª××¨×™×š ×¡×™×•× ×©×‘×•×¢ (×›×•×œ×œ)</label>
    <input type="date" id="weekEndDate" onchange="renderData()">

    <div id="weekWrap" style="margin-top:10px;"></div>

    <h3>×’×™×•×•×Ÿ (×›××” ×¤×¢××™× ×›×œ ×× ×” ×‘×©×‘×•×¢)</h3>
    <ul id="varietyList"></ul>
  </section>

  <section class="card">
    <h2>×›×œ×™ ×‘×“×™×§×”</h2>
    <div class="note">××•×—×§ ×¨×§ ××ª ×”×”×™×¡×˜×•×¨×™×” (×¨×™×©×•××™ ××¨×•×—×•×ª). ×œ× ××•×—×§ ×™×œ×“×™×/×× ×•×ª/××ª×›×•× ×™×.</div>
    <button class="btn danger" type="button" onclick="clearHistoryOnly()">××—×§ ×”×™×¡×˜×•×¨×™×”</button>
  </section>

  <section class="card">
    <h2>××™×¤×•×¡ × ×ª×•× ×™×</h2>
    <div class="note">×–×” ××•×—×§ ×”×›×œ ××”××›×©×™×¨ (×™×œ×“×™×/×× ×•×ª/×”×™×¡×˜×•×¨×™×”/××ª×›×•× ×™×).</div>
    <button class="btn danger" type="button" onclick="resetAll()">××™×¤×•×¡ ××œ×</button>
  </section>
</section>

<!-- Recipe Modal -->
<div id="recipeBackdrop" class="modal-backdrop" onclick="closeRecipeModal(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title" id="recipeTitle">××ª×›×•×Ÿ</div>
      <div class="modal-actions">
        <button class="tiny" type="button" onclick="saveRecipe()">×©××™×¨×”</button>
        <button class="tiny" type="button" onclick="hideRecipeModal()">×¡×’×•×¨</button>
      </div>
    </div>

    <div class="field">
      <label>×§×™×©×•×¨ (××•×¤×¦×™×•× ×œ×™)</label>
      <div class="inline">
        <input id="recipeUrlInput" placeholder="https://...">
        <button class="tiny" type="button" onclick="pasteUrl()">×”×“×‘×§ ×§×™×©×•×¨</button>
        <button class="tiny" type="button" onclick="openRecipeLink()">×¤×ª×— ×§×™×©×•×¨</button>
      </div>
    </div>

    <div class="field">
      <label>××ª×›×•×Ÿ</label>
      <div class="inline">
        <button class="tiny" type="button" onclick="pasteRecipe()">×”×“×‘×§ ××ª×›×•×Ÿ</button>
      </div>
      <textarea id="recipeTextInput" placeholder="×”×“×‘×§/×›×ª×•×‘ ×›××Ÿ ××ª ×”××ª×›×•×Ÿ..."></textarea>
      <div id="pasteWarn" class="warn">×× ×”×”×“×‘×§×” ×”××•×˜×•××˜×™×ª ×œ× ×¢×•×‘×“×ª â€” ×”×“×‘×§ ×™×“× ×™×ª (×œ×—×™×¦×” ××¨×•×›×” â†’ Paste).</div>
    </div>

    <div class="field">
      <label>×¡×•×’×™ ××¨×•×—×•×ª ×œ×× ×” ×”×–×•</label>
      <div class="checks" id="recipeTypeChecks"></div>
      <div class="note">×× ×œ× ××¡×× ×™× ×›×œ×•× â€” ×”×× ×” ×ª×•×¤×™×¢ ×‘×›×œ ×¡×•×’×™ ×”××¨×•×—×•×ª.</div>
    </div>
  </div>
</div>

<!-- Edit Report Modal -->
<div id="editBackdrop" class="modal-backdrop" onclick="closeEditModal(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title">âœï¸ ×¢×¨×™×›×ª ×“×™×•×•×—</div>
      <div class="modal-actions">
        <button class="tiny" type="button" onclick="saveEditedReport()">×©××™×¨×”</button>
        <button class="tiny" type="button" onclick="hideEditModal()">×¡×’×•×¨</button>
      </div>
    </div>

    <div class="field">
      <label>×ª××¨×™×š</label>
      <input type="date" id="editDate">
    </div>

    <div class="field">
      <label>×¡×•×’ ××¨×•×—×”</label>
      <select id="editType">
        <option value="×‘×•×§×¨">×‘×•×§×¨</option>
        <option value="×¦×”×¨×™×™×">×¦×”×¨×™×™×</option>
        <option value="×¢×¨×‘">×¢×¨×‘</option>
        <option value="×‘×™× ×™×™×">×‘×™× ×™×™×</option>
      </select>
    </div>

    <div class="field checkrow" style="justify-content:space-between;">
      <div style="display:flex;align-items:center;gap:10px;">
        <input type="checkbox" id="editSame" onchange="toggleEditMode()">
        <strong>××•×ª×” ××¨×•×—×” ×œ×›×•×œ×</strong>
      </div>
    </div>

    <div id="editSameMode">
      <div class="field">
        <label>×× ×”</label>
        <select id="editMealSelect"></select>
      </div>

      <h3>××™ ××›×œ?</h3>
      <div id="editKidsChecks" class="checks"></div>
    </div>

    <div id="editSplitMode" style="display:none;">
      <h3>×‘×—×™×¨×” × ×¤×¨×“×ª ×œ×›×œ ×™×œ×“</h3>
      <div id="editSplitKids" class="checks"></div>
      <div class="note">×‘××¦×‘ ××¤×•×¦×œ: ×¡××Ÿ ×¨×§ ×™×œ×“×™× ×©×¨×œ×•×•× ×˜×™×™× ×œ×“×™×•×•×— ×”×–×”.</div>
    </div>
  </div>
</div>

<script>
/* =========================
   Google Sync (GET write)
   ========================= */
const SYNC_URL = "https://script.google.com/macros/s/AKfycby8gDkzATtKwGFqFguvvTcqZ0jC1FCADAFWw1PLoOzVAmV1UwuZiIPkC1YNhmD_4pi4/exec";
const SYNC_TOKEN = "CHANGE_ME_12345";
const DEVICE_NAME = "Yanir"; // ×‘××›×©×™×¨ ×©×œ ××©×ª×š ×ª×©× ×” ×œ-"Wife"

function localHasAnyData(){
  try{
    const kids = JSON.parse(localStorage.getItem("kids") || "[]");
    const dishes = JSON.parse(localStorage.getItem("dishes") || "[]");
    const logs = JSON.parse(localStorage.getItem("logs") || "[]");
    return kids.length || dishes.length || logs.length;
  } catch { return false; }
}

function setSyncMsg(msg){
  const el = document.getElementById("syncStatus");
  if(el) el.textContent = msg || "";
}

let syncTimer = null;

async function doSyncSend(){
  const payload = {
    kids: JSON.parse(localStorage.getItem("kids") || "[]"),
    dishes: JSON.parse(localStorage.getItem("dishes") || "[]"),
    logs: JSON.parse(localStorage.getItem("logs") || "[]")
  };
  const dataStr = JSON.stringify(payload);

  const url =
    `${SYNC_URL}?token=${encodeURIComponent(SYNC_TOKEN)}` +
    `&write=1` +
    `&by=${encodeURIComponent(DEVICE_NAME)}` +
    `&data=${encodeURIComponent(dataStr)}`;

  await fetch(url);
}

function syncSave(){
  try{
    if(syncTimer) clearTimeout(syncTimer);
    syncTimer = setTimeout(async ()=>{
      setSyncMsg("××¡× ×›×¨×Ÿ...");
      await doSyncSend();
      setSyncMsg("×¡×•× ×›×¨×Ÿ âœ…");
    }, 500);
  }catch(e){
    console.warn("syncSave failed", e);
    setSyncMsg("×¡× ×›×¨×•×Ÿ × ×›×©×œ âŒ");
  }
}

async function syncLoad(){
  try{
    // Yanir ×ª××™×“ ×× ×¦×—: ×œ× × ×“×¨×•×¡ ×œ×• ×œ×•×§××œ ×× ×™×© ×œ×• ×“××˜×
    if(DEVICE_NAME === "Yanir" && localHasAnyData()) return;

    const res = await fetch(`${SYNC_URL}?token=${encodeURIComponent(SYNC_TOKEN)}`);
    const j = await res.json();
    if(!j.ok || !j.data) return;

    const remote = JSON.parse(j.data);

    localStorage.setItem("kids", JSON.stringify(remote.kids || []));
    localStorage.setItem("dishes", JSON.stringify(remote.dishes || []));
    localStorage.setItem("logs", JSON.stringify(remote.logs || []));

    location.reload();
  } catch(e){
    console.warn("syncLoad failed", e);
  }
}

/* =========================
   App data
   ========================= */
const KIDS_KEY = "kids";
const DISHES_KEY = "dishes";
const LOGS_KEY = "logs";

const DAY = 24*60*60*1000;
const MONTH_30 = 30*DAY;

const TYPES = ["×‘×•×§×¨","×¦×”×¨×™×™×","×¢×¨×‘","×‘×™× ×™×™×"];

function uid(){ return "r_" + Math.random().toString(16).slice(2) + "_" + Date.now(); }
function todayISO(){ return new Date().toISOString().slice(0,10); }
function isoDateMs(d){ return new Date(d + "T00:00:00").getTime(); }
function addDays(dateISO, n){
  const x = new Date(dateISO + "T00:00:00");
  x.setDate(x.getDate() + n);
  return x.toISOString().slice(0,10);
}

let kids = JSON.parse(localStorage.getItem(KIDS_KEY)) || ["××™×§×”","×¢×•××¨"];
let dishes = normalizeDishes(JSON.parse(localStorage.getItem(DISHES_KEY)));
let logs = JSON.parse(localStorage.getItem(LOGS_KEY)) || [];

function normalizeDishes(raw){
  if(!raw) return [];
  if(Array.isArray(raw) && raw.length && typeof raw[0] === "string"){
    const oldCreated = Date.now() - 60*DAY;
    return raw.map(name => ({
      dish: String(name).trim(),
      createdAt: oldCreated,
      recipeText: "",
      recipeUrl: "",
      types: [...TYPES]
    })).filter(x => x.dish);
  }
  if(Array.isArray(raw)){
    return raw.map(o => ({
      dish: String(o?.dish ?? "").trim(),
      createdAt: Number(o?.createdAt) || (Date.now() - 60*DAY),
      recipeText: String(o?.recipeText ?? ""),
      recipeUrl: String(o?.recipeUrl ?? ""),
      types: Array.isArray(o?.types) ? o.types.filter(t=>TYPES.includes(t)) : [...TYPES]
    })).filter(x => x.dish);
  }
  return [];
}

function saveAll(){
  localStorage.setItem(KIDS_KEY, JSON.stringify(kids));
  localStorage.setItem(DISHES_KEY, JSON.stringify(dishes));
  localStorage.setItem(LOGS_KEY, JSON.stringify(logs));
  syncSave();
}

/* =========================
   Tabs
   ========================= */
function showTab(key){
  document.querySelectorAll(".tabbtn").forEach(b => b.classList.remove("active"));
  document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
  const map = { log:[0,"view-log"], kids:[1,"view-kids"], dishes:[2,"view-dishes"], data:[3,"view-data"] };
  const m = map[key] || map.log;
  document.querySelectorAll(".tabbtn")[m[0]].classList.add("active");
  document.getElementById(m[1]).classList.add("active");
}

/* =========================
   UI helpers
   ========================= */
function typeClass(t){
  if(t==="×‘×•×§×¨") return "type-boker";
  if(t==="×¦×”×¨×™×™×") return "type-tzohor";
  if(t==="×¢×¨×‘") return "type-erev";
  return "type-bein";
}
function dishHasRecipe(d){
  const t = (d.recipeText||"").trim();
  const u = (d.recipeUrl||"").trim();
  return t.length>0 || u.length>0;
}
function getDishByName(name){
  return dishes.find(d => d.dish === name) || null;
}
function dishAllowedForType(dishName, mealType){
  const d = getDishByName(dishName);
  if(!d) return false;
  const types = d.types && d.types.length ? d.types : TYPES;
  return types.includes(mealType);
}
function getDishesForType(mealType){
  const arr = dishes.map(d => d.dish).filter(name => dishAllowedForType(name, mealType));
  return arr.length ? arr : dishes.map(d => d.dish);
}

/* =========================
   Render: kids & dishes
   ========================= */
function renderKids(){
  const ul = document.getElementById("kidsList");
  ul.innerHTML = "";
  kids.forEach(k => {
    const row = document.createElement("li");
    row.innerHTML = `
      <span>${k}</span>
      <div class="btn-group">
        <button class="iconbtn" type="button" title="××—×§">âŒ</button>
      </div>
    `;
    row.querySelector("button").onclick = () => removeKid(k);
    ul.appendChild(row);
  });
}

function renderDishes(){
  const ul = document.getElementById("dishesList");
  ul.innerHTML = "";
  const sorted = [...dishes].sort((a,b)=>a.dish.localeCompare(b.dish,"he"));
  sorted.forEach(d => {
    const mark = dishHasRecipe(d) ? " âœ…" : "";
    const row = document.createElement("li");
    row.innerHTML = `
      <span>${d.dish}${mark}</span>
      <div class="btn-group">
        <button class="iconbtn" type="button" title="××ª×›×•×Ÿ">ğŸ“–</button>
        <button class="iconbtn" type="button" title="×¢×¨×•×š ×©×">âœï¸</button>
        <button class="iconbtn" type="button" title="××—×§ ××”×××’×¨">âŒ</button>
      </div>
    `;
    const [btnRecipe, btnEdit, btnDel] = row.querySelectorAll("button");
    btnRecipe.onclick = () => openRecipeModal(d.dish);
    btnEdit.onclick = () => editDishName(d.dish);
    btnDel.onclick = () => deleteDish(d.dish);
    ul.appendChild(row);
  });
}

/* =========================
   Render: log selectors
   ========================= */
function toggleMode(){
  const same = document.getElementById("sameForAll").checked;
  document.getElementById("sameMode").style.display = same ? "block" : "none";
  document.getElementById("splitMode").style.display = same ? "none" : "block";
}

function renderLogSelectors(){
  const type = document.getElementById("mealType").value;
  const available = getDishesForType(type);

  const sel = document.getElementById("mealSelect");
  const current = sel.value;
  sel.innerHTML = "";
  available.forEach(name => {
    const o = document.createElement("option");
    o.value = name; o.textContent = name;
    sel.appendChild(o);
  });
  if(current && available.includes(current)) sel.value = current;

  const sameKids = document.getElementById("sameKids");
  sameKids.innerHTML = "";
  kids.forEach(k => {
    const row = document.createElement("div");
    row.className = "checkrow";
    row.innerHTML = `<input type="checkbox" id="cb_${cssSafe(k)}" checked><div style="font-weight:900;">${escapeHtml(k)}</div>`;
    sameKids.appendChild(row);
  });

  const splitKids = document.getElementById("splitKids");
  splitKids.innerHTML = "";
  kids.forEach(k => {
    const row = document.createElement("div");
    row.className = "checkrow";
    row.innerHTML = `<div style="font-weight:900; min-width:90px;">${escapeHtml(k)}</div><select id="sel_${cssSafe(k)}"></select>`;
    const s = row.querySelector("select");
    available.forEach(name => {
      const o = document.createElement("option");
      o.value = name; o.textContent = name;
      s.appendChild(o);
    });
    splitKids.appendChild(row);
  });

  renderKidFilters();
}

/* =========================
   Kids CRUD
   ========================= */
function addKid(){
  const v = (document.getElementById("newKidInput").value || "").trim();
  if(!v) return;
  if(kids.includes(v)) return alert("×”×™×œ×“/×” ×›×‘×¨ ×§×™×™×/×ª");
  kids.push(v);
  document.getElementById("newKidInput").value = "";
  saveAll();
  renderAll();
}
function removeKid(name){
  if(!confirm(`×œ××—×•×§ ××ª "${name}"?`)) return;
  kids = kids.filter(k => k !== name);

  logs = logs.map(r => {
    if(r.same){
      return {...r, kids: (r.kids||[]).filter(k => k !== name)};
    } else {
      const km = {...(r.kidMeals||{})};
      delete km[name];
      return {...r, kidMeals: km};
    }
  }).filter(r => {
    if(r.same) return (r.kids||[]).length>0;
    return Object.keys(r.kidMeals||{}).length>0;
  });

  saveAll();
  renderAll();
}

/* =========================
   Dishes CRUD
   ========================= */
function addDish(){
  const v = (document.getElementById("newDishInput").value || "").trim();
  if(!v) return;
  if(dishes.some(d => d.dish === v)) return alert("×”×× ×” ×›×‘×¨ ×§×™×™××ª");
  dishes.push({
    dish: v,
    createdAt: Date.now(),
    recipeText: "",
    recipeUrl: "",
    types: [...TYPES]
  });
  document.getElementById("newDishInput").value = "";
  saveAll();
  renderAll();
}

function editDishName(oldName){
  const next = (prompt("×©× ×—×“×© ×œ×× ×”:", oldName) || "").trim();
  if(!next) return;
  if(next === oldName) return;
  if(dishes.some(d => d.dish === next)) return alert("×›×‘×¨ ×§×™×™××ª ×× ×” ×‘×©× ×”×–×”");

  dishes = dishes.map(d => d.dish === oldName ? {...d, dish: next} : d);

  logs = logs.map(r => {
    if(r.same){
      return r.meal === oldName ? {...r, meal: next} : r;
    } else {
      const km = {...(r.kidMeals||{})};
      Object.keys(km).forEach(k => { if(km[k] === oldName) km[k] = next; });
      return {...r, kidMeals: km};
    }
  });

  saveAll();
  renderAll();
}

function deleteDish(name){
  if(!confirm(`×œ××—×•×§ ××ª "${name}" ××”×××’×¨ ×‘×œ×‘×“? (×”×™×¡×˜×•×¨×™×” ×œ× ×ª×™××—×§)`)) return;
  dishes = dishes.filter(d => d.dish !== name);
  saveAll();
  renderAll();
}

/* =========================
   Save meal (log)
   ========================= */
function saveMeal(){
  if(!dishes.length) return alert("××™×Ÿ ×× ×•×ª ×‘×××’×¨. ×”×•×¡×£ ×× ×” ×§×•×“×.");
  if(!kids.length) return alert("××™×Ÿ ×™×œ×“×™×. ×”×•×¡×£ ×™×œ×“/×” ×§×•×“×.");

  const date = document.getElementById("dateInput").value;
  const type = document.getElementById("mealType").value;
  if(!date) return alert("×‘×—×¨ ×ª××¨×™×š");

  const createdAt = Date.now();

  if(document.getElementById("sameForAll").checked){
    const meal = document.getElementById("mealSelect").value;
    const selectedKids = kids.filter(k => document.getElementById("cb_"+cssSafe(k))?.checked);
    if(!meal) return alert("×‘×—×¨ ×× ×”");
    if(!selectedKids.length) return alert("×¡××Ÿ ×œ×¤×—×•×ª ×™×œ×“/×” ××—×“/×ª");
    logs.push({ id: uid(), createdAt, date, type, same:true, meal, kids: selectedKids });
  }else{
    const km = {};
    for(const k of kids){
      const sel = document.getElementById("sel_"+cssSafe(k));
      const val = sel ? sel.value : "";
      if(!val) return alert(`×‘×—×¨ ×× ×” ×¢×‘×•×¨ ${k}`);
      km[k] = val;
    }
    logs.push({ id: uid(), createdAt, date, type, same:false, kidMeals: km });
  }

  saveAll();
  renderAll();
}

function suggestMeal(){
  if(!dishes.length) return;
  const end = document.getElementById("weekEndDate").value || document.getElementById("dateInput").value;
  if(!end) return;
  const start = addDays(end, -6);

  const type = document.getElementById("mealType").value;
  const candidates = getDishesForType(type);
  if(!candidates.length) return;

  const week = logs.filter(r => r.date >= start && r.date <= end && r.type === type);

  const counts = new Map();
  week.forEach(r => {
    if(r.same){
      counts.set(r.meal, (counts.get(r.meal)||0) + 1);
    } else {
      Object.values(r.kidMeals||{}).forEach(m => counts.set(m, (counts.get(m)||0) + 1));
    }
  });

  let min = Infinity;
  candidates.forEach(m => { min = Math.min(min, counts.get(m)||0); });
  const mins = candidates.filter(m => (counts.get(m)||0) === min);
  document.getElementById("mealSelect").value = mins[Math.floor(Math.random()*mins.length)];
}

/* =========================
   Data tab render
   ========================= */
let kidFilterBuiltFor = "";
function renderKidFilters(){
  const signature = kids.join("|");
  if(signature === kidFilterBuiltFor) return;
  const host = document.getElementById("kidFilters");
  host.innerHTML = "";
  kids.forEach(k => {
    const lab = document.createElement("label");
    lab.className = "filter";
    lab.innerHTML = `<input type="checkbox" value="${escapeHtml(k)}" onchange="renderData()"> ${escapeHtml(k)}`;
    host.appendChild(lab);
  });
  kidFilterBuiltFor = signature;
}

function getActiveTypes(){
  const checked = Array.from(document.querySelectorAll("#typeFilters input:checked")).map(x=>x.value);
  return checked.length ? checked : [...TYPES];
}
function getActiveKids(){
  return Array.from(document.querySelectorAll("#kidFilters input:checked")).map(x=>x.value);
}
function recordKidsList(r){
  if(r.same) return r.kids || [];
  return Object.keys(r.kidMeals||{});
}
function recordMatchesKids(r, activeKids){
  if(!activeKids.length) return true;
  const rk = recordKidsList(r);
  return rk.some(k => activeKids.includes(k));
}

function groupByDate(items){
  const map = new Map();
  items.forEach(r => {
    const d = r.date || "";
    if(!map.has(d)) map.set(d, []);
    map.get(d).push(r);
  });
  const dates = [...map.keys()].sort((a,b)=>b.localeCompare(a));
  return dates.map(d => ({
    date: d,
    items: map.get(d).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0))
  }));
}

function createEntry(r){
  const entry = document.createElement("div");
  entry.className = "entry";

  const top = document.createElement("div");
  top.className = "entry-top";

  const typeP = document.createElement("span");
  typeP.className = "pill typepill " + typeClass(r.type);
  typeP.textContent = r.type || "";

  const actions = document.createElement("div");
  actions.className = "actionrow";

  const editBtn = document.createElement("button");
  editBtn.className = "iconbtn";
  editBtn.type = "button";
  editBtn.title = "×¢×¨×•×š";
  editBtn.textContent = "âœï¸";
  editBtn.onclick = () => openEditModal(r.id);

  const del = document.createElement("button");
  del.className = "delbtn";
  del.type = "button";
  del.textContent = "××—×§";
  del.onclick = () => deleteReport(r.id);

  actions.appendChild(editBtn);
  actions.appendChild(del);

  top.appendChild(typeP);
  top.appendChild(actions);

  const bottom = document.createElement("div");
  bottom.className = "entry-bottom";

  if(r.same){
    const wrap = document.createElement("div");
    wrap.className = "bottom-normal";

    const meal = document.createElement("div");
    meal.className = "mealtext";
    meal.textContent = r.meal || "";

    const kidsT = document.createElement("div");
    kidsT.className = "kidstext";
    kidsT.textContent = (r.kids||[]).join(", ");

    wrap.appendChild(meal);
    wrap.appendChild(kidsT);
    bottom.appendChild(wrap);
  } else {
    const list = document.createElement("div");
    list.className = "splitlist";
    const km = r.kidMeals || {};
    Object.keys(km).forEach(k => {
      const line = document.createElement("div");
      line.className = "splitline";
      line.innerHTML = `<div class="splitkid">${escapeHtml(k)}:</div><div class="splitmeal">${escapeHtml(km[k])}</div>`;
      list.appendChild(line);
    });
    bottom.appendChild(list);
  }

  entry.appendChild(top);
  entry.appendChild(bottom);
  return entry;
}

function renderGrouped(container, items){
  container.innerHTML = "";
  const groups = groupByDate(items);
  if(!groups.length){
    const empty = document.createElement("div");
    empty.className = "note";
    empty.textContent = "××™×Ÿ ×¨×™×©×•××™× ×œ×”×¦×’×”.";
    container.appendChild(empty);
    return;
  }
  groups.forEach(g => {
    const day = document.createElement("div");
    day.className = "daycard";

    const head = document.createElement("div");
    head.className = "dayheader";
    const dateP = document.createElement("span");
    dateP.className = "pill";
    dateP.textContent = g.date;

    head.appendChild(dateP);
    day.appendChild(head);

    g.items.forEach(r => day.appendChild(createEntry(r)));
    container.appendChild(day);
  });
}

function renderData(){
  renderKidFilters();

  const types = getActiveTypes();
  const activeKids = getActiveKids();

  const all = logs
    .filter(r => types.includes(r.type))
    .filter(r => recordMatchesKids(r, activeKids))
    .sort((a,b)=> (b.date||"").localeCompare(a.date||"") || (b.createdAt||0)-(a.createdAt||0));

  renderGrouped(document.getElementById("historyWrap"), all);

  const end = document.getElementById("weekEndDate").value || document.getElementById("dateInput").value;
  if(!end){
    document.getElementById("weekWrap").innerHTML = "";
    document.getElementById("varietyList").innerHTML = "";
    return;
  }
  const start = addDays(end, -6);

  const week = logs
    .filter(r => r.date >= start && r.date <= end)
    .filter(r => types.includes(r.type))
    .filter(r => recordMatchesKids(r, activeKids))
    .sort((a,b)=> (b.date||"").localeCompare(a.date||"") || (b.createdAt||0)-(a.createdAt||0));

  renderGrouped(document.getElementById("weekWrap"), week);

  const counts = new Map();
  week.forEach(r => {
    if(r.same){
      counts.set(r.meal, (counts.get(r.meal)||0)+1);
    }else{
      Object.values(r.kidMeals||{}).forEach(m => counts.set(m, (counts.get(m)||0)+1));
    }
  });

  const variety = document.getElementById("varietyList");
  variety.innerHTML = "";
  const entries = [...counts.entries()].sort((a,b)=>b[1]-a[1] || a[0].localeCompare(b[0],"he"));
  if(!entries.length){
    const li = document.createElement("li");
    li.innerHTML = `<span>××™×Ÿ × ×ª×•× ×™× ×œ×’×™×•×•×Ÿ ×‘×©×‘×•×¢ ×”×–×”</span>`;
    variety.appendChild(li);
  } else {
    entries.forEach(([meal,c])=>{
      const li = document.createElement("li");
      li.innerHTML = `<span>${escapeHtml(meal)} â€” ${c} ×¤×¢××™×</span>`;
      variety.appendChild(li);
    });
  }

  renderDidYouKnow();
}

/* =========================
   Delete / clear / reset
   ========================= */
function deleteReport(id){
  if(!confirm("×œ××—×•×§ ×“×™×•×•×—?")) return;
  logs = logs.filter(r => r.id !== id);
  saveAll();
  renderAll();
}
function clearHistoryOnly(){
  if(!confirm("×œ××—×•×§ ××ª ×›×œ ×”×”×™×¡×˜×•×¨×™×”?")) return;
  logs = [];
  saveAll();
  renderAll();
}
function resetAll(){
  if(!confirm("_toggle")){} // placeholder to keep structure identical
  if(!confirm("××™×¤×•×¡ ××œ×?")) return;
  localStorage.clear();
  location.reload();
}

/* =========================
   â€œDid you know?â€
   ========================= */
function countDishUsageAllTime(){
  const counts = new Map();
  logs.forEach(r => {
    if(r.same){
      counts.set(r.meal, (counts.get(r.meal)||0)+1);
    } else {
      Object.values(r.kidMeals||{}).forEach(m => counts.set(m, (counts.get(m)||0)+1));
    }
  });
  return counts;
}
function lastUsedByDish(){
  const last = new Map();
  logs.forEach(r => {
    const t = isoDateMs(r.date) + ((Number(r.createdAt)||0) % DAY);
    if(r.same){
      const d = r.meal;
      const prev = last.get(d);
      if(prev==null || t>prev) last.set(d, t);
    } else {
      Object.values(r.kidMeals||{}).forEach(d => {
        const prev = last.get(d);
        if(prev==null || t>prev) last.set(d, t);
      });
    }
  });
  return last;
}
function fmtDate(ms){
  const d = new Date(ms);
  const yyyy=d.getFullYear();
  const mm=String(d.getMonth()+1).padStart(2,"0");
  const dd=String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}
function renderDidYouKnow(){
  const counts = countDishUsageAllTime();
  const last = lastUsedByDish();

  const cutoff = Date.now() - MONTH_30;
  const eligible = dishes.filter(d => (d.createdAt||0) <= cutoff);

  const least = [...eligible]
    .map(d => ({ dish: d.dish, c: counts.get(d.dish) || 0 }))
    .sort((a,b)=> a.c - b.c || a.dish.localeCompare(b.dish,"he"))
    .slice(0,3);

  const statsLeast = document.getElementById("statsLeast");
  statsLeast.innerHTML = "";
  if(!least.length){
    statsLeast.innerHTML = `<div class="note">×¢×“×™×™×Ÿ ××™×Ÿ ×× ×•×ª ×©×¢×‘×¨ ×¢×œ×™×”×Ÿ ×—×•×“×© ×××– ×©× ×•×¦×¨×•.</div>`;
  } else {
    least.forEach(x => {
      const row = document.createElement("div");
      row.className = "kv";
      row.innerHTML = `<b>${escapeHtml(x.dish)}</b><span>${x.c} ×¤×¢××™×</span>`;
      statsLeast.appendChild(row);
    });
  }

  const statsOldest = document.getElementById("statsOldest");
  statsOldest.innerHTML = "";
  const oldest = [...last.entries()]
    .map(([dish, t]) => ({ dish, t }))
    .sort((a,b)=> a.t - b.t)
    .slice(0,3);

  if(!oldest.length){
    statsOldest.innerHTML = `<div class="note">×¢×“×™×™×Ÿ ××™×Ÿ ×“×™×•×•×—×™× ×›×“×™ ×œ×—×©×‘ â€œ×”×›×™ ××–××Ÿâ€.</div>`;
  } else {
    oldest.forEach(x => {
      const row = document.createElement("div");
      row.className = "kv";
      row.innerHTML = `<b>${escapeHtml(x.dish)}</b><span>${fmtDate(x.t)}</span>`;
      statsOldest.appendChild(row);
    });
  }
}

/* =========================
   Recipe modal (recipe + url + types)
   ========================= */
let recipeDishName = null;

function openRecipeModal(dishName){
  recipeDishName = dishName;
  const d = getDishByName(dishName);
  if(!d) return;

  document.getElementById("recipeTitle").textContent = `ğŸ“– ××ª×›×•×Ÿ: ${dishName}`;
  document.getElementById("recipeTextInput").value = d.recipeText || "";
  document.getElementById("recipeUrlInput").value = d.recipeUrl || "";
  document.getElementById("pasteWarn").style.display = "none";

  const host = document.getElementById("recipeTypeChecks");
  host.innerHTML = "";
  TYPES.forEach(t => {
    const row = document.createElement("div");
    row.className = "checkrow";
    const checked = (d.types && d.types.length ? d.types : TYPES).includes(t);
    row.innerHTML = `<input type="checkbox" id="rt_${t}" ${checked ? "checked":""}><div style="font-weight:900;">${t}</div>`;
    host.appendChild(row);
  });

  document.getElementById("recipeBackdrop").style.display = "flex";
}
function hideRecipeModal(){
  document.getElementById("recipeBackdrop").style.display = "none";
  recipeDishName = null;
}
function closeRecipeModal(e){
  if(e.target === document.getElementById("recipeBackdrop")) hideRecipeModal();
}
async function pasteRecipe(){
  document.getElementById("pasteWarn").style.display = "none";
  try{
    if(!navigator.clipboard || !navigator.clipboard.readText){ document.getElementById("pasteWarn").style.display="block"; return; }
    const txt = await navigator.clipboard.readText();
    if(txt) document.getElementById("recipeTextInput").value = txt;
  }catch{ document.getElementById("pasteWarn").style.display="block"; }
}
async function pasteUrl(){
  document.getElementById("pasteWarn").style.display = "none";
  try{
    if(!navigator.clipboard || !navigator.clipboard.readText){ document.getElementById("pasteWarn").style.display="block"; return; }
    const txt = await navigator.clipboard.readText();
    if(txt) document.getElementById("recipeUrlInput").value = txt.trim();
  }catch{ document.getElementById("pasteWarn").style.display="block"; }
}
function openRecipeLink(){
  const url = (document.getElementById("recipeUrlInput").value || "").trim();
  if(!url) return alert("××™×Ÿ ×§×™×©×•×¨ ×œ×¤×ª×™×—×”");
  try{ window.open(new URL(url).toString(), "_blank"); }
  catch{ alert("×”×§×™×©×•×¨ ×œ× ×ª×§×™×Ÿ"); }
}
function saveRecipe(){
  if(!recipeDishName) return;
  const text = document.getElementById("recipeTextInput").value || "";
  const url = (document.getElementById("recipeUrlInput").value || "").trim();

  const selected = TYPES.filter(t => document.getElementById("rt_"+t)?.checked);
  const types = selected.length ? selected : [...TYPES];

  dishes = dishes.map(d => d.dish === recipeDishName ? ({...d, recipeText:text, recipeUrl:url, types}) : d);

  saveAll();
  hideRecipeModal();
  renderAll();
}

/* =========================
   Edit report modal
   ========================= */
let editId = null;

function fillSelectWithDishes(sel, type){
  const names = getDishesForType(type);
  sel.innerHTML = "";
  names.forEach(n => {
    const o = document.createElement("option");
    o.value = n; o.textContent = n;
    sel.appendChild(o);
  });
}

function openEditModal(id){
  const r = logs.find(x => x.id === id);
  if(!r) return;
  editId = id;

  document.getElementById("editDate").value = r.date || "";
  document.getElementById("editType").value = r.type || "×¢×¨×‘";
  document.getElementById("editSame").checked = !!r.same;

  buildEditKidsUI();
  fillSelectWithDishes(document.getElementById("editMealSelect"), document.getElementById("editType").value);

  toggleEditMode();

  if(r.same){
    document.getElementById("editMealSelect").value = r.meal || "";
    const set = new Set(r.kids || []);
    kids.forEach(k => {
      const cb = document.getElementById("edit_cb_"+cssSafe(k));
      if(cb) cb.checked = set.has(k);
    });
  } else {
    const km = r.kidMeals || {};
    kids.forEach(k => {
      const use = document.getElementById("edit_use_"+cssSafe(k));
      const sel = document.getElementById("edit_sel_"+cssSafe(k));
      if(!use || !sel) return;
      if(km[k]){
        use.checked = true;
        sel.disabled = false;
        sel.value = km[k];
      } else {
        use.checked = false;
        sel.disabled = true;
      }
    });
  }

  document.getElementById("editBackdrop").style.display = "flex";
}

function buildEditKidsUI(){
  const checks = document.getElementById("editKidsChecks");
  checks.innerHTML = "";
  kids.forEach(k => {
    const row = document.createElement("div");
    row.className = "checkrow";
    row.innerHTML = `<input type="checkbox" id="edit_cb_${cssSafe(k)}" checked><div style="font-weight:900;">${escapeHtml(k)}</div>`;
    checks.appendChild(row);
  });

  const split = document.getElementById("editSplitKids");
  split.innerHTML = "";
  kids.forEach(k => {
    const row = document.createElement("div");
    row.className = "checkrow";
    row.innerHTML = `
      <input type="checkbox" id="edit_use_${cssSafe(k)}">
      <div style="font-weight:900; min-width:90px;">${escapeHtml(k)}</div>
      <select id="edit_sel_${cssSafe(k)}"></select>
    `;
    const sel = row.querySelector("select");
    fillSelectWithDishes(sel, document.getElementById("editType").value);
    sel.disabled = true;

    const use = row.querySelector("input");
    use.addEventListener("change", ()=>{ sel.disabled = !use.checked; });
    split.appendChild(row);
  });
}

function toggleEditMode(){
  const same = document.getElementById("editSame").checked;
  document.getElementById("editSameMode").style.display = same ? "block" : "none";
  document.getElementById("editSplitMode").style.display = same ? "none" : "block";
}

document.getElementById("editType").addEventListener("change", ()=>{
  fillSelectWithDishes(document.getElementById("editMealSelect"), document.getElementById("editType").value);
  kids.forEach(k => {
    const sel = document.getElementById("edit_sel_"+cssSafe(k));
    if(sel) fillSelectWithDishes(sel, document.getElementById("editType").value);
  });
});

function saveEditedReport(){
  if(!editId) return;
  const idx = logs.findIndex(x => x.id === editId);
  if(idx === -1) return;

  const date = document.getElementById("editDate").value;
  const type = document.getElementById("editType").value;
  if(!date) return alert("×‘×—×¨ ×ª××¨×™×š");

  const updated = {...logs[idx], date, type};

  if(document.getElementById("editSame").checked){
    const meal = document.getElementById("editMealSelect").value;
    const selectedKids = kids.filter(k => document.getElementById("edit_cb_"+cssSafe(k))?.checked);
    if(!meal) return alert("×‘×—×¨ ×× ×”");
    if(!selectedKids.length) return alert("×¡××Ÿ ×œ×¤×—×•×ª ×™×œ×“/×” ××—×“/×ª");
    updated.same = true;
    updated.meal = meal;
    updated.kids = selectedKids;
    delete updated.kidMeals;
  } else {
    const km = {};
    let any = false;
    kids.forEach(k => {
      const use = document.getElementById("edit_use_"+cssSafe(k));
      const sel = document.getElementById("edit_sel_"+cssSafe(k));
      if(use && use.checked){
        any = true;
        km[k] = sel.value;
      }
    });
    if(!any) return alert("×‘××¦×‘ ××¤×•×¦×œ ×—×™×™×‘ ×œ×‘×—×•×¨ ×œ×¤×—×•×ª ×™×œ×“ ××—×“");
    updated.same = false;
    updated.kidMeals = km;
    delete updated.meal;
    delete updated.kids;
  }

  logs[idx] = updated;
  saveAll();
  hideEditModal();
  renderAll();
}

function hideEditModal(){
  document.getElementById("editBackdrop").style.display = "none";
  editId = null;
}
function closeEditModal(e){
  if(e.target === document.getElementById("editBackdrop")) hideEditModal();
}

/* =========================
   Utilities
   ========================= */
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, (m)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}
function cssSafe(s){
  return String(s).replace(/[^a-zA-Z0-9_\u0590-\u05FF]/g, "_");
}

/* =========================
   Render all
   ========================= */
function renderAll(){
  renderKids();
  renderDishes();
  renderLogSelectors();
  toggleMode();
  renderData();
}

/* =========================
   Init (××ª×•×§×Ÿ: ×œ× ×“×¨×™×¡×”!)
   ========================= */
document.getElementById("dateInput").value = todayISO();
document.getElementById("weekEndDate").value = todayISO();

renderAll();
syncLoad(); // ××•×©×š ××”×¢× ×Ÿ ×¨×§ ×× ×œ× Yanir ×¢× ×“××˜×
</script>
</body>
</html>
