<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>××¨×•×—×•×ª ×”×™×œ×“×™×</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#2563eb">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --border:#e5e7eb;
      --primary:#2563eb; --danger:#dc2626; --muted:#6b7280;
      --shadow:0 6px 18px rgba(0,0,0,0.06);
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:14px;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:#111827; line-height:1.35;
    }
    h1{margin:6px 0 14px;font-size:24px;font-weight:900}
    h2{margin:0 0 10px;font-size:18px}
    h3{margin:14px 0 6px;font-size:14px;color:var(--muted)}
    .card{
      background:var(--card); border:1px solid var(--border);
      border-radius:var(--radius); box-shadow:var(--shadow);
      padding:14px; margin-bottom:14px;
    }

    .spacer{margin-bottom:14px}
    .field{margin-top:10px}

    input,select{
      width:100%; padding:10px 12px; font-size:16px;
      border-radius:10px; border:1px solid var(--border);
      background:#fff;
    }

    /* ×©×•×¨×”: ××™× ×¤×•×˜ + ×›×¤×ª×•×¨ ×‘××•×ª×” ×©×•×¨×” */
    .inline{
      display:flex; gap:10px; align-items:center; flex-wrap:nowrap;
    }
    .inline input{flex:1}
    .inline button{flex:0 0 auto}

    .btn{
      padding:10px 14px; border-radius:10px; border:none;
      font-weight:800; cursor:pointer; white-space:nowrap;
    }
    .primary{background:var(--primary); color:#fff}
    .danger{background:var(--danger); color:#fff}
    .ghost{background:#eef2ff; color:#1e40af}

    .iconbtn{
      background:#f3f4f6; color:#111827;
      padding:8px 10px; border-radius:10px; border:1px solid var(--border);
      font-weight:800;
      line-height:1;
    }
    .iconbtn.dangerish{
      background:#f3f4f6; color:#111827; border:1px solid var(--border);
    }

    /* ×¨×©×™××•×ª ×¨×’×™×œ×•×ª (×œ××©×œ ×× ×•×ª + ×©×‘×•×¢) */
    ul{list-style:none;padding:0;margin:10px 0 0}
    li{
      display:flex; justify-content:space-between; gap:10px;
      background:#fff; border:1px solid var(--border);
      border-radius:12px; padding:10px; margin-bottom:8px;
      align-items:center;
    }
    li span{flex:1}
    .btn-group{display:flex; gap:8px; align-items:center}

    /* âœ… ××‘× ×”: ××¡×’×¨×ª ×œ×˜×§×¡×˜ + ×›×¤×ª×•×¨ ×—×™×¦×•× ×™ (×¨×§ ×œ×™×œ×“×™×/×”×™×¡×˜×•×¨×™×”) */
    .listrow{
      display:flex;
      gap:10px;
      align-items:stretch;
      margin-bottom:8px;
    }
    .box{
      flex:1;
      background:#fff;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
      display:flex;
      align-items:center;
      min-height:44px;
    }
    .btncol{
      flex:0 0 auto;
      display:flex;
      align-items:stretch;
    }
    .btncol .btn{
      height:100%;
    }

    /* ×¦'×§×‘×•×§×¡×™× ××™×•×©×¨×™× ×™×¤×” */
    .checks{
      display:flex; flex-direction:column; gap:10px; margin-top:8px;
    }
    .checkrow{
      display:flex; align-items:center; gap:10px;
      padding:10px; border:1px solid var(--border);
      border-radius:12px; background:#fff;
    }
    .checkrow input{width:18px; height:18px; margin:0}
    .note{font-size:13px;color:var(--muted);margin-top:6px}

    @media(min-width:700px){
      body{max-width:820px;margin:auto}
    }
  </style>
</head>

<body>
<h1>ğŸ½ï¸ ××¨×•×—×•×ª ×”×™×œ×“×™×</h1>

<div class="spacer">
  <button class="btn danger" type="button" onclick="resetData()">××™×¤×•×¡ × ×ª×•× ×™×</button>
</div>

<!-- ×™×œ×“×™× -->
<section class="card">
  <h2>× ×™×”×•×œ ×™×œ×“×™×</h2>
  <div class="inline">
    <input id="newKidInput" placeholder="×©× ×™×œ×“/×”">
    <button class="btn primary" type="button" onclick="addKid()">×”×•×¡×£</button>
  </div>
  <ul id="kidsList"></ul>
</section>

<!-- ×× ×•×ª -->
<section class="card">
  <h2>× ×™×”×•×œ ×× ×•×ª</h2>
  <div class="inline">
    <input id="newMealInput" placeholder="×©× ×× ×”">
    <button class="btn primary" type="button" onclick="addMeal()">×”×•×¡×£</button>
  </div>
  <div class="note">××—×™×§×” ×›××Ÿ ××¡×™×¨×” ××”×××’×¨ ×‘×œ×‘×“ (×œ× ××•×—×§×ª ×”×™×¡×˜×•×¨×™×”).</div>
  <ul id="mealsOptionsList"></ul>
</section>

<!-- ×¨×™×©×•× -->
<section class="card">
  <h2>×¨×™×©×•× ××¨×•×—×”</h2>

  <div class="field">
    <label>×ª××¨×™×š</label>
    <input type="date" id="dateInput">
  </div>

  <div class="field">
    <label>×¡×•×’ ××¨×•×—×”</label>
    <select id="mealType">
      <option value="×‘×•×§×¨">×‘×•×§×¨</option>
      <option value="×¦×”×¨×™×™×">×¦×”×¨×™×™×</option>
      <option value="×¢×¨×‘" selected>×¢×¨×‘</option>
      <option value="×‘×™× ×™×™×">×‘×™× ×™×™×</option>
    </select>
  </div>

  <div class="field checkrow" style="justify-content:space-between;">
    <div style="display:flex;align-items:center;gap:10px;">
      <input type="checkbox" id="sameForAll" checked onchange="toggleMode()">
      <strong>××•×ª×” ××¨×•×—×” ×œ×›×•×œ×</strong>
    </div>
  </div>

  <!-- ××¦×‘ ××©×•×ª×£ -->
  <div id="sameMode">
    <div class="field">
      <label>×× ×”</label>
      <div class="inline">
        <select id="mealSelect"></select>
        <button class="btn ghost" type="button" onclick="suggestMeal()">×ª×Ÿ ×œ×™ ×¨×¢×™×•×Ÿ</button>
      </div>
    </div>

    <h3>××™ ××›×œ?</h3>
    <div id="sameKids" class="checks"></div>
  </div>

  <!-- ××¦×‘ ×¤×™×¦×•×œ -->
  <div id="splitMode" style="display:none;">
    <h3>×‘×—×™×¨×” × ×¤×¨×“×ª ×œ×›×œ ×™×œ×“</h3>
    <div id="splitKids" class="checks"></div>
  </div>

  <div class="field">
    <button class="btn primary" type="button" onclick="saveMeal()">×©××™×¨×”</button>
  </div>
</section>

<!-- ×”×™×¡×˜×•×¨×™×” -->
<section class="card">
  <h2>×”×™×¡×˜×•×¨×™×”</h2>
  <ul id="mealList"></ul>
</section>

<!-- ×©×‘×•×¢ + ×’×™×•×•×Ÿ -->
<section class="card">
  <h2>×©×‘×•×¢ ××—×¨×•×Ÿ</h2>
  <input type="date" id="weekEndDate">
  <ul id="weekList"></ul>

  <h3>×’×™×•×•×Ÿ</h3>
  <ul id="varietyList"></ul>
</section>

<script>
  // ===== DATA =====
  const KM="meals", KK="kids", KO="mealOptions";
  let meals = JSON.parse(localStorage.getItem(KM)) || [];
  let kids = JSON.parse(localStorage.getItem(KK)) || ["××™×§×”","×¢×•××¨"];
  let mealOptions = JSON.parse(localStorage.getItem(KO)) || [];

  const save = () => {
    localStorage.setItem(KM, JSON.stringify(meals));
    localStorage.setItem(KK, JSON.stringify(kids));
    localStorage.setItem(KO, JSON.stringify(mealOptions));
  };

  const uid = () => "m_" + Math.random().toString(16).slice(2) + "_" + Date.now();

  // ===== HELPERS =====
  const iso = (d) => new Date(d + "T00:00:00");
  const addDays = (d, n) => {
    const x = iso(d);
    x.setDate(x.getDate() + n);
    return x.toISOString().slice(0,10);
  };

  function resetData(){
    if(!confirm("××™×¤×•×¡ ××•×—×œ×˜?")) return;
    localStorage.clear();
    location.reload();
  }

  // ===== KIDS =====
  function addKid(){
    const v = (newKidInput.value || "").trim();
    if(!v) return;
    if(kids.includes(v)) return alert("×”×™×œ×“/×” ×›×‘×¨ ×§×™×™×/×ª");
    kids.push(v);
    newKidInput.value = "";
    save(); renderAll();
  }

  function removeKid(k){
    if(!confirm(`×œ××—×•×§ ××ª "${k}"?`)) return;
    kids = kids.filter(x => x !== k);

    meals = meals.map(m => {
      if(m.split){
        const km = {...(m.kidMeals||{})};
        delete km[k];
        return {...m, kidMeals: km};
      } else {
        return {...m, kids: (m.kids||[]).filter(x => x !== k)};
      }
    }).filter(m => {
      if(m.split) return Object.keys(m.kidMeals||{}).length > 0;
      return (m.kids||[]).length > 0;
    });

    save(); renderAll();
  }

  // ===== MEAL OPTIONS =====
  function addMeal(){
    const v = (newMealInput.value || "").trim();
    if(!v) return;
    if(mealOptions.includes(v)) return alert("×”×× ×” ×›×‘×¨ ×§×™×™××ª");
    mealOptions.push(v);
    newMealInput.value = "";
    save(); renderAll();
  }

  function editMeal(oldName){
    const next = (prompt("×©× ×—×“×©:", oldName) || "").trim();
    if(!next) return;
    if(next === oldName) return;
    if(mealOptions.includes(next)) return alert("×›×‘×¨ ×§×™×™××ª ×× ×” ×‘×©× ×”×–×”");

    mealOptions = mealOptions.map(m => (m === oldName ? next : m));

    meals = meals.map(m => {
      if(m.split){
        const km = {...(m.kidMeals||{})};
        Object.keys(km).forEach(k => { if(km[k] === oldName) km[k] = next; });
        return {...m, kidMeals: km};
      } else {
        return (m.meal === oldName) ? {...m, meal: next} : m;
      }
    });

    save(); renderAll();
  }

  function deleteMealOption(name){
    if(!confirm(`×œ××—×•×§ ××ª "${name}" ××”×××’×¨ ×‘×œ×‘×“?`)) return;
    mealOptions = mealOptions.filter(m => m !== name);
    save(); renderAll();
  }

  // ===== UI MODE =====
  function toggleMode(){
    const same = sameForAll.checked;
    sameMode.style.display = same ? "block" : "none";
    splitMode.style.display = same ? "none" : "block";
  }

  // ===== SAVE MEAL =====
  function saveMeal(){
    const date = dateInput.value;
    const type = mealType.value;

    if(!date) return alert("×‘×—×¨ ×ª××¨×™×š");
    if(!mealOptions.length) return alert("×”×××’×¨ ×¨×™×§ â€” ×”×•×¡×£ ×× ×” ×§×•×“×");
    if(!kids.length) return alert("××™×Ÿ ×™×œ×“×™× â€” ×”×•×¡×£ ×™×œ×“/×” ×§×•×“×");

    if(sameForAll.checked){
      const meal = mealSelect.value;
      const selectedKids = kids.filter(k => document.getElementById("cb_"+k)?.checked);
      if(!meal) return alert("×‘×—×¨ ×× ×”");
      if(!selectedKids.length) return alert("×¡××Ÿ ×œ×¤×—×•×ª ×™×œ×“/×” ××—×“/×ª");

      meals.push({id: uid(), date, type, meal, kids: selectedKids});
    } else {
      const kidMeals = {};
      for(const k of kids){
        const sel = document.getElementById("sel_"+k);
        const val = sel ? sel.value : "";
        if(!val) return alert(`×‘×—×¨ ×× ×” ×¢×‘×•×¨ ${k}`);
        kidMeals[k] = val;
      }
      meals.push({id: uid(), date, type, split: true, kidMeals});
    }

    save(); renderAll();
  }

  function deleteReport(id){
    if(!confirm("×œ××—×•×§ ×“×™×•×•×—?")) return;
    meals = meals.filter(m => m.id !== id);
    save(); renderAll();
  }

  // ===== SUGGEST =====
  function suggestMeal(){
    if(!mealOptions.length) return;

    const end = weekEndDate.value || dateInput.value;
    const start = addDays(end, -6);
    const week = meals.filter(m => m.date >= start && m.date <= end);

    const counts = new Map();
    week.forEach(m => {
      if(m.split){
        Object.values(m.kidMeals||{}).forEach(v => counts.set(v, (counts.get(v)||0)+1));
      } else {
        counts.set(m.meal, (counts.get(m.meal)||0)+1);
      }
    });

    let min = Infinity;
    mealOptions.forEach(opt => { min = Math.min(min, counts.get(opt)||0); });
    const candidates = mealOptions.filter(opt => (counts.get(opt)||0) === min);
    const pick = candidates[Math.floor(Math.random()*candidates.length)];
    mealSelect.value = pick;
  }

  // ===== RENDER =====
  function renderKids(){
    kidsList.innerHTML = "";
    kids.forEach(k => {
      const row = document.createElement("div");
      row.className = "listrow";
      row.innerHTML = `
        <div class="box">${k}</div>
        <div class="btncol"><button class="btn danger" type="button">××—×§</button></div>
      `;
      row.querySelector("button").onclick = () => removeKid(k);
      kidsList.appendChild(row);
    });
  }

  // âœ… × ×©××¨ "li" ×¨×’×™×œ ×¢× ××¡×’×¨×ª + ×›×¤×ª×•×¨×™× ×‘×©×•×¨×” (×›××• ×©×”×™×” ×˜×•×‘)
  function renderMealOptionsManager(){
    mealsOptionsList.innerHTML = "";
    const sorted = [...mealOptions].sort((a,b)=>a.localeCompare(b,"he"));

    sorted.forEach(m => {
      const li = document.createElement("li");
      li.innerHTML = `
        <span>${m}</span>
        <div class="btn-group">
          <button class="iconbtn" type="button" title="×¢×¨×•×š">âœï¸</button>
          <button class="iconbtn dangerish" type="button" title="××—×§">âŒ</button>
        </div>
      `;
      const [editBtn, delBtn] = li.querySelectorAll("button");
      editBtn.onclick = () => editMeal(m);
      delBtn.onclick = () => deleteMealOption(m);
      mealsOptionsList.appendChild(li);
    });
  }

  function renderSelectorsAndChecks(){
    mealSelect.innerHTML = "";
    mealOptions.forEach(m => {
      const opt = document.createElement("option");
      opt.value = m; opt.textContent = m;
      mealSelect.appendChild(opt);
    });

    sameKids.innerHTML = "";
    kids.forEach(k => {
      const row = document.createElement("div");
      row.className = "checkrow";
      row.innerHTML = `
        <input type="checkbox" id="cb_${k}" checked>
        <div style="font-weight:800;">${k}</div>
      `;
      sameKids.appendChild(row);
    });

    splitKids.innerHTML = "";
    kids.forEach(k => {
      const row = document.createElement("div");
      row.className = "checkrow";
      row.innerHTML = `
        <div style="font-weight:900; min-width:80px;">${k}</div>
        <select id="sel_${k}"></select>
      `;
      const sel = row.querySelector("select");
      mealOptions.forEach(m => {
        const opt = document.createElement("option");
        opt.value = m; opt.textContent = m;
        sel.appendChild(opt);
      });
      splitKids.appendChild(row);
    });
  }

  // âœ… ×”×™×¡×˜×•×¨×™×”: ××¡×’×¨×ª ×œ×˜×§×¡×˜ + ×›×¤×ª×•×¨ ××—×™×§×” ×—×™×¦×•× ×™
  function renderHistory(){
    mealList.innerHTML = "";

    meals.forEach(m => {
      let text = "";
      if(m.split){
        const parts = Object.entries(m.kidMeals||{}).map(([k,v])=>`${k}: ${v}`).join(" | ");
        text = `${m.date} | ${m.type} | ${parts}`;
      } else {
        text = `${m.date} | ${m.type} | ${m.meal} | ${(m.kids||[]).join(", ")}`;
      }

      const row = document.createElement("div");
      row.className = "listrow";
      row.innerHTML = `
        <div class="box">${text}</div>
        <div class="btncol"><button class="btn danger" type="button">××—×§</button></div>
      `;
      row.querySelector("button").onclick = () => deleteReport(m.id);
      mealList.appendChild(row);
    });
  }

  function renderWeekAndVariety(){
    const end = weekEndDate.value || dateInput.value;
    const start = addDays(end, -6);
    const week = meals
      .filter(m => m.date >= start && m.date <= end)
      .sort((a,b)=>a.date.localeCompare(b.date));

    weekList.innerHTML = "";
    if(!week.length){
      const li = document.createElement("li");
      li.innerHTML = `<span>××™×Ÿ ×¨×™×©×•××™× ×‘×©×‘×•×¢ ×”×–×”</span>`;
      weekList.appendChild(li);
    } else {
      week.forEach(m => {
        const li = document.createElement("li");
        let text = "";
        if(m.split){
          text = `${m.date} | ${m.type} | ` + Object.entries(m.kidMeals||{}).map(([k,v])=>`${k}: ${v}`).join(" | ");
        } else {
          text = `${m.date} | ${m.type} | ${m.meal} | ${(m.kids||[]).join(", ")}`;
        }
        li.innerHTML = `<span>${text}</span>`;
        weekList.appendChild(li);
      });
    }

    const counts = new Map();
    week.forEach(m => {
      if(m.split){
        Object.values(m.kidMeals||{}).forEach(v => counts.set(v, (counts.get(v)||0)+1));
      } else {
        counts.set(m.meal, (counts.get(m.meal)||0)+1);
      }
    });

    varietyList.innerHTML = "";
    const entries = [...counts.entries()].sort((a,b)=>b[1]-a[1] || a[0].localeCompare(b[0],"he"));
    if(!entries.length){
      const li = document.createElement("li");
      li.innerHTML = `<span>××™×Ÿ × ×ª×•× ×™× ×œ×’×™×•×•×Ÿ ×‘×©×‘×•×¢ ×”×–×”</span>`;
      varietyList.appendChild(li);
    } else {
      entries.forEach(([meal,c]) => {
        const li = document.createElement("li");
        li.innerHTML = `<span>${meal} â€” ${c} ×¤×¢××™×</span>`;
        varietyList.appendChild(li);
      });
    }
  }

  function renderAll(){
    renderKids();
    renderMealOptionsManager();
    renderSelectorsAndChecks();
    toggleMode();
    renderHistory();
    renderWeekAndVariety();
  }

  // ===== INIT =====
  const today = new Date().toISOString().slice(0,10);
  dateInput.value = today;
  weekEndDate.value = today;

  weekEndDate.addEventListener("change", renderAll);

  save();
  renderAll();
</script>

</body>
</html>
